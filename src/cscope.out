cscope 15 $HOME/Projects/gmyqq/src -q 0000001330 0000195836
	@buddy.c

14 
	~<time.h
>

15 
	~<¡dlib.h
>

16 
	~<¡ršg.h
>

17 #ifdeà
__WIN32__


18 
	~<wšsock.h
>

19 
	~<wšš‘.h
>

21 
	~<sys/sock‘.h
>

22 
	~<¬·/š‘.h
>

24 
	~"qqş›Á.h
"

25 
	~"memÜy.h
"

26 
	~"debug.h
"

27 
	~"´ÙocŞ.h
"

28 
	~"li¡.h
"

29 
	~"buddy.h
"

30 
	~"·ck‘mgr.h
"

34 
	$buddy_comp
(cÚ¡ *
p
, cÚ¡ *
q
)

36  ( (*(
qqbuddy
 **)
p
)->
numb”
 - (*(qqbuddy **)
q
)->number );

37 
	}
}

39 
	$£¬ch”
ĞcÚ¡ * 
p
, cÚ¡ * 
v
 )

41  ( ((
qqbuddy
*)
p
)->
numb”
 =ğ()
v
 );

42 
	}
}

44 
qqbuddy
* 
	$buddy_g‘
Ğ
qqş›Á
* 
qq
, 
ušt
 
numb”
, 
ü—‹
 )

46 ifĞ!
numb”
 )

47  
NULL
;

48 
qqbuddy
* 
b
;

49 
b
 = (
qqbuddy
 *)
	`li¡_£¬ch
Ğ&
qq
->
buddy_li¡
, (*)
numb”
, 
£¬ch”
 );

51 ifĞ
b
==
NULL
 && 
ü—‹
 ){

52 
	`NEW
Ğ
b
, Ğ
qqbuddy
 ) ,qqbuddy);

53 ifĞ!
b
 )  b;

54 
b
->
numb”
 =‚umber;

55 
	`¥rštf
Ğ
b
->
nickÇme
, "%u", 
numb”
 );

56 ifĞ
	`li¡_­³nd
Ğ&
qq
->
buddy_li¡
, (*)
b
 )<0 ){

57 
	`DEL
Ğ
b
 );

60  
b
;

61 
	}
}

63 
	$buddy_»move
Ğ
qqş›Á
* 
qq
, 
ušt
 
numb”
 )

65 
qqbuddy
* 
b
;

66 
b
 =(
qqbuddy
 *è
	`li¡_£¬ch
Ğ&
qq
->
buddy_li¡
, (*)
numb”
, 
£¬ch”
 );

67 ifĞ
b
 ){

68 
	`li¡_»move
Ğ&
qq
->
buddy_li¡
, 
b
 );

70 
	}
}

72 
	$buddy_sÜt_li¡
Ğ
qqş›Á
* 
qq
 )

74 
	`li¡_sÜt
Ğ&
qq
->
buddy_li¡
, 
buddy_comp
 );

75 
	}
}

77 
	$buddyoff_£¬ch”
ĞcÚ¡ * 
p
, cÚ¡ * 
v
 )

79 ((
qqbuddy
*)
p
)->
¡©us
 = 
QQ_OFFLINE
;

81 
	}
}

82 
	$buddy_£t_®l_off
Ğ
qqş›Á
* 
qq
 )

84 
	`li¡_£¬ch
Ğ&
qq
->
buddy_li¡
, 
NULL
, 
buddyoff_£¬ch”
 );

85 
	}
}

87 
	$buddy_upd©e_li¡
Ğ
qqş›Á
* 
qq
 )

89 
	`´Ù_buddy_upd©e_li¡
Ğ
qq
, 0 );

90 
	`´Ù_buddy_upd©e_Úlše
Ğ
qq
, 0 );

91 
	}
}

93 
	$buddy_upd©e_šfo
Ğ
qqş›Á
* 
qq
, 
qqbuddy
* 
b
 )

95 
	`´Ù_u£r_g‘_šfo
Ğ
qq
, 
b
->
numb”
 );

96 
	}
}

99 
	$buddy_£nd_mes§ge
Ğ
qqş›Á
* 
qq
, 
ušt
 
numb”
, * 
msg
 )

101 
	`´Ù_im_£nd_msg
Ğ
qq
, 
numb”
, 
msg
 );

103 
	}
}

105 * 
	$buddy_¡©us_¡ršg
Ğ
¡
 )

107  
¡
 ){

108 
QQ_ONLINE
:

110 
QQ_OFFLINE
:

112 
QQ_AWAY
:

114 
QQ_HIDDEN
:

116 
QQ_BUSY
:

118 
QQ_KILLME
:

120 
QQ_QUIET
:

125 
	}
}

129 
	$buddy_put_ev’t
Ğ
qqş›Á
* 
qq
 )

131 *
‹mp
;

132 
i
;

133 
qqbuddy
* 
b
;

134 
	`NEW
Ğ
‹mp
, 
	`KB
(128) ,);

135 ifĞ!
‹mp
 ) ;

136 
	`¡rıy
Ğ
‹mp
, "buddylist^$" );

137 
	`±h»ad_mu‹x_lock
Ğ&
qq
->
buddy_li¡
.
mu‹x
 );

138 
š_addr
 
addr
;

139  
i
=0; i<
qq
->
buddy_li¡
.
couÁ
; i++ ){

140 
b
 = (
qqbuddy
*)
qq
->
buddy_li¡
.
™ems
[
i
];

141 
addr
.
s_addr
 = 
	`htÚl
Ğ
b
->

 );

142 
	`¥rštf
Ğ
‹mp
, "%s%u\t%s\t%s\t%s\t%d\t%s\t%s\t%d^@",emp, 
b
->
numb”
, 
	`buddy_¡©us_¡ršg
(b->
¡©us
), b->
nickÇme
,

143 
b
->
sign™u»
, b->
£x
, 
	`š‘_Áß
Ğ
addr
 ), b->
®Ÿs
, b->
gid
 );

145 
	`±h»ad_mu‹x_uÆock
Ğ&
qq
->
buddy_li¡
.
mu‹x
 );

146 
	`qqş›Á_put_ev’t
Ğ
qq
, 
‹mp
 );

147 
	`DEL
Ğ
‹mp
 );

148 
	}
}

	@buddy.h

1 #iâdeà
_BUDDY_H


2 
	#_BUDDY_H


	)

4 
	~"qqdef.h
"

6 
	sqqbuddy
{

7 
ušt
 
	mnumb”
;

8 
	mnickÇme
[
NICKNAME_LEN
];

9 
ušt
 
	m
;

10 
ushÜt
 
	mpÜt
;

11 
ushÜt
 
	mçû
;

12 
uch¬
 
	mage
;

13 
uch¬
 
	m£x
;

14 
uch¬
 
	mgid
;

15 
uch¬
 
	mqqshow
;

16 
uch¬
 
	mæag
;

17 
uch¬
 
	m£ssiÚ_key
[16];

18 
uch¬
 
	m¡©us
;

19 
ushÜt
 
	mv”siÚ
;

20 
uch¬
 
	mv”ify_æag
;

22 
ušt
 
	msign_time
;

23 
uch¬
 
	maccouÁ_æag
;

24 #iâdeà
NO_BUDDY_DETAIL_INFO


25 
	msign™u»
[
SIGNITURE_LEN
];

26 
	maccouÁ
[
ACCOUNT_LEN
];

27 
	m®Ÿs
[
ALIAS_LEN
];

28 
	mšfo_¡ršg
[
MAX_USER_INFO
][
USER_INFO_LEN
];

30 
	msign™u»
[1];

31 
	maccouÁ
[1];

32 
	m®Ÿs
[1];

33 
	mšfo_¡ršg
[1][1];

36 }
	tqqbuddy
;

38 
	gqqş›Á
;

39 
qqbuddy
* 
buddy_g‘
Ğ
qqş›Á
* 
qq
, 
ušt
 
numb”
, 
ü—‹
 );

40 
buddy_»move
Ğ
qqş›Á
* 
qq
, 
ušt
 
numb”
 );

41 
buddy_upd©e_li¡
Ğ
qqş›Á
* 
qq
 );

42 
buddy_upd©e_šfo
Ğ
qqş›Á
* 
qq
, 
qqbuddy
* 
b
 );

43 
buddy_sÜt_li¡
Ğ
qqş›Á
* 
qq
 );

44 
buddy_£nd_mes§ge
Ğ
qqş›Á
* 
qq
, 
ušt
 
numb”
, * 
msg
 );

45 
buddy_£t_®l_off
Ğ
qqş›Á
* 
qq
 );

46 
buddy_put_ev’t
Ğ
qqş›Á
* 
qq
 );

47 * 
buddy_¡©us_¡ršg
Ğ
¡
 );

	@config.c

15 
	~<¡dio.h
>

16 
	~<¡ršg.h
>

17 
	~<¡dlib.h
>

19 
	~"debug.h
"

20 
	~"qqdef.h
"

21 
	~"memÜy.h
"

22 
	~"cÚfig.h
"

24 #iâdeà
__WIN32__


25 
	#¡ricmp
 
¡rÿ£cmp


	)

28 
cÚfig_™em
 
	t™em
;

30 
	ePARSING
{

31 
	mNAME
,

32 
	mVALUE


35 
	$add
Ğ
cÚfig
* 
c
, * 
Çme
, * 
v®ue
 )

37 ifĞ
c
->
™em_couÁ
 >= 1024 ){

38 
	`DBG
("failedo‡dd config item:oo many.");

41 
i
 = 
c
->
™em_couÁ
 ++;

42 
c
->
™ems
[
i
] = (
cÚfig_™em
*)
	`m®loc
( (config_item) );

43 
	`¡ºıy
Ğ
c
->
™ems
[
i
]->
Çme
,‚ame, 
CONFIG_NAME_LEN
 );

44 
	`¡ºıy
Ğ
c
->
™ems
[
i
]->
v®ue
, v®ue, 
CONFIG_VALUE_LEN
 );

46 
	}
}

48 
	$·r£
Ğ
cÚfig
*
cÚf
, * 
buf
, 
Ën
 )

50 
PARSING
 
¡©e
;

51 
¡©e
 = 
NAME
;

52 
i
, 
j
;

53 
c
;

54 
Çme
[
CONFIG_NAME_LEN
], 
v®ue
[
CONFIG_VALUE_LEN
];

55 
i
 = 
j
 = 0;

56 
buf
[
Ën
] = '\0';

57  
i
 <ğ
Ën
 ){

58 
c
 = 
buf
[
i
];

59  
¡©e
 ){

60 
NAME
:

61 ifĞ
c
 == '\r' ){

63 }ifĞ
c
 == '\n' ){

64 
j
 = 0;

65 }ifĞ
c
 == '=' ){

66 
¡©e
 = 
VALUE
;

67  
j
>0 && 
Çme
[j-1] == ' ' )

68 
j
--;

69 
Çme
[
j
] = '\0';

70 
j
 = 0;

71 }ifĞ
c
 == '\\' ){

72 
i
 ++;

74 ifĞ
j
==0 && 
c
 == ' ' )

76 
Çme
[
j
++] = 
c
;

79 
VALUE
:

80 ifĞ
c
 == '\r' ){

82 }ifĞ
c
 == '\n' || c == '\0' ){

83 
¡©e
 = 
NAME
;

84  
j
>0 && 
v®ue
[j-1] == ' ' )

85 
j
--;

86 
v®ue
[
j
] = '\0';

87 ifĞ
Çme
[0] != '#' ){

88 
	`add
Ğ
cÚf
, 
Çme
, 
v®ue
 );

90 
j
 = 0;

91 }ifĞ
c
 == '\\' ){

92 
i
 ++;

94 ifĞ
j
==0 && 
c
 == ' ' )

96 
v®ue
[
j
++] = 
c
;

102 
i
 ++;

104 
	}
}

106 
	gdeçuÉ_cÚfigs
[]="### Default Configuration ###\n"

124 
	$cÚfig_İ’
Ğ
cÚfig
* 
c
, * 
f’ame
 )

126 
FILE
* 
å
;

127 
å
 = 
	`fİ’
 ( 
f’ame
, "r" );

128 ifĞ
å
 =ğ
NULL
 ){

129 
	`DBG
("çedØİ’ f%s", 
f’ame
 );

130 
å
 = 
	`fİ’
Ğ
f’ame
, "w" );

131 ifĞ
å
 =ğ
NULL
 )

133 
	`åuts
Ğ
deçuÉ_cÚfigs
, 
å
 );

134 
	`fşo£
Ğ
å
 );

135 
å
 = 
	`fİ’
Ğ
f’ame
, "r" );

136 ifĞ
å
 =ğ
NULL
 )

139 * 
buf
;

140 
buf
 = (*è
	`m®loc
Ğ
	`KB
(32) );

141 
Ën
 = 
	`ä—d
Ğ
buf
, 1, 
	`KB
(32), 
å
 );

142 ifĞ
Ën
 > 0 ){

143 
	`mem£t
Ğ
c
, 0, (
cÚfig
) );

144 
	`·r£
Ğ
c
, 
buf
, 
Ën
 );

146 
	`DBG
("çedØ»ad f%s", 
f’ame
 );

147 
	`fşo£
Ğ
å
 );

150 
	`fşo£
Ğ
å
 );

152 
	}
}

154 
	$cÚfig_»adšt
Ğ
cÚfig
*
c
, * 
Çme
 )

156 
i
;

157  
i
=0; i<
c
->
™em_couÁ
; i++ )

159 ifĞ
	`¡rcmp
Ğ
c
->
™ems
[
i
]->
Çme
,‚ame ) == 0 )

161 ifĞ
	`¡ricmp
Ğ
c
->
™ems
[
i
]->
v®ue
, "true" ) == 0 )

163 ifĞ
	`¡ricmp
Ğ
c
->
™ems
[
i
]->
v®ue
, "false" ) == 0 )

165  
	`©Ş
Ğ
c
->
™ems
[
i
]->
v®ue
 );

170 
	}
}

172 * 
	$cÚfig_»ad¡r
Ğ
cÚfig
*
c
, * 
Çme
 )

174 
i
;

175  
i
=0; i<
c
->
™em_couÁ
; i++ )

177 ifĞ
	`¡rcmp
Ğ
c
->
™ems
[
i
]->
Çme
,‚ame ) == 0 )

179  
c
->
™ems
[
i
]->
v®ue
;

183  
NULL
;

184 
	}
}

186 
	$cÚfig_şo£
Ğ
cÚfig
* 
c
 )

188 
i
;

189 ifĞ!
c
 ) ;

190  
i
=0; i<
c
->
™em_couÁ
; i++ )

191 
	`ä“
Ğ
c
->
™ems
[
i
] );

192 
c
->
™em_couÁ
 = 0;

193 
	}
}

196 
cÚfig
 *
	gg_cÚf
;

197 
	$cÚfig_š™
()

200 
cÚfig
 
g_cÚf_tmp
[(config)];

201 
	`mem£t
(
g_cÚf_tmp
,0,(
cÚfig
));

202 
g_cÚf
 = 
g_cÚf_tmp
;

203 ifĞ!
g_cÚf
 ) ;

204 ifĞ
	`cÚfig_İ’
Ğ
g_cÚf
, "./qqconfig.txt" ) < 0 ){

205 
	`³¼Ü
("can't‚ot open qqconfig.txt file.");

206 
	`ex™
(-1);

208 * 
log_dœ
 = 
	`cÚfig_»ad¡r
Ğ
g_cÚf
, "QQLogDir" );

209 
ušt
 
log_‹rmš®
 = 
	`cÚfig_»adšt
Ğ
g_cÚf
, "QQTerminalLog" );

210 ifĞ
log_‹rmš®
 ){

211 
	`debug_‹rm_Ú
();

213 
	`debug_‹rm_off
();

215 ifĞ
log_dœ
 =ğ
NULL
 ){

216 
	`debug_fe_off
();

218 
	`debug_£t_dœ
Ğ
log_dœ
 );

219 
	`debug_fe_Ú
();

221 
	}
}

223 
	$cÚfig_’d
()

225 
	`cÚfig_şo£
Ğ
g_cÚf
 );

226 
	`DEL
Ğ
g_cÚf
 );

227 
	}
}

	@config.h

2 #iâdeà
_CONFIG_H


3 
	#_CONFIG_H


	)

5 
	#CONFIG_NAME_LEN
 64

	)

6 
	#CONFIG_VALUE_LEN
 256

	)

9 
	scÚfig_™em
{

10 
	mÇme
[
CONFIG_NAME_LEN
];

11 
	mv®ue
[
CONFIG_VALUE_LEN
];

12 }
	tcÚfig_™em
;

14 
	sccÚfig
{

15 
	m™em_couÁ
;

16 
cÚfig_™em
 *
	m™ems
[1024];

17 }
	tcÚfig
;

26 
cÚfig_š™
();

27 
cÚfig_’d
();

28 
cÚfig
 *
g_cÚf
;

	@crc32.c

15 
	~<¡dio.h
>

16 
	~"qqdef.h
"

18 
ušt
 
	gCRC32
[256];

19 
	gš™
 = 0;

21 
	$š™_bË
()

23 
i
,
j
;

24 
ušt
 
üc
;

25 
i
 = 0;i < 256;i++)

27 
üc
 = 
i
;

28 
j
 = 0;j < 8;j++)

30 if(
üc
 & 1){

31 
üc
 = (crc >> 1) ^ 0xEDB88320;

33 
üc
 = crc >> 1;

36 
CRC32
[
i
] = 
üc
;

38 
	}
}

40 
ušt
 
	$üc32
Ğ
uch¬
 *
buf
, 
Ën
)

42 
ušt
 
»t
 = 0xFFFFFFFF;

43 
i
;

44 ifĞ!
š™
 ){

45 
	`š™_bË
();

46 
š™
 = 1;

48 
i
 = 0; i < 
Ën
;i++)

50 
»t
 = 
CRC32
[(Ô‘ & 0xFFè^ 
buf
[
i
])] ^ (ret >> 8);

52 
»t
 = ~ret;

53  
»t
;

54 
	}
}

	@crc32.h

1 #iâdeà
_CRC32_H


2 
	#_CRC32_H


	)

4 
ušt
 
üc32
Ğ
uch¬
 *
buf
, 
Ën
);

	@debug.c

12 
	~<¡dio.h
>

13 
	~<¡d¬g.h
>

14 
	~<fú.h
>

15 
	~<¡ršg.h
>

16 #ifdeà
__WIN32__


17 
	~<io.h
>

19 
	~<time.h
>

20 
	~"debug.h
"

21 
	~"ut.h
"

22 
	~"qqdef.h
"

23 
	~"utf8.h
"

25 
	gdbg_‹rm
 = 0, 
	gdbg_fe
 = 0, 
	glog_day
 = 0;

26 
FILE
* 
	gå_log
 = 
NULL
;

27 
	gdœ
[128]={0,}, 
	gf’ame
[160];

28 
š™_fe_·th
();

30 
	$´št_”rÜ
(* 
fe
, * 
funùiÚ
, 
lše
, cÚ¡ *
fmt
, ...)

32 
va_li¡
 
¬gs
;

33 
´štbuf
[512];

34 
i
;

35 ifĞ!
dbg_‹rm
 && !
dbg_fe
 )

37 
	`va_¡¬t
(
¬gs
, 
fmt
);

38 
i
=
	`v¥rštf
Ğ
´štbuf
, 
fmt
, 
¬gs
 );

39 
´štbuf
[
i
] = 0;

40 
	`va_’d
(
¬gs
);

41 #ifdeà
__WIN32__


42 
	`utf8_to_gb
Ğ
´štbuf
,…rštbuf, 
i
 );

44 ifĞ
dbg_‹rm
 ){

45 
	`´štf
("%s(%d): %s\n", 
funùiÚ
, 
lše
, 
´štbuf
);

47 ifĞ
dbg_fe
 ){

48 
time_t
 
t
 = 
	`time
Ğ
NULL
 );

49 
tm
* 
tm1
 = 
	`loÿÉime
(&
t
);

50 ifĞ!
tm1
 ) ;

51 ifĞ
tm1
->
tm_mday
 !ğ
log_day
 ){

52 
	`š™_fe_·th
();

54 
tmp
[16];

55 
	`¡ráime
Ğ
tmp
, 15, "%X", 
tm1
 );

56 
	`årštf
Ğ
å_log
, "% [%s]%s(%d): %s\n", 
tmp
, 
fe
, 
funùiÚ
, 
lše
, 
´štbuf
);

57 
	`fæush
Ğ
å_log
 );

59 
	}
}

61 * 
	$hex_¡r
(*
buf
, 
Ën
, * 
out¡r
 )

64 cÚ¡ *
£t
 = "0123456789abcdef";

65 *
tmp
;

66 *
’d
;

67 ià(
Ën
 > 1024)

68 
Ën
 = 1024;

69 
’d
 = 
buf
 + 
Ën
;

70 
tmp
 = &
out¡r
[0];

71 
buf
 < 
’d
)

73 *
tmp
++ = 
£t
[ (*
buf
) >> 4 ];

74 *
tmp
++ = 
£t
[ (*
buf
) & 0xF ];

75 *
tmp
++ = ' ';

76 
buf
 ++;

78 *
tmp
 = '\0';

79  
out¡r
;

80 
	}
}

82 
	$hex_dump
Ğ* 
buf
, 
Ën
 )

84 
¡r
[
	`KB
(4)];

85 ifĞ
dbg_‹rm
 )

86 
	`puts
Ğ
	`hex_¡r
Ğ
buf
, 
Ën
, 
¡r
 ) );

87 ifĞ
dbg_fe
 ){

88 
	`åuts
Ğ
	`hex_¡r
Ğ
buf
, 
Ën
, 
¡r
 ), 
å_log
 );

89 
	`årštf
Ğ
å_log
, "\n" );

90 
	`fæush
Ğ
å_log
 );

93 
	}
}

95 
	$debug_‹rm_Ú
()

97 
dbg_‹rm
 = 1;

98 
	}
}

100 
	$debug_‹rm_off
()

102 
dbg_‹rm
 = 0;

103 
	}
}

105 
	$š™_fe_·th
()

107 
tmp
[64];

108 
time_t
 
t
 = 
	`time
Ğ
NULL
 );

109 
tm
* 
tm1
 = 
	`loÿÉime
(&
t
);

110 ifĞ!
tm1
 ){

111 
	`³¼Ü
("log.c init_file_path: ERROR GETTING SYSTEM TIME.");

113 
log_day
 = 
tm1
->
tm_mday
;

114 
	`¡ráime
Ğ
tmp
, 64, "/%Y-%m-%d.txt", 
tm1
 );

115 ifĞ
	`acûss
Ğ
dœ
, 0 )!=0 ){

116 
	`mkdœ_»cursive
Ğ
dœ
 );

118 
	`¡rıy
Ğ
f’ame
, 
dœ
 );

119 
	`¡rÿt
Ğ
f’ame
, 
tmp
 );

120 ifĞ
å_log
 )

121 
	`fşo£
Ğ
å_log
 );

122 
å_log
 = 
	`fİ’
Ğ
f’ame
, "aw" );

124 
	}
}

126 
	$debug_fe_Ú
()

128 ifĞ
dbg_fe
 )

130 
	`š™_fe_·th
();

131 
dbg_fe
 = 1;

132 
	}
}

134 
	$debug_fe_off
()

136 ifĞ!
dbg_fe
 )

138 
dbg_fe
 = 0;

139 ifĞ
å_log
 )

140 
	`fşo£
Ğ
å_log
 );

141 
	}
}

143 
	$debug_£t_dœ
(* 
¡r
)

145 
	`¡rıy
Ğ
dœ
, 
¡r
 );

146 
	}
}

	@debug.h

1 #iâdeà
_DEBUG_H


2 
	#_DEBUG_H


	)

4 
	~<¡dio.h
>

5 
	~<”ºo.h
>

6 
	~<as£¹.h
>

10 #iâdeà
RELEASE


11 
	#DBG
(
¬gs
 ...) \

12 
	`´št_”rÜ
Ğ
__FILE__
, (*)
__func__
, 
__LINE__
, ##
¬gs
 )

	)

14 
	#DBG
(
¬gs
 ...)

	)

17 
	#MSG
 
´štf


	)

18 
´št_”rÜ
(* 
fe
, * 
funùiÚ
, 
lše
, cÚ¡ *
fmt
, ...);

19 
hex_dump
Ğ* 
buf
, 
Ën
 );

20 
debug_‹rm_Ú
();

21 
debug_‹rm_off
();

22 
debug_fe_Ú
();

23 
debug_fe_off
();

24 
debug_£t_dœ
(* 
¡r
);

	@gMystar.cc

1 
	~"gMy¡¬.h
"

2 
	~<±h»ad.h
>

4 
My¡¬
 *
	ggMy¡¬
::
my¡¬
;

5 
boŞ
 
	ggMy¡¬
::
æag
;

6 
	gGlib
::
RefPŒ
<
Gtk
::
StusIcÚ
> 
gMy¡¬
::
¡©us_icÚ
;

7 
Wšdow
 *
	ggMy¡¬
::
MašWšdow
;

8 
CheckBu‰Ú
 *
	ggMy¡¬
::
autŞogš_checkbu‰Ú
;

9 
Bu‰Ú
 *
	ggMy¡¬
::
cÚÃù_bu‰Ú
;

10 
Lab–
 *
	ggMy¡¬
::
¡©us_Ïb–
;

11 
	ggMy¡¬
::
wšdow_x
;

12 
	ggMy¡¬
::
wšdow_y
;

13 
	gsigc
::
cÚÃùiÚ
 
gMy¡¬
::
c
;

14 
	gNÙify
::
NÙifiÿtiÚ
 *
gMy¡¬
::
n
;

92 
	ggMy¡¬
::
	$gMy¡¬
()

94 
my¡¬
 = 
Ãw
 
	`My¡¬
();

95 
æag
 = 
Œue
;

98 
¡©us_icÚ
 = 
StusIcÚ
::
	`ü—‹_äom_fe
("/usr/share/gMystar/data/disconnect.png");

99 if(
¡©us_icÚ
)

101 
¡©us_icÚ
->
	`£t_toŞt
("ç”¨gtkmmå’Œgladeåšçš„é”æ·å®¢æˆ·ç«¯.");

102 
¡©us_icÚ
->
	`sigÇl_aùiv©e
().
	`cÚÃù
(
sigc
::
	`mem_fun
(*
this
, &
gMy¡¬
::
Ú_Œay_şicked
));

106 
cout
<<"createray iconƒrror!\n";

109 
»fXml
 = 
Gnome
::
GÏde
::
Xml
::
	`ü—‹
("/usr/share/gMystar/data/gMystar.glade","main_window");

110 if(!
»fXml
)

111 
	`ex™
(271);

113 
VBox
* 
maš_wšdow
 = 
NULL
;

114 
maš_wšdow
 = 
»fXml
->
	`g‘_widg‘
("main_window", main_window);

116 
nickÇme_’Œy
ğ
NULL
;

117 
nickÇme_’Œy
 = 
»fXml
->
	`g‘_widg‘
("nickname",‚ickname_entry);

118 
nickÇme_’Œy
->
	`£t_‹xt
(
my¡¬
->
u£r
.
	`g‘_nickÇme
());

120 
u£ºame_’Œy
ğ
NULL
;

121 
u£ºame_’Œy
ğ
»fXml
->
	`g‘_widg‘
("username", username_entry);

122 
u£ºame_’Œy
->
	`£t_‹xt
(
my¡¬
->
u£r
.
	`g‘_u£ºame
());

124 
·sswÜd_’Œy
ğ
NULL
;

125 
·sswÜd_’Œy
ğ
»fXml
->
	`g‘_widg‘
("password",…assword_entry);

126 
·sswÜd_’Œy
->
	`£t_‹xt
(
my¡¬
->
u£r
.
	`g‘_·sswÜd
());

128 
çkeAdd»ss_’Œy
 = 
NULL
;

129 
çkeAdd»ss_’Œy
 = 
»fXml
->
	`g‘_widg‘
("fakeAddress", fakeAddress_entry);

130 
çkeAdd»ss_’Œy
->
	`£t_‹xt
(
my¡¬
->
u£r
.
	`g‘_çkeAdd»ss
());

132 
autŞogš_checkbu‰Ú
 = 
NULL
;

133 
autŞogš_checkbu‰Ú
 = 
»fXml
->
	`g‘_widg‘
("autologin_checkbutton",autologin_checkbutton);

135 
cÚÃù_bu‰Ú
 = 
NULL
;

136 
cÚÃù_bu‰Ú
 = 
»fXml
->
	`g‘_widg‘
("connect_button", connect_button);

137 if(
cÚÃù_bu‰Ú
)

139 
gMy¡¬
::
c
 = 
cÚÃù_bu‰Ú
->
	`sigÇl_şicked
().
	`cÚÃù
(
sigc
::
	`mem_fun
(*
this
, &gMy¡¬::
Ú_cÚÃù_bu‰Ú_şicked
));

143 
discÚÃù_bu‰Ú
 = 
NULL
;

144 
discÚÃù_bu‰Ú
 = 
»fXml
->
	`g‘_widg‘
("disconnect_button", disconnect_button);

145 if(
discÚÃù_bu‰Ú
)

147 
gMy¡¬
::
c
 = 
discÚÃù_bu‰Ú
->
	`sigÇl_şicked
().
	`cÚÃù
(
sigc
::
	`mem_fun
(*
this
, &gMy¡¬::
Ú_discÚÃù_bu‰Ú_şicked
));

150 
qu™_bu‰Ú
 = 
NULL
;

151 
qu™_bu‰Ú
 = 
»fXml
->
	`g‘_widg‘
("quit_button", quit_button);

152 if(
qu™_bu‰Ú
)

154 
qu™_bu‰Ú
->
	`sigÇl_şicked
().
	`cÚÃù
(
sigc
::
	`mem_fun
(*
this
, &
gMy¡¬
::
Ú_qu™_bu‰Ú_şicked
));

157 
¡©us_Ïb–
 = 
NULL
;

158 
¡©us_Ïb–
 = 
»fXml
->
	`g‘_widg‘
("status",status_label);

199 
	`add
(*
maš_wšdow
);

200 
	`show_®l
();

202 if(
my¡¬
->
autŞogš
)

203 
	`Ú_cÚÃù_bu‰Ú_şicked
();

204 
	}
}

205 
	ggMy¡¬
::~
	$gMy¡¬
()

207 
	}
}

208 
gMy¡¬
::
	$Ú_qu™_bu‰Ú_şicked
()

211 
	`hide
();

212 
	}
}

213 
	ggMy¡¬
::
	$Ú_discÚÃù_bu‰Ú_şicked
()

215 
my¡¬
->
	`logout
(
SIGINT
);

216 
¡©us_Ïb–
->
	`£t_Ïb–
("logout...");

217 if(!
	`±h»ad_ÿnûl
(
auth’_th»ad
))

218 
cout
<<"å–æ¶ˆè®¤è¯ã€‚ã€‚ã€‚\n";

219 
	}
}

220 
	ggMy¡¬
::
	$Ú_cÚÃù_bu‰Ú_şicked
()

222 
cout
<<"ç”¨äºè¿æ¥çš„è´¦å·ä¿¡æ¯æ˜¯:"<<
’dl
;

223 
¡r
[20];

224 
	`¡rıy
(
¡r
,
nickÇme_’Œy
->
	`g‘_‹xt
().
	`c_¡r
());

225 
my¡¬
->
u£r
.
	`£t_nickÇme
(
¡r
);

227 
	`¡rıy
(
¡r
,
u£ºame_’Œy
->
	`g‘_‹xt
().
	`c_¡r
());

228 
my¡¬
->
u£r
.
	`£t_u£ºame
(
¡r
);

230 
	`¡rıy
(
¡r
,
·sswÜd_’Œy
->
	`g‘_‹xt
().
	`c_¡r
());

231 
my¡¬
->
u£r
.
	`£t_·sswÜd
(
¡r
);

233 
	`¡rıy
(
¡r
,
çkeAdd»ss_’Œy
->
	`g‘_‹xt
().
	`c_¡r
());

234 
my¡¬
->
u£r
.
	`£t_çkeAdd»ss
(
¡r
);

236 
»s
 = 
	`±h»ad_ü—‹
(&
auth’_th»ad
, 
NULL
,
gMy¡¬
::
‹¡
, NULL);

237 if(
»s
!=0)

239 
	`³¼Ü
("Thread creation failed");

240 
	`ex™
(
EXIT_FAILURE
);

243 
»s2
 = 
	`±h»ad_ü—‹
(&
chªge_ui_th»ad
, 
NULL
,
gMy¡¬
::
chªge_ui
, NULL);

244 if(
»s2
!=0)

246 
	`³¼Ü
("Thread creation failed");

247 
	`ex™
(
EXIT_FAILURE
);

249 
	}
}

250 
	ggMy¡¬
::
	$h–p
()

252 
	`´štf
("to use‚o gui mode,…leaseype --nogui\n");

253 
	}
}

254 
	ggMy¡¬
::
	$show_mes§ge
(cÚ¡ *
mes§ge
)

256 
cout
<<
mes§ge
;

257 
¡©us_Ïb–
->
	`£t_‹xt
(
mes§ge
);

258 
	}
}

259 
	ggMy¡¬
::
	$Ú_Œay_şicked
()

261 if(
MašWšdow
->
	`is_visibË
())

262 
	`hide_wšdow
();

264 
	`show_wšdow
();

265 
	}
}

266 
	ggMy¡¬
::
	$show_wšdow
()

268 
MašWšdow
->
	`move
(
wšdow_x
, 
wšdow_y
);

269 
cout
<<"»sumthpos™iÚ("<<
wšdow_x
<<","<<
wšdow_y
<<")"<<
’dl
;

270 
MašWšdow
->
	`show
();

271 
	}
}

272 
	ggMy¡¬
::
	$hide_wšdow
()

277 
	}
}

278 *
gMy¡¬
::
	$‹¡
(*
a
)

280 
my¡¬
->
	`auth’
();

281 
	}
}

282 *
	ggMy¡¬
::
	$chªge_ui
(*
a
)

284 
æag
)

286 
¡©us
 = 
my¡¬
->
	`g‘_¡©us
();

287 
¡©us
)

290 
¡©us_Ïb–
->
	`£t_Ïb–
(">> Searching for server...\n");

293 
¡©us_Ïb–
->
	`£t_Ïb–
(" Sending user‚ame...");

296 
¡©us_Ïb–
->
	`£t_Ïb–
(" Sending…assword...");

299 
¡©us_icÚ
->
	`£t_äom_fe
("/usr/share/gMystar/data/connect.png");

300 
¡©us_Ïb–
->
	`£t_Ïb–
("keep sendingƒcho...");

302 
NÙify
::
	`š™
("Iconest");

303 
n
 = 
Ãw
 
NÙify
::
	`NÙifiÿtiÚ
("gMystar", "è¿æ¥æˆåŠŸ", "appointment-new");

304 
n
->
	`£t_timeout
(1000);

305 
n
->
	`show
();

307 
	`hide_wšdow
();

308 if(
autŞogš_checkbu‰Ú
->
	`g‘_aùive
())

309 
my¡¬
->
autŞogš
=
Œue
;

311 
my¡¬
->
autŞogš
=
çl£
;

312 
my¡¬
->
	`§ve_fe
();

313 
æag
=
çl£
;

316 
n
 = 
Ãw
 
NÙify
::
	`NÙifiÿtiÚ
("gMystar", "ç½‘ç»œæ–­å¼€ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚ã€‚", "appointment-new");

317 
n
->
	`£t_timeout
(1000);

318 
n
->
	`show
();

319 
æag
=
çl£
;

321 
æag
=
Œue
;

325 
	}
}

326 
boŞ
 
	ggMy¡¬
::
	$Ú_key_´ess_ev’t
(
GdkEv’tKey
 *
ev
)

328 if(
ev
->
ty³
!=
GDK_KEY_PRESS
)

329  
Wšdow
::
	`Ú_key_´ess_ev’t
(
ev
);

330 
ev
->
keyv®
)

332 
GDK_w
:

333 if(
ev
->
¡©e
 & 
GDK_CONTROL_MASK
)

335 
	`hide
();

337  
Wšdow
::
	`Ú_key_´ess_ev’t
(
ev
);

339  
Œue
;

340 
	}
}

	@gMystar.h

1 
	~"My¡¬.h
"

2 
	~<gtkmm.h
>

3 
	~<libgÏdemm.h
>

4 
	~<libnÙifymm.h
>

5 
	~<boo¡/Ëxiÿl_ÿ¡.hµ
>

6 
usšg
 
Çme¥aû
 
	gGtk
;

8 şas 
	cgMy¡¬
:
public
 
Wšdow


10 
public
:

12 
gMy¡¬
();

13 ~
gMy¡¬
();

14 
h–p
();

15 
My¡¬
 *
	mmy¡¬
;

16 
	m´Ùeùed
:

17 
boŞ
 
Ú_key_´ess_ev’t
(
GdkEv’tKey
 *);

18 
Ú_qu™_bu‰Ú_şicked
();

19 
Ú_cÚÃù_bu‰Ú_şicked
();

20 
Ú_discÚÃù_bu‰Ú_şicked
();

21 
Ú_Œay_şicked
();

22 
show_mes§ge
(cÚ¡ *
mes§ge
);

23 
show_wšdow
();

24 
hide_wšdow
();

26 *
‹¡
(*);

27 *
chªge_ui
(*);

29 
	mGlib
::
RefPŒ
<
Gnome
::
GÏde
::
Xml
> 
»fXml
;

30 
Wšdow
 *
	mMašWšdow
;

31 
EÁry
 *
	mu£ºame_’Œy
;

32 
EÁry
 *
	m·sswÜd_’Œy
;

33 
EÁry
 *
	mçkeAdd»ss_’Œy
;

34 
EÁry
 *
	mnickÇme_’Œy
;

35 
CheckBu‰Ú
 *
	mautŞogš_checkbu‰Ú
;

36 
Bu‰Ú
 *
	mcÚÃù_bu‰Ú
;

37 
Bu‰Ú
 *
	mdiscÚÃù_bu‰Ú
;

38 
Bu‰Ú
 *
	mqu™_bu‰Ú
;

39 
Lab–
 *
	m¡©us_Ïb–
;

40 
	mGlib
::
RefPŒ
<
Gtk
::
StusIcÚ
> 
¡©us_icÚ
;

42 
±h»ad_t
 
	mauth’_th»ad
;

43 
±h»ad_t
 
	mchªge_ui_th»ad
;

45 
boŞ
 
	mæag
;

47 
	mwšdow_x
;

48 
	mwšdow_y
;

49 
	msigc
::
cÚÃùiÚ
 
c
;

50 
	mNÙify
::
NÙifiÿtiÚ
 *
n
;

	@gmyqq.cc

1 
	~"gmyqq.h
"

2 
	~<±h»ad.h
>

6 
	ggMyqq
::
	$gMyqq
()

20 
»fXml
 = 
Gnome
::
GÏde
::
Xml
::
	`ü—‹
("../data/gmyqq.glade","main_window");

21 if(!
»fXml
)

22 
	`ex™
(271);

33 
mes§ge_‹xtv›w
=
NULL
;

34 
mes§ge_‹xtv›w
 = 
»fXml
->
	`g‘_widg‘
("message_textview",message_textview);

37 
maš_wšdow
 = 
NULL
;

38 
maš_wšdow
 = 
»fXml
->
	`g‘_widg‘
("main_window", main_window);

40 
maš_wšdow
->
	`£t_deçuÉ_size
(800,600);

41 
maš_wšdow
->
	`£t_t™Ë
("gmyqq");

44 
maš_wšdow
->
	`£t_focus
(*
mes§ge_‹xtv›w
);

45 
maš_wšdow
->
	`show_®l
();

70 
	}
}

71 
	ggMyqq
::~
	$gMyqq
()

73 
	}
}

74 
gMyqq
::
	$Ú_Œay_şicked
()

76 if(
maš_wšdow
->
	`is_visibË
())

77 
	`hide_wšdow
();

79 
	`show_wšdow
();

80 
	}
}

81 
	ggMyqq
::
	$show_wšdow
()

85 
maš_wšdow
->
	`show
();

86 
	}
}

87 
	ggMyqq
::
	$hide_wšdow
()

91 
maš_wšdow
->
	`hide
();

92 
	}
}

93 
	ggMyqq
::
	$Ú_‹xtv›w_’‹r_key_´es£d
()

95 
	}
}

98 
Myqq
::
	$Myqq
()

100 ifĞ
	`logš
() )

102 
¡©us
 = 1;

103 
	`w–come_mes§ge
();

104 
¡©us
)

106 
commªd
[256];

107 *
‹mp
=
commªd
;

108 
	`g‘_commªd
(
‹mp
);

109 
	`·r£_commªd
(
commªd
);

112 
	}
}

113 
boŞ
 
	gMyqq
::
	$logš
()

115 
cout
<<"QQè´¦å·ï¼š";

116 
cš
>>
accouÁ
;

117 
cout
<<"QQå¯†ç ï¼š";

118 
cš
>>
·sswÜd
;

119  
	`auth’
();

120 
	}
}

121 
boŞ
 
	gMyqq
::
	$auth’
()

123  
Œue
;

124 
	}
}

125 
	gMyqq
::
	$w–come_mes§ge
()

127 
cout
<<"æ¬¢è¿ä½¿ç”¨ MyQQ2009 beta1 ä¸­æ–‡ç‰ˆ\n"

132 
	}
}

133 
	gMyqq
::
	$h–p
()

135 
cout
<<"add/a: æ·»åŠ å¥½å‹.‡dd+QQå·ç .\n"

151 
	}
}

152 
	gMyqq
::
	$g‘_commªd
(*
commªd
)

154 
cout
<<"Myqq:)>";

155 
cš
>>
commªd
;

156 
	}
}

157 
	gMyqq
::
	$·r£_commªd
(*
commªd
)

160 if(!
	`¡rcmp
(
commªd
,"ls"))

161 
	`li¡_Úlše_budd›s
();

162 if(!
	`¡rcmp
(
commªd
,"la"))

163 
	`li¡_®l
();

164 if(!
	`¡rcmp
(
commªd
,"lg"))

165 
	`li¡_groups
();

166 if(!
	`¡rcmp
(
commªd
,"logout"))

167 
	`logout
();

168 if(!
	`¡rcmp
(
commªd
,"help"))

169 
	`h–p
();

170 if(!
	`¡rcmp
(
commªd
,"exit") || !strcmp(command,"quit"))

171 
	`qu™
();

173 
cout
<<"unknowÀcommªd '"<<
commªd
<<"',y³ 'h–p' fÜ mÜšfÜm©iÚ"<<
’dl
;

174 
	}
}

175 *
	gMyqq
::
	$g‘_Úlše_budd›s
()

177 
	}
}

178 *
Myqq
::
	$g‘_®l
()

180 
	}
}

181 *
Myqq
::
	$g‘_groups
()

183 
	}
}

184 
Myqq
::
	$li¡_Úlše_budd›s
()

186 
cout
<<"li¡hÚlšbudd›s"<<
’dl
;

187 
	}
}

188 
	gMyqq
::
	$li¡_®l
()

190 
cout
<<"li¡‡Î budd›s"<<
’dl
;

191 
	}
}

192 
	gMyqq
::
	$li¡_groups
()

194 
cout
<<"li¡ groups"<<
’dl
;

195 
	}
}

196 
	gMyqq
::
	$logout
()

198 
¡©us
 = 0;

199 
	}
}

200 
	gMyqq
::
	$qu™
()

202 
cout
<<"wa™šg fÜƒx™..."<<
’dl
;

203 
¡©us
 = 0;

204 
	}
}

205 
	gMyqq
::~
	$Myqq
()

207 
	}
}

210 
	$maš
(
¬gc
, *
¬gv
[])

212 if(
¬gc
 == 2)

214 if(!
	`¡rcmp
(
¬gv
[1],"--nogui"))

217 
Myqq
 
myqq
;

219 if(!
	`¡rcmp
(
¬gv
[1],"--help"))

222 if(!
	`¡rcmp
(
¬gv
[1],"--test"))

225 if(!
	`¡rcmp
(
¬gv
[1],"-s"))

230 
cout
<<"u§ge: gMy¡¬ --h–°fÜ mÜd‘as"<<
’dl
;

235 
Gtk
::
Maš
 
	`k™
(
¬gc
, 
¬gv
);

236 
gMyqq
 
gmyqq
;

237 
k™
.
	`run
();

240 
	}
}

	@gmyqq.h

3 
	~"myqq.h
"

5 
	~<¡ršg.h
>

6 
	~<io¡»am
>

7 
	~<¡dlib.h
>

8 
	~<gtkmm.h
>

9 
	~<libgÏdemm.h
>

10 
	~<libnÙifymm.h
>

11 
	~<boo¡/Ëxiÿl_ÿ¡.hµ
>

12 
usšg
 
Çme¥aû
 
Gtk
;

13 
usšg
 
Çme¥aû
 
	g¡d
;

15 şas 
	cgMyqq


17 
	mpublic
:

18 
gMyqq
();

19 ~
gMyqq
();

20 
	m´Ùeùed
:

21 
Ú_Œay_şicked
();

22 
show_wšdow
();

23 
hide_wšdow
();

24 
Ú_‹xtv›w_’‹r_key_´es£d
();

25 
TextV›w
 *
	mmes§ge_‹xtv›w
;

26 
	mGlib
::
RefPŒ
<
Gnome
::
GÏde
::
Xml
> 
»fXml
;

27 
	mGlib
::
RefPŒ
<
Gdk
::
Pixbuf
> 
ui_logo
;

28 
Wšdow
 *
	mmaš_wšdow
;

29 
EÁry
 *
	mu£ºame_’Œy
;

30 
EÁry
 *
	m·sswÜd_’Œy
;

31 
EÁry
 *
	mçkeAdd»ss_’Œy
;

32 
EÁry
 *
	mnickÇme_’Œy
;

33 
CheckBu‰Ú
 *
	mautŞogš_checkbu‰Ú
;

34 
Bu‰Ú
 *
	mcÚÃù_bu‰Ú
;

35 
Bu‰Ú
 *
	mdiscÚÃù_bu‰Ú
;

36 
Bu‰Ú
 *
	mqu™_bu‰Ú
;

37 
Lab–
 *
	m¡©us_Ïb–
;

41 
±h»ad_t
 
	mauth’_th»ad
;

42 
±h»ad_t
 
	mchªge_ui_th»ad
;

44 
	mwšdow_x
;

45 
	mwšdow_y
;

46 
	msigc
::
cÚÃùiÚ
 
c
;

47 
	mNÙify
::
NÙifiÿtiÚ
 *
n
;

50 şas 
	cMyqq


52 
	mpublic
:

53 
Myqq
();

54 ~
Myqq
();

55 
	m´Ùeùed
:

56 
boŞ
 
logš
();

57 
w–come_mes§ge
();

58 
h–p
();

59 
boŞ
 
auth’
();

60 
g‘_commªd
(*);

61 
·r£_commªd
(*);

64 *
g‘_Úlše_budd›s
();

65 *
g‘_®l
();

66 *
g‘_groups
();

67 
li¡_Úlše_budd›s
();

68 
li¡_®l
();

69 
li¡_groups
();

70 
logout
();

71 
boŞ
 
£nd_mes§ge
();

72 
qu™
();

73 
	m´iv©e
:

74 
accouÁ
[32];

75 
	m·sswÜd
[32];

76 
	m¡©us
;

	@group.c

14 
	~<time.h
>

15 
	~<¡dlib.h
>

16 
	~<¡ršg.h
>

17 
	~"qqş›Á.h
"

18 
	~"memÜy.h
"

19 
	~"debug.h
"

20 
	~"´ÙocŞ.h
"

21 
	~"li¡.h
"

22 
	~"group.h
"

24 
	$£¬ch”
ĞcÚ¡ * 
p
, cÚ¡ * 
v
 )

26  ( ((
qqgroup
*)
p
)->
numb”
 =ğ()
v
 );

27 
	}
}

29 
qqgroup
* 
	$group_g‘
Ğ
qqş›Á
* 
qq
, 
ušt
 
numb”
, 
ü—‹
 )

31 ifĞ!
numb”
 )

32  
NULL
;

33 
qqgroup
* 
g
;

34 
g
 = (
qqgroup
 *)
	`li¡_£¬ch
Ğ&
qq
->
group_li¡
, (*)
numb”
, 
£¬ch”
 );

36 ifĞ!
g
 && 
ü—‹
 ){

37 
	`NEW
Ğ
g
, Ğ
qqgroup
 ) ,qqgroup);

38 ifĞ!
g
 ){

39 
	`DBG
("Fatalƒrror: group‚ot‡llocated");

40  
g
;

42 
g
->
numb”
 =‚umber;

43 
	`¥rštf
Ğ
g
->
Çme
, "%u", 
numb”
 );

44 ifĞ
	`li¡_­³nd
Ğ&
qq
->
group_li¡
, (*)
g
 )<0 ){

45 
	`DEL
Ğ
g
 );

46 
	`DBG
("group†ist is full.");

49  
g
;

50 
	}
}

52 
	$group_»move
Ğ
qqş›Á
* 
qq
, 
ušt
 
numb”
 )

54 
qqgroup
* 
g
;

55 
g
 = (
qqgroup
 *)
	`li¡_£¬ch
Ğ&
qq
->
group_li¡
, (*)
numb”
, 
£¬ch”
 );

56 ifĞ
g
 ){

57 
	`li¡_»move
Ğ&
qq
->
group_li¡
, 
g
 );

59 
	}
}

61 
	$group_upd©e_li¡
Ğ
qqş›Á
* 
qq
 )

64 
	`´Ù_group_dowÆßd_Ïb–s
Ğ
qq
, 0 );

65 
	}
}

67 
	$group_upd©e_šfo
Ğ
qqş›Á
* 
qq
, 
qqgroup
* 
g
 )

69 
	}
}

72 
	$group_put_ev’t
Ğ
qqş›Á
* 
qq
 )

74 *
‹mp
;

75 
i
;

76 
qqgroup
* 
g
;

77 
	`NEW
Ğ
‹mp
, 
	`KB
(1) ,);

78 ifĞ!
‹mp
 ) ;

79 
	`¡rıy
Ğ
‹mp
, "grouplist^$" );

80 
	`±h»ad_mu‹x_lock
Ğ&
qq
->
group_li¡
.
mu‹x
 );

81  
i
=0; i<
qq
->
group_li¡
.
couÁ
; i++ ){

82 
g
 = (
qqgroup
*)
qq
->
group_li¡
.
™ems
[
i
];

83 
	`¥rštf
Ğ
‹mp
, "%s%u\t%s^@",emp, 
g
->
numb”
, g->
Çme
 );

85 
	`±h»ad_mu‹x_uÆock
Ğ&
qq
->
group_li¡
.
mu‹x
 );

86 
	`qqş›Á_put_ev’t
Ğ
qq
, 
‹mp
 );

87 
	`DEL
Ğ
‹mp
 );

88 
	}
}

	@group.h

1 #iâdeà
_GROUP_H


2 
	#_GROUP_H


	)

4 
	~"qqdef.h
"

6 
	sqqgroup
{

7 
ušt
 
	mnumb”
;

8 
	mÇme
[
GROUPNAME_LEN
];

9 }
	tqqgroup
;

11 
	gqqş›Á
;

12 
qqgroup
* 
group_g‘
Ğ
qqş›Á
* 
qq
, 
ušt
 
numb”
, 
ü—‹
 );

13 
group_»move
Ğ
qqş›Á
* 
qq
, 
ušt
 
numb”
 );

14 
group_upd©e_li¡
Ğ
qqş›Á
* 
qq
 );

15 
group_upd©e_šfo
Ğ
qqş›Á
* 
qq
, 
qqgroup
* 
g
 );

16 
group_put_ev’t
Ğ
qqş›Á
* 
qq
 );

	@list.c

14 
	~<¡ršg.h
>

15 
	~<¡dlib.h
>

16 
	~<±h»ad.h
>

17 
	~"qqdef.h
"

18 
	~"debug.h
"

19 
	~"memÜy.h
"

20 
	~"li¡.h
"

23 
	$li¡_ü—‹
Ğ
li¡
* 
l
, 
size
 )

25 
l
->
size
 = size;

26 
l
->
couÁ
 = 0;

27 
	`±h»ad_mu‹x_š™
Ğ&
l
->
mu‹x
, 
NULL
 );

28 
	`NEW
Ğ
l
->
™ems
,†->
size
*(*) ,*);

29 
	`as£¹
Ğ
l
->
™ems
 );

31 
	}
}

33 
	$li¡_­³nd
Ğ
li¡
* 
l
, * 
d©a
 )

35 
i
, 
»t
 = 0;

36 
	`±h»ad_mu‹x_lock
Ğ&
l
->
mu‹x
 );

37 ifĞ
l
->
couÁ
 >ğl->
size
 ){

38 
	`DBG
("li¡ i fuÎ. couÁ:%d", 
l
->
couÁ
);

39 
»t
 = -1;

41 
i
 = 
l
->
couÁ
 ++;

42 
l
->
™ems
[
i
] = 
d©a
;

44 
	`±h»ad_mu‹x_uÆock
Ğ&
l
->
mu‹x
 );

45  
»t
;

46 
	}
}

48 
	$li¡_»move
Ğ
li¡
* 
l
, * 
d©a
 )

50 
i
;

51 
	`±h»ad_mu‹x_lock
Ğ&
l
->
mu‹x
 );

52  
i
=0; i<
l
->
couÁ
; i++ ){

53 ifĞ
l
->
™ems
[
i
] =ğ
d©a
 ){

54 
l
->
couÁ
 --;

55 ifĞ
i
 !ğ
l
->
couÁ
 )

56 
l
->
™ems
[
i
] =†->™ems[l->
couÁ
];

60 
	`±h»ad_mu‹x_uÆock
Ğ&
l
->
mu‹x
 );

62 
	}
}

64 * 
	$li¡_£¬ch
Ğ
li¡
* 
l
, * 
v
, 
£¬ch_func
 
£¬ch
 )

66 
i
;

67 
	`±h»ad_mu‹x_lock
Ğ&
l
->
mu‹x
 );

68  
i
=0; i<
l
->
couÁ
; i++ ){

69 ifĞ
	`£¬ch
Ğ
l
->
™ems
[
i
], 
v
 ) )

72 
	`±h»ad_mu‹x_uÆock
Ğ&
l
->
mu‹x
 );

73 ifĞ
i
 < 
l
->
couÁ
 )

74  
l
->
™ems
[
i
];

75  
NULL
;

76 
	}
}

78 
	$li¡_sÜt
Ğ
li¡
* 
l
, 
comp_func
 
comp
 )

80 
	`±h»ad_mu‹x_lock
Ğ&
l
->
mu‹x
 );

81 ifĞ
l
->
couÁ
 == 0 )

83 
	`qsÜt
Ğ
l
->
™ems
,†->
couÁ
, (*), 
comp
 );

84 
	`±h»ad_mu‹x_uÆock
Ğ&
l
->
mu‹x
 );

85 
	}
}

87 
	$li¡_ş—nup
Ğ
li¡
* 
l
 )

89 
i
;

90 
	`±h»ad_mu‹x_lock
Ğ&
l
->
mu‹x
 );

91 ifĞ
l
->
couÁ
 > 0 ){

93  
i
=0; i<
l
->
couÁ
; i++ ){

94 
	`DEL
Ğ
l
->
™ems
[
i
] );

97 
	`DEL
Ğ
l
->
™ems
 );

98 
	`±h»ad_mu‹x_uÆock
Ğ&
l
->
mu‹x
 );

99 
	`±h»ad_mu‹x_de¡roy
Ğ&
l
->
mu‹x
 );

100 
	}
}

	@list.h

1 #iâdeà
_LIST_H


2 
	#_LIST_H


	)

4 
	~<±h»ad.h
>

6 
	sli¡
{

7 
±h»ad_mu‹x_t
 
	mmu‹x
;

8 
	msize
;

9 
	mcouÁ
;

10 ** 
	m™ems
;

11 }
	tli¡
;

13 (*
	tcomp_func
)(const *, const *);

14 (*
	t£¬ch_func
)(const *, const *);

16 
	`li¡_ü—‹
Ğ
li¡
* 
l
, 
size
 );

17 
	`li¡_­³nd
Ğ
li¡
* 
l
, * 
d©a
 );

18 
	`li¡_»move
Ğ
li¡
* 
l
, * 
d©a
 );

19 * 
	`li¡_£¬ch
Ğ
li¡
* 
l
, *, 
£¬ch_func
 
£¬ch
 );

20 
	`li¡_sÜt
Ğ
li¡
* 
l
, 
comp_func
 
comp
 );

21 
	`li¡_ş—nup
Ğ
li¡
* 
l
 );

	@loop.c

14 
	~<¡ršg.h
>

15 
	~<¡dlib.h
>

16 
	~<±h»ad.h
>

17 
	~"qqdef.h
"

18 
	~"debug.h
"

19 
	~"memÜy.h
"

20 
	~"loİ.h
"

23 
	$loİ_ü—‹
Ğ
loİ
* 
l
, 
size
, 
loİ_d–‘e_func
 
d–
 )

25 
l
->
size
 = size;

26 
l
->
h—d
 =†->

 = 0;

27 
l
->
d–_func
 = 
d–
;

28 
	`±h»ad_mu‹x_š™
Ğ&
l
->
mu‹x
, 
NULL
 );

29 
l
->
™ems
 = (**)
	`m®loc
Ğl->
size
*(*) );

30 
	`as£¹
Ğ
l
->
™ems
 !ğ
NULL
 );

32 
	}
}

35 
	$loİ_push_to_
Ğ
loİ
* 
l
, * 
d©a
 )

37 
	`±h»ad_mu‹x_lock
Ğ&
l
->
mu‹x
 );

38 ifĞ(
l
->

+1)%l->
size
 =ğl->
h—d
 ){

40 ifĞ
l
->
d–_func
 )

41 
l
->
	`d–_func
Ğl->
™ems
[l->
h—d
] );

42 
l
->
h—d
 = (l->h—d+1)%l->
size
;

45 
l
->
™ems
[l->

] = 
d©a
;

46 
l
->

 = (l->+1)%l->
size
;

47 
	`±h»ad_mu‹x_uÆock
Ğ&
l
->
mu‹x
 );

49 
	}
}

52 
	$loİ_push_to_h—d
Ğ
loİ
* 
l
, * 
d©a
 )

54 
	`±h»ad_mu‹x_lock
Ğ&
l
->
mu‹x
 );

55 ifĞ(
l
->
size
+l->
h—d
-1)%l->siz=ğl->

 ){

56 
l
->

 = (l->
size
+l->tail-1)%l->size;

57 
	`as£¹
Ğ
l
->

 >= 0 );

58 ifĞ
l
->
d–_func
 )

59 
l
->
	`d–_func
Ğl->
™ems
[l->

] );

62 
l
->
h—d
 = (l->
size
+l->head-1)%l->size;

63 
	`as£¹
Ğ
l
->
h—d
 >= 0 );

64 
l
->
™ems
[l->
h—d
] = 
d©a
;

65 
	`±h»ad_mu‹x_uÆock
Ğ&
l
->
mu‹x
 );

67 
	}
}

69 * 
	$loİ_pİ_äom_h—d
Ğ
loİ
* 
l
 )

71 * 
p
 = 
NULL
;

72 
	`±h»ad_mu‹x_lock
Ğ&
l
->
mu‹x
 );

73 ifĞ
l
->

 !ğl->
h—d
 ){

74 
p
 = 
l
->
™ems
[l->
h—d
];

75 
l
->
h—d
 = (l->h—d+1)%l->
size
;

76 
	`as£¹
Ğ
l
->
h—d
 <†->
size
 );

78 
	`±h»ad_mu‹x_uÆock
Ğ&
l
->
mu‹x
 );

79  
p
;

80 
	}
}

82 * 
	$loİ_pİ_äom_
Ğ
loİ
* 
l
 )

84 * 
p
 = 
NULL
;

85 
	`±h»ad_mu‹x_lock
Ğ&
l
->
mu‹x
 );

86 ifĞ
l
->

 !ğl->
h—d
 ){

87 
l
->

 = (l->
size
+l->tail-1)%l->size;

88 
	`as£¹
Ğ
l
->

 >= 0 );

89 
p
 = 
l
->
™ems
[l->

];

91 
	`±h»ad_mu‹x_uÆock
Ğ&
l
->
mu‹x
 );

92  
p
;

93 
	}
}

95 
	$loİ_»move
Ğ
loİ
* 
l
, * 
d©a
 )

97 
i
;

98 
	`±h»ad_mu‹x_lock
Ğ&
l
->
mu‹x
 );

99  
i
=
l
->
h—d
; i!ö->

; i=(i+1)%l->
size
 )

101 ifĞ
l
->
™ems
[
i
] =ğ
d©a
 ){

102 
l
->

 = (l->
size
+l->tail-1)%l->size;

103 
	`as£¹
Ğ
l
->

 >= 0 );

105  ; 
i
!=
l
->

; i=(i+1)%l->
size
 )

106 
l
->
™ems
[
i
] =†->™ems[(i+1)%l->
size
];

110 
	`±h»ad_mu‹x_uÆock
Ğ&
l
->
mu‹x
 );

111 
	}
}

113 * 
	$loİ_£¬ch
Ğ
loİ
* 
l
, * 
v
, 
loİ_£¬ch_func
 
£¬ch
 )

115 
i
;

116 
	`±h»ad_mu‹x_lock
Ğ&
l
->
mu‹x
 );

117  
i
=
l
->
h—d
; i!ö->

; i=(i+1)%l->
size
 )

119 ifĞ
	`£¬ch
Ğ
l
->
™ems
[
i
], 
v
 ) )

122 
	`±h»ad_mu‹x_uÆock
Ğ&
l
->
mu‹x
 );

123 ifĞ
i
 !ğ
l
->

 )

124  
l
->
™ems
[
i
];

125  
NULL
;

126 
	}
}

128 
	$loİ_ş—nup
Ğ
loİ
* 
l
 )

130 
i
;

131 
	`±h»ad_mu‹x_lock
Ğ&
l
->
mu‹x
 );

132 ifĞ
l
->
d–_func
 )

133  
i
=
l
->
h—d
; i!ö->

; i=(i+1)%l->
size
 )

134 
l
->
	`d–_func
Ğl->
™ems
[
i
] );

135 
	`ä“
Ğ
l
->
™ems
 );

136 
	`±h»ad_mu‹x_uÆock
Ğ&
l
->
mu‹x
 );

137 
	`±h»ad_mu‹x_de¡roy
Ğ&
l
->
mu‹x
 );

138 
	}
}

140 
	$loİ_is_em±y
Ğ
loİ
* 
l
 )

142 Ğ
l
->
h—d
 =ğl->

 );

143 
	}
}

	@loop.h

1 #iâdeà
_LOOP_H


2 
	#_LOOP_H


	)

4 
	~<±h»ad.h
>

6 (*
	tloİ_£¬ch_func
)(const *, const *);

7 (*
	tloİ_d–‘e_func
)(const *);

9 
	sloİ
{

10 
±h»ad_mu‹x_t
 
mu‹x
;

11 
size
;

12 
h—d
;

13 

;

14 
¡r
[5];

15 ** 
™ems
;

16 
loİ_d–‘e_func
 
d–_func
;

17 }
	tloİ
;

19 
	`loİ_ü—‹
Ğ
loİ
* 
l
, 
size
, 
loİ_d–‘e_func
 
d–
 );

20 
	`loİ_­³nd
Ğ
loİ
* 
l
, * 
d©a
 );

21 
	`loİ_r_­³nd
Ğ
loİ
* 
l
, * 
d©a
 );

22 * 
	`loİ_pİ_äom_
Ğ
loİ
* 
l
 );

23 * 
	`loİ_pİ_äom_h—d
Ğ
loİ
* 
l
 );

24 
	`loİ_push_to_h—d
Ğ
loİ
* 
l
, * 
d©a
 );

25 
	`loİ_push_to_
Ğ
loİ
* 
l
, * 
d©a
 );

26 * 
	`loİ_£¬ch
Ğ
loİ
* 
l
, *, 
loİ_£¬ch_func
 
£¬ch
 );

27 
	`loİ_ş—nup
Ğ
loİ
* 
l
 );

28 
	`loİ_is_em±y
Ğ
loİ
* 
l
 );

29 
	`loİ_»move
Ğ
loİ
* 
l
, * 
d©a
 );

	@main.cc

1 
	~"gmyqq.h
"

2 
	#USERNAME
 1147071944

	)

3 
	$maš
(
¬gc
, *
¬gv
[])

5 if(
¬gc
 == 2)

7 if(!
	`¡rcmp
(
¬gv
[1],"--nogui"))

11 if(!
	`¡rcmp
(
¬gv
[1],"--help"))

15 if(!
	`¡rcmp
(
¬gv
[1],"--test"))

18 if(!
	`¡rcmp
(
¬gv
[1],"-s"))

28 
Gtk
::
Maš
 
	`k™
(
¬gc
, 
¬gv
);

29 
gMyQQ
 
gmyqq
;

30 
k™
.
	`run
();

33 
	}
}

	@md5.c

40 
	~"md5.h
"

41 
	~<¡ršg.h
>

43 #ifdeà
TEST


49 
	~<¡ršg.h
>

50 
	$maš
()

52 cÚ¡ *cÚ¡ 
‹¡
[7] = {

62 
i
;

64 
i
 = 0; i < 7; ++i) {

65 
md5_¡©e_t
 
¡©e
;

66 
md5_by‹_t
 
dige¡
[16];

67 
di
;

69 
	`md5_š™
(&
¡©e
);

70 
	`md5_­³nd
(&
¡©e
, (cÚ¡ 
md5_by‹_t
 *)
‹¡
[
i
], 
	`¡¾’
(test[i]));

71 
	`md5_fšish
(&
¡©e
, 
dige¡
);

72 
	`´štf
("MD5 (\"%s\"èğ", 
‹¡
[
i
]);

73 
di
 = 0; di < 16; ++di)

74 
	`´štf
("%02x", 
dige¡
[
di
]);

75 
	`´štf
("\n");

78 
	}
}

86 
	~<m©h.h
>

87 
	$maš
()

89 
i
;

90 
i
 = 1; i <= 64; ++i) {

91 
v
 = ()(4294967296.0 * 
	`çbs
(
	`sš
(()
i
)));

92 
	`´štf
("#defšT%d 0x%08lx\n", 
i
, 
v
);

95 
	}
}

100 
	#T1
 0xd76¯478

	)

101 
	#T2
 0xe8c7b756

	)

102 
	#T3
 0x242070db

	)

103 
	#T4
 0xc1bdû“

	)

104 
	#T5
 0xf57c0çf

	)

105 
	#T6
 0x4787c62a

	)

106 
	#T7
 0xa8304613

	)

107 
	#T8
 0xfd469501

	)

108 
	#T9
 0x698098d8

	)

109 
	#T10
 0x8b44f7af

	)

110 
	#T11
 0xffff5bb1

	)

111 
	#T12
 0x895cd7be

	)

112 
	#T13
 0x6b901122

	)

113 
	#T14
 0xfd987193

	)

114 
	#T15
 0xa679438e

	)

115 
	#T16
 0x49b40821

	)

116 
	#T17
 0xf61e2562

	)

117 
	#T18
 0xc040b340

	)

118 
	#T19
 0x265e5a51

	)

119 
	#T20
 0xe9b6c7¯

	)

120 
	#T21
 0xd62f105d

	)

121 
	#T22
 0x02441453

	)

122 
	#T23
 0xd8a1e681

	)

123 
	#T24
 0xe7d3fbc8

	)

124 
	#T25
 0x21e1cde6

	)

125 
	#T26
 0xc33707d6

	)

126 
	#T27
 0xf4d50d87

	)

127 
	#T28
 0x455a14ed

	)

128 
	#T29
 0xa9e3e905

	)

129 
	#T30
 0xfûç3f8

	)

130 
	#T31
 0x676f02d9

	)

131 
	#T32
 0x8d2a4c8a

	)

132 
	#T33
 0xffç3942

	)

133 
	#T34
 0x8771f681

	)

134 
	#T35
 0x6d9d6122

	)

135 
	#T36
 0xfde5380c

	)

136 
	#T37
 0xa4b“a44

	)

137 
	#T38
 0x4bdecç9

	)

138 
	#T39
 0xf6bb4b60

	)

139 
	#T40
 0xbebfbc70

	)

140 
	#T41
 0x289b7ec6

	)

141 
	#T42
 0x—a127ç

	)

142 
	#T43
 0xd4ef3085

	)

143 
	#T44
 0x04881d05

	)

144 
	#T45
 0xd9d4d039

	)

145 
	#T46
 0xe6db99e5

	)

146 
	#T47
 0x1ç27cf8

	)

147 
	#T48
 0xc4ac5665

	)

148 
	#T49
 0xf4292244

	)

149 
	#T50
 0x432aff97

	)

150 
	#T51
 0xab9423a7

	)

151 
	#T52
 0xfc93a039

	)

152 
	#T53
 0x655b59c3

	)

153 
	#T54
 0x8f0ccc92

	)

154 
	#T55
 0xfãff47d

	)

155 
	#T56
 0x85845dd1

	)

156 
	#T57
 0x6ç87e4f

	)

157 
	#T58
 0xã2û6e0

	)

158 
	#T59
 0xa3014314

	)

159 
	#T60
 0x4e0811a1

	)

160 
	#T61
 0xf7537e82

	)

161 
	#T62
 0xbd3af235

	)

162 
	#T63
 0x2ad7d2bb

	)

163 
	#T64
 0xeb86d391

	)

166 
	$md5_´oûss
(
md5_¡©e_t
 *
pms
, cÚ¡ 
md5_by‹_t
 *
d©a
 )

168 
md5_wÜd_t


169 
a
 = 
pms
->
abcd
[0], 
b
 =…ms->abcd[1],

170 
c
 = 
pms
->
abcd
[2], 
d
 =…ms->abcd[3];

171 
md5_wÜd_t
 
t
;

173 #iâdeà
ARCH_IS_BIG_ENDIAN


174 
	#ARCH_IS_BIG_ENDIAN
 1

	)

176 #ià
ARCH_IS_BIG_ENDIAN


182 
md5_wÜd_t
 
X
[16];

183 cÚ¡ 
md5_by‹_t
 *
xp
 = 
d©a
;

184 
i
;

186 
i
 = 0; i < 16; ++i, 
xp
 += 4)

187 
X
[
i
] = 
xp
[0] + (xp[1] << 8) + (xp[2] << 16) + (xp[3] << 24);

195 
md5_wÜd_t
 
xbuf
[16];

196 cÚ¡ 
md5_wÜd_t
 *
X
;

198 ià(!((
d©a
 - (cÚ¡ 
md5_by‹_t
 *)0) & 3)) {

200 
X
 = (cÚ¡ 
md5_wÜd_t
 *)
d©a
;

203 
	`memıy
(
xbuf
, 
d©a
, 64);

204 
X
 = 
xbuf
;

208 
	#ROTATE_LEFT
(
x
, 
n
è(((xè<< (n)è| ((xè>> (32 - (n))))

	)

213 
	#F
(
x
, 
y
, 
z
è(((xè& (y)è| (~(xè& (z)))

	)

214 
	#SET
(
a
, 
b
, 
c
, 
d
, 
k
, 
s
, 
Ti
)\

215 
t
 = 
a
 + 
	`F
(
b
,
c
,
d
è+ 
X
[
k
] + 
Ti
;\

216 
a
 = 
	`ROTATE_LEFT
(
t
, 
s
è+ 
b


	)

218 
	`SET
(
a
, 
b
, 
c
, 
d
, 0, 7, 
T1
);

219 
	`SET
(
d
, 
a
, 
b
, 
c
, 1, 12, 
T2
);

220 
	`SET
(
c
, 
d
, 
a
, 
b
, 2, 17, 
T3
);

221 
	`SET
(
b
, 
c
, 
d
, 
a
, 3, 22, 
T4
);

222 
	`SET
(
a
, 
b
, 
c
, 
d
, 4, 7, 
T5
);

223 
	`SET
(
d
, 
a
, 
b
, 
c
, 5, 12, 
T6
);

224 
	`SET
(
c
, 
d
, 
a
, 
b
, 6, 17, 
T7
);

225 
	`SET
(
b
, 
c
, 
d
, 
a
, 7, 22, 
T8
);

226 
	`SET
(
a
, 
b
, 
c
, 
d
, 8, 7, 
T9
);

227 
	`SET
(
d
, 
a
, 
b
, 
c
, 9, 12, 
T10
);

228 
	`SET
(
c
, 
d
, 
a
, 
b
, 10, 17, 
T11
);

229 
	`SET
(
b
, 
c
, 
d
, 
a
, 11, 22, 
T12
);

230 
	`SET
(
a
, 
b
, 
c
, 
d
, 12, 7, 
T13
);

231 
	`SET
(
d
, 
a
, 
b
, 
c
, 13, 12, 
T14
);

232 
	`SET
(
c
, 
d
, 
a
, 
b
, 14, 17, 
T15
);

233 
	`SET
(
b
, 
c
, 
d
, 
a
, 15, 22, 
T16
);

234 #undeà
SET


239 
	#G
(
x
, 
y
, 
z
è(((xè& (z)è| ((yè& ~(z)))

	)

240 
	#SET
(
a
, 
b
, 
c
, 
d
, 
k
, 
s
, 
Ti
)\

241 
t
 = 
a
 + 
	`G
(
b
,
c
,
d
è+ 
X
[
k
] + 
Ti
;\

242 
a
 = 
	`ROTATE_LEFT
(
t
, 
s
è+ 
b


	)

244 
	`SET
(
a
, 
b
, 
c
, 
d
, 1, 5, 
T17
);

245 
	`SET
(
d
, 
a
, 
b
, 
c
, 6, 9, 
T18
);

246 
	`SET
(
c
, 
d
, 
a
, 
b
, 11, 14, 
T19
);

247 
	`SET
(
b
, 
c
, 
d
, 
a
, 0, 20, 
T20
);

248 
	`SET
(
a
, 
b
, 
c
, 
d
, 5, 5, 
T21
);

249 
	`SET
(
d
, 
a
, 
b
, 
c
, 10, 9, 
T22
);

250 
	`SET
(
c
, 
d
, 
a
, 
b
, 15, 14, 
T23
);

251 
	`SET
(
b
, 
c
, 
d
, 
a
, 4, 20, 
T24
);

252 
	`SET
(
a
, 
b
, 
c
, 
d
, 9, 5, 
T25
);

253 
	`SET
(
d
, 
a
, 
b
, 
c
, 14, 9, 
T26
);

254 
	`SET
(
c
, 
d
, 
a
, 
b
, 3, 14, 
T27
);

255 
	`SET
(
b
, 
c
, 
d
, 
a
, 8, 20, 
T28
);

256 
	`SET
(
a
, 
b
, 
c
, 
d
, 13, 5, 
T29
);

257 
	`SET
(
d
, 
a
, 
b
, 
c
, 2, 9, 
T30
);

258 
	`SET
(
c
, 
d
, 
a
, 
b
, 7, 14, 
T31
);

259 
	`SET
(
b
, 
c
, 
d
, 
a
, 12, 20, 
T32
);

260 #undeà
SET


265 
	#H
(
x
, 
y
, 
z
è((xè^ (yè^ (z))

	)

266 
	#SET
(
a
, 
b
, 
c
, 
d
, 
k
, 
s
, 
Ti
)\

267 
t
 = 
a
 + 
	`H
(
b
,
c
,
d
è+ 
X
[
k
] + 
Ti
;\

268 
a
 = 
	`ROTATE_LEFT
(
t
, 
s
è+ 
b


	)

270 
	`SET
(
a
, 
b
, 
c
, 
d
, 5, 4, 
T33
);

271 
	`SET
(
d
, 
a
, 
b
, 
c
, 8, 11, 
T34
);

272 
	`SET
(
c
, 
d
, 
a
, 
b
, 11, 16, 
T35
);

273 
	`SET
(
b
, 
c
, 
d
, 
a
, 14, 23, 
T36
);

274 
	`SET
(
a
, 
b
, 
c
, 
d
, 1, 4, 
T37
);

275 
	`SET
(
d
, 
a
, 
b
, 
c
, 4, 11, 
T38
);

276 
	`SET
(
c
, 
d
, 
a
, 
b
, 7, 16, 
T39
);

277 
	`SET
(
b
, 
c
, 
d
, 
a
, 10, 23, 
T40
);

278 
	`SET
(
a
, 
b
, 
c
, 
d
, 13, 4, 
T41
);

279 
	`SET
(
d
, 
a
, 
b
, 
c
, 0, 11, 
T42
);

280 
	`SET
(
c
, 
d
, 
a
, 
b
, 3, 16, 
T43
);

281 
	`SET
(
b
, 
c
, 
d
, 
a
, 6, 23, 
T44
);

282 
	`SET
(
a
, 
b
, 
c
, 
d
, 9, 4, 
T45
);

283 
	`SET
(
d
, 
a
, 
b
, 
c
, 12, 11, 
T46
);

284 
	`SET
(
c
, 
d
, 
a
, 
b
, 15, 16, 
T47
);

285 
	`SET
(
b
, 
c
, 
d
, 
a
, 2, 23, 
T48
);

286 #undeà
SET


291 
	#I
(
x
, 
y
, 
z
è((yè^ ((xè| ~(z)))

	)

292 
	#SET
(
a
, 
b
, 
c
, 
d
, 
k
, 
s
, 
Ti
)\

293 
t
 = 
a
 + 
	`I
(
b
,
c
,
d
è+ 
X
[
k
] + 
Ti
;\

294 
a
 = 
	`ROTATE_LEFT
(
t
, 
s
è+ 
b


	)

296 
	`SET
(
a
, 
b
, 
c
, 
d
, 0, 6, 
T49
);

297 
	`SET
(
d
, 
a
, 
b
, 
c
, 7, 10, 
T50
);

298 
	`SET
(
c
, 
d
, 
a
, 
b
, 14, 15, 
T51
);

299 
	`SET
(
b
, 
c
, 
d
, 
a
, 5, 21, 
T52
);

300 
	`SET
(
a
, 
b
, 
c
, 
d
, 12, 6, 
T53
);

301 
	`SET
(
d
, 
a
, 
b
, 
c
, 3, 10, 
T54
);

302 
	`SET
(
c
, 
d
, 
a
, 
b
, 10, 15, 
T55
);

303 
	`SET
(
b
, 
c
, 
d
, 
a
, 1, 21, 
T56
);

304 
	`SET
(
a
, 
b
, 
c
, 
d
, 8, 6, 
T57
);

305 
	`SET
(
d
, 
a
, 
b
, 
c
, 15, 10, 
T58
);

306 
	`SET
(
c
, 
d
, 
a
, 
b
, 6, 15, 
T59
);

307 
	`SET
(
b
, 
c
, 
d
, 
a
, 13, 21, 
T60
);

308 
	`SET
(
a
, 
b
, 
c
, 
d
, 4, 6, 
T61
);

309 
	`SET
(
d
, 
a
, 
b
, 
c
, 11, 10, 
T62
);

310 
	`SET
(
c
, 
d
, 
a
, 
b
, 2, 15, 
T63
);

311 
	`SET
(
b
, 
c
, 
d
, 
a
, 9, 21, 
T64
);

312 #undeà
SET


317 
pms
->
abcd
[0] +ğ
a
;

318 
pms
->
abcd
[1] +ğ
b
;

319 
pms
->
abcd
[2] +ğ
c
;

320 
pms
->
abcd
[3] +ğ
d
;

321 
	}
}

324 
	$md5_š™
(
md5_¡©e_t
 *
pms
)

326 
pms
->
couÁ
[0] =…ms->count[1] = 0;

327 
pms
->
abcd
[0] = 0x67452301;

328 
pms
->
abcd
[1] = 0xefcdab89;

329 
pms
->
abcd
[2] = 0x98badcfe;

330 
pms
->
abcd
[3] = 0x10325476;

331 
	}
}

334 
	$md5_­³nd
(
md5_¡©e_t
 *
pms
, cÚ¡ 
md5_by‹_t
 *
d©a
, 
nby‹s
)

336 cÚ¡ 
md5_by‹_t
 *
p
 = 
d©a
;

337 
Ëá
 = 
nby‹s
;

338 
off£t
 = (
pms
->
couÁ
[0] >> 3) & 63;

339 
md5_wÜd_t
 
nb™s
 = (md5_wÜd_t)(
nby‹s
 << 3);

341 ià(
nby‹s
 <= 0)

345 
pms
->
couÁ
[1] +ğ
nby‹s
 >> 29;

346 
pms
->
couÁ
[0] +ğ
nb™s
;

347 ià(
pms
->
couÁ
[0] < 
nb™s
)

348 
pms
->
couÁ
[1]++;

351 ià(
off£t
) {

352 
cİy
 = (
off£t
 + 
nby‹s
 > 64 ? 64 - offset :‚bytes);

354 
	`memıy
(
pms
->
buf
 + 
off£t
, 
p
, 
cİy
);

355 ià(
off£t
 + 
cİy
 < 64)

357 
p
 +ğ
cİy
;

358 
Ëá
 -ğ
cİy
;

359 
	`md5_´oûss
(
pms
,…ms->
buf
);

363 ; 
Ëá
 >ğ64; 
p
 += 64,†eft -= 64)

364 
	`md5_´oûss
(
pms
, 
p
);

367 ià(
Ëá
)

368 
	`memıy
(
pms
->
buf
, 
p
, 
Ëá
);

369 
	}
}

372 
	$md5_fšish
(
md5_¡©e_t
 *
pms
, 
md5_by‹_t
 
dige¡
[16])

374 cÚ¡ 
md5_by‹_t
 
·d
[64] = {

380 
md5_by‹_t
 
d©a
[8];

381 
i
;

384 
i
 = 0; i < 8; ++i)

385 
d©a
[
i
] = (
md5_by‹_t
)(
pms
->
couÁ
[i >> 2] >> ((i & 3) << 3));

387 
	`md5_­³nd
(
pms
, 
·d
, ((55 - (pms->
couÁ
[0] >> 3)) & 63) + 1);

389 
	`md5_­³nd
(
pms
, 
d©a
, 8);

390 
i
 = 0; i < 16; ++i)

391 
dige¡
[
i
] = (
md5_by‹_t
)(
pms
->
abcd
[i >> 2] >> ((i & 3) << 3));

392 
	}
}

	@md5.h

42 #iâdeà
md5_INCLUDED


43 
	#md5_INCLUDED


	)

53 
	tmd5_by‹_t
;

54 
	tmd5_wÜd_t
;

57 
	smd5_¡©e_s
 {

58 
md5_wÜd_t
 
	mcouÁ
[2];

59 
md5_wÜd_t
 
	mabcd
[4];

60 
md5_by‹_t
 
	mbuf
[64];

61 } 
	tmd5_¡©e_t
;

63 #ifdeà
__ılu¥lus


69 #ifdeà
P1


70 
md5_š™
(
P1
(
md5_¡©e_t
 *
pms
));

72 
md5_š™
(
md5_¡©e_t
 *
pms
);

76 #ifdeà
P3


77 
md5_­³nd
(
P3
(
md5_¡©e_t
 *
pms
, cÚ¡ 
md5_by‹_t
 *
d©a
, 
nby‹s
));

79 
md5_­³nd
(
md5_¡©e_t
 *
pms
, cÚ¡ 
md5_by‹_t
 *
d©a
, 
nby‹s
);

83 #ifdeà
P2


84 
md5_fšish
(
P2
(
md5_¡©e_t
 *
pms
, 
md5_by‹_t
 
dige¡
[16]));

86 
md5_fšish
(
md5_¡©e_t
 *
pms
, 
md5_by‹_t
 
dige¡
[16]);

89 #ifdeà
__ılu¥lus


	@memory.c

15 
	~<¡dio.h
>

16 
	~<¡ršg.h
>

17 
	~<¡dlib.h
>

18 
	~<time.h
>

20 
	~"debug.h
"

21 
	~"memÜy.h
"

23 
mem_d‘a
* 
	gg_md
;

25 
	$memÜy_š™
()

27 ifĞ!
g_md
 ){

28 
g_md
 = (
mem_d‘a
*)
	`m®loc
((mem_detail));

29 
	`mem£t
Ğ
g_md
, 0, (
mem_d‘a
) );

30 
	`±h»ad_mu‹x_š™
Ğ&
g_md
->
mu‹x_mem
, 
NULL
 );

32 
	}
}

34 
	$memÜy_Ãw_d‘a
Ğ** 
p
, 
size
, * 
fe
, * 
funùiÚ
, 
lše
, * 
Çme
 )

36 
‹mp
[128];

37 
	`¥rštf
Ğ
‹mp
, "[%s]%s(%dè%s", 
fe
, 
funùiÚ
, 
lše
, 
Çme
 );

38 
	`memÜy_Ãw
Ğ
p
, 
size
, 
‹mp
 );

39 
	}
}

41 
	$memÜy_Ãw
Ğ** 
p
, 
size
, * 
memo
 )

43 ifĞ!
g_md
 )

44 
	`memÜy_š™
();

45 *
p
 = 
NULL
;

46 ifĞ
g_md
->
™em_couÁ
 >ğ
MAX_ALLOCATION
 )

48 
	`DBG
("no more‡llocations."); ;

50 *
p
 = 
	`m®loc
(
size
);

51 
	`mem£t
Ğ*
p
, 0, 
size
 );

52 ifĞ*
p
 =ğ
NULL
 ){

53 
	`DBG
("noƒnough memory.");

54 
	`ex™
(-1);

56 
	`±h»ad_mu‹x_lock
Ğ&
g_md
->
mu‹x_mem
 );

57 
i
 = 
g_md
->
™em_couÁ
 ++;

58 
g_md
->
™ems
[
i
] = (
®loÿtiÚ
*)
	`m®loc
((allocation));

60 
g_md
->
™ems
[
i
]->
poš‹r
 = *
p
;

61 
g_md
->
™ems
[
i
]->
size
 = size;

62 
	`¡ºıy
Ğ
g_md
->
™ems
[
i
]->
memo
, memo, 
MEMO_LEN
 );

63 
g_md
->
™ems
[
i
]->
time_®loc
 = 
	`time
Ğ
NULL
 );

64 
	`±h»ad_mu‹x_uÆock
Ğ&
g_md
->
mu‹x_mem
 );

66 
	}
}

69 
	$memÜy_d–‘e
Ğ* 
p
 )

71 
i
;

72 ifĞ
p
 =ğ
NULL
 ) ;

73 
	`±h»ad_mu‹x_lock
Ğ&
g_md
->
mu‹x_mem
 );

74  
i
=0; i<
g_md
->
™em_couÁ
; i++ )

76 ifĞ
g_md
->
™ems
[
i
]->
poš‹r
 =ğ
p
 )

78 
	`ä“
Ğ
p
 );

79 
	`ä“
Ğ
g_md
->
™ems
[
i
] );

80 
g_md
->
™em_couÁ
 --;

81 ifĞ
i
!=
g_md
->
™em_couÁ
 )

82 
g_md
->
™ems
[
i
] = g_md->™ems[g_md->
™em_couÁ
];

83 
g_md
->
™ems
[g_md->
™em_couÁ
] = 
NULL
;

84 
	`±h»ad_mu‹x_uÆock
Ğ&
g_md
->
mu‹x_mem
 );

88 
	`DBG
("nÙ found…oš‹¸%x", 
p
 );

89 
	`±h»ad_mu‹x_uÆock
Ğ&
g_md
->
mu‹x_mem
 );

90 
	}
}

92 
	$memÜy_’d
(){

93 ifĞ!
g_md
 ) ;

94 
	`DBG
("g_md->™em_couÁ = %d", 
g_md
->
™em_couÁ
 );

95 ifĞ
g_md
->
™em_couÁ
>0 ){

96 
	`memÜy_´št
();

98 
	`±h»ad_mu‹x_de¡roy
Ğ&
g_md
->
mu‹x_mem
 );

99 
	}
}

101 
	$memÜy_´št
(){

102 ifĞ!
g_md
 ) ;

103 
	`DBG
("#memÜy infØdumpšg (™em_couÁ: %dè", 
g_md
->
™em_couÁ
 );

104 
i
;

105 
	`±h»ad_mu‹x_lock
Ğ&
g_md
->
mu‹x_mem
 );

106  
i
=0; i<
g_md
->
™em_couÁ
; i++ )

108 
time¡r
[10];

109 
tm
* 
t
 = 
	`loÿÉime
Ğ& 
g_md
->
™ems
[
i
]->
time_®loc
);

110 
	`¡ráime
Ğ
time¡r
, 10, "%X", 
t
 );

111 
	`DBG
("[%d] 0x%x(%d)\t%s\t%s", 
i
, 
g_md
->
™ems
[i]->
poš‹r
, g_md->™ems[i]->
size
,

112 
g_md
->
™ems
[
i
]->
memo
, 
time¡r
 );

114 
	`±h»ad_mu‹x_uÆock
Ğ&
g_md
->
mu‹x_mem
 );

115 
	}
}

	@memory.h

1 #iâdeà
_MEMORY_H


2 
	#_MEMORY_H


	)

4 
	~<time.h
>

5 
	~<±h»ad.h
>

7 
	#MEMO_LEN
 64

	)

8 
	#MAX_ALLOCATION
 4096

	)

10 
	s®loÿtiÚ
{

11 * 
	mpoš‹r
;

12 
time_t
 
	mtime_®loc
;

13 
	msize
;

14 
	mmemo
[
MEMO_LEN
];

15 }
	t®loÿtiÚ
;

17 
	smem_d‘a
{

18 
	m™em_couÁ
;

19 
®loÿtiÚ
* 
	m™ems
[
MAX_ALLOCATION
];

20 
±h»ad_mu‹x_t
 
	mmu‹x_mem
;

21 }
	tmem_d‘a
;

25 
	#NEW
Ğ
p
, 
size
 ,
ty³
è{… =Ñy³*è
	`m®loc
(size); 
	`mem£t
Ğp, 0, siz); }

	)

26 
	#DEL
Ğ
p
 ) { 
	`ä“
((*í);… = 
NULL
; }

	)

34 
memÜy_š™
();

35 
memÜy_Ãw
Ğ** 
p
, 
size
, * 
memo
 );

36 
memÜy_Ãw_d‘a
Ğ** 
p
, 
size
, * 
fe
, * 
funùiÚ
, 
lše
, * 
Çme
 );

37 
memÜy_d–‘e
Ğ* 
p
 );

38 
memÜy_’d
();

39 
memÜy_´št
();

	@myqq.h

20 
	~<¡dio.h
>

21 
	~<ùy³.h
>

22 
	~<¡ršg.h
>

23 
	~<time.h
>

24 
	~<¡dlib.h
>

25 
	~<uni¡d.h
>

26 #ifdeà
__WIN32__


27 
	~<cÚio.h
>

28 
	~<wšsock.h
>

29 
	~<wšš‘.h
>

30 
	~<wšdows.h
>

32 
	~<‹rmios.h
>

33 
	~<sys/sock‘.h
>

34 
	~<¬·/š‘.h
>

35 
	~<Ãtdb.h
>

37 
	~"qqş›Á.h
"

38 
	~"buddy.h
"

39 
	~"qun.h
"

40 
	~"group.h
"

41 
	~"memÜy.h
"

42 
	~"utf8.h
"

43 
	~"cÚfig.h
"

44 
	~"qqsock‘.h
"

47 
	#MSG
 
Ãed_»£t
 = 1; 
	`£tcŞÜ
Ğ
cŞÜ_šdex
 ); 
´štf


	)

49 
	#QUN_BUF_SIZE
 80*100

	)

50 
	#BUDDY_BUF_SIZE
 80*500

	)

51 
	#PRINT_BUF_SIZE
 80*500*3

	)

54 * 
	gqun_buf
, *
	gbuddy_buf
, *
	g´št_buf
;

55 
ušt
 
	gto_uid
 = 0;

56 
ušt
 
	gqun_št_uid
;

57 
	gšput
[1024];

58 
	g’‹r
 = 0;

59 
qqş›Á
* 
	gqq
;

60 
	gÃed_»£t
;

63 
	mCMD_EXIT
 = 0, 
	mCMD_EXIT2
,

64 
	mCMD_SAY
, 
	mCMD_SAY2
,

65 
	mCMD_TO
, 
	mCMD_TO2
,

66 
	mCMD_HELP
,

67 
	mCMD_STATUS
,

68 
	mCMD_ENTER
, 
	mCMD_ENTER2
,

69 
	mCMD_LEAVE
, 
	mCMD_LEAVE2
,

70 
	mCMD_WHO
, 
	mCMD_WHO2
,

71 
	mCMD_VIEW
, 
	mCMD_VIEW2
,

72 
	mCMD_QUN
, 
	mCMD_QUN2
,

73 
	mCMD_INFO
, 
	mCMD_INFO2
,

74 
	mCMD_UPDATE
, 
	mCMD_UPDATE2
,

75 
	mCMD_CHANGE
, 
	mCMD_CHANGE2
,

76 
	mCMD_TEST
,

77 
	mCMD_VERIFY
, 
	mCMD_VERIFY2
,

78 
	mCMD_ADD
, 
	mCMD_ADD2
,

79 
	mCMD_DEL


81 
	gcommªds
[][16]=

102 
	gh–p_msg
[]=

123 #ifdeà
__WIN32__


124 
	#CCOL_GREEN
 
FOREGROUND_GREEN


	)

125 
	#CCOL_LIGHTBLUE
 
FOREGROUND_BLUE
 | 
FOREGROUND_GREEN


	)

126 
	#CCOL_REDGREEN
 
FOREGROUND_RED
 | 
FOREGROUND_GREEN


	)

127 
	#CCOL_NONE
 
FOREGROUND_RED
 | 
FOREGROUND_GREEN
 | 
FOREGROUND_BLUE


	)

128 
	gcŞÜ_šdex
 = 
CCOL_NONE
;

129 
	$ch¬cŞÜ
Ğ
cŞ
 )

131 
cŞÜ_šdex
 = 
cŞ
;

132 
	}
}

133 
	$£tcŞÜ
Ğ
cŞ
 )

135 
	`S‘CÚsŞeTextA‰ribu‹
(
	`G‘StdHªdË
(
STD_OUTPUT_HANDLE
),
FOREGROUND_INTENSITY
 | 
cŞ
);

136 
	}
}

139 
	#CCOL_NONE
 "\033[0m"

	)

140 
	#CCOL_BLACK
 "\033[0;30m"

	)

141 
	#CCOL_DARKGRAY
 "\033[1;30m"

	)

142 
	#CCOL_BLUE
 "\033[0;34m"

	)

143 
	#CCOL_LIGHTBLUE
 "\033[1;34m"

	)

144 
	#CCOL_GREEN
 "\033[0;32m"

	)

145 
	#CCOL_LIGHTGREEN
 "\033[1;32m"

	)

146 
	#CCOL_CYAN
 "\033[0;36m"

	)

147 
	#CCOL_LIGHTCYAN
 "\033[1;36m"

	)

148 
	#CCOL_RED
 "\033[0;31m"

	)

149 
	#CCOL_LIGHTRED
 "\033[1;31m"

	)

150 
	#CCOL_PURPLE
 "\033[0;35m"

	)

151 
	#CCOL_LIGHTPURPLE
 "\033[1;35m"

	)

152 
	#CCOL_LIGHTBROWN
 "\033[0;33m"

	)

153 
	#CCOL_YELLOW
 "\033[1;33m"

	)

154 
	#CCOL_LIGHTGRAY
 "\033[0;37m"

	)

155 
	#CCOL_WHITE
 "\033[1;37m"

	)

156 
	#CCOL_REDGREEN
 
CCOL_YELLOW


	)

158 cÚ¡ * 
	gcŞÜ_šdex
 = 
CCOL_NONE
;

159 
	$ch¬cŞÜ
ĞcÚ¡ * 
cŞ
 )

161 
cŞÜ_šdex
 = (*)
cŞ
;

162 
	}
}

163 
	$£tcŞÜ
ĞcÚ¡ * 
cŞ
 )

165 
	`´štf
("%s", 
cŞ
 );

166 
	}
}

171 
	#RESET_INPUT
 \

172 ifĞ
Ãed_»£t
 )\

173 { 
	`ch¬cŞÜ
Ğ
CCOL_NONE
 );\

174 ifĞ
’‹r
 ){ \

175 
	`MSG
("IÀ{%s}> ", 
	`_TEXT
Ğ
	`myqq_g‘_qun_Çme
Ğ
qq
, 
qun_št_uid
 ) ) ); \

177 
	`MSG
("TØ[%s]> ", 
	`_TEXT
Ğ
	`myqq_g‘_buddy_Çme
Ğ
qq
, 
to_uid
 ) ) );} \

178 
	`fæush
Ğ
¡dout
 ); \

179 
Ãed_»£t
 = 0;\

180 }

	)

183 #ifdeà
__WIN32__


184 
	#_TEXT
 
to_gb_fÜû


	)

185 * 
	$to_gb_fÜû
Ğ* 
s
 )

188 
	`utf8_to_gb
Ğ
s
, 
´št_buf
, 
PRINT_BUF_SIZE
-1 );

189  
´št_buf
;

190 
	}
}

191 * 
	$to_utf8
Ğ* 
s
 )

194 
	`gb_to_utf8
Ğ
s
, 
´št_buf
, 
PRINT_BUF_SIZE
-1 );

195  
´št_buf
;

196 
	}
}

199 
	#_TEXT


	)

206 
	$_g‘lše
(*
s
, 
lim
)

208 *
t
;

209 
c
;

211 
t
 = 
s
;

212 --
lim
>1 && (
c
=
	`g‘ch¬
()è!ğ
EOF
 && c != '\n')

213 *
s
++ = 
c
;

214 *
s
 = '\0';

215  
s
 - 
t
;

216 
	}
}

219 cÚ¡ * 
	$mode_¡ršg
Ğ
mode
 )

221  
mode
 )

223 
QQ_ONLINE
:

225 
QQ_AWAY
:

227 
QQ_BUSY
:

229 
QQ_OFFLINE
:

231 
QQ_HIDDEN
:

233 
QQ_KILLME
:

235 
QQ_QUIET
:

239 
	}
}

240 * 
	$sk_lše
Ğ* 
p
, 
Ê
 )

242  *
p
 && 
Ê
-- )

244 
p
 ++;

245  *
p
 && *p!='\n' )…++;

247  
p
;

248 
	}
}

250 cÚ¡ * 
	$myqq_g‘_buddy_Çme
Ğ
qqş›Á
* 
qq
, 
ušt
 
uid
 )

252 
tmp
[16];

253 
qqbuddy
* 
b
 = 
	`buddy_g‘
Ğ
qq
, 
uid
, 0 );

254 ifĞ
b
 )

255  
b
->
nickÇme
;

256 ifĞ
uid
 == 10000 )

258 ifĞ
uid
 != 0 )

260 
	`¥rštf
Ğ
tmp
, "%u" , 
uid
 );

261  
tmp
;

264 
	}
}

265 cÚ¡ * 
	$myqq_g‘_qun_Çme
Ğ
qqş›Á
* 
qq
, 
ušt
 
uid
 )

267 
tmp
[16];

268 
qqqun
* 
q
 = 
	`qun_g‘
Ğ
qq
, 
uid
, 0 );

269 ifĞ
q
 )

270  
q
->
Çme
;

271 ifĞ
uid
 != 0 )

273 
	`¥rštf
Ğ
tmp
, "%u" , 
uid
 );

274  
tmp
;

277 
	}
}

278 cÚ¡ * 
	$myqq_g‘_qun_memb”_Çme
Ğ
qqş›Á
* 
qq
, 
ušt
 
št_uid
, ušˆ
uid
 )

280 
tmp
[16];

281 
qqqun
* 
q
 = 
	`qun_g‘
Ğ
qq
, 
št_uid
, 0 );

282 ifĞ
q
 )

284 
qunmemb”
* 
m
 = 
	`qun_memb”_g‘
Ğ
qq
, 
q
, 
uid
, 0 );

285 ifĞ
m
 )

286  
m
->
nickÇme
;

287 ifĞ
uid
 != 0 )

289 
	`¥rštf
Ğ
tmp
, "%u" , 
uid
 );

290  
tmp
;

295 
	}
}

296 
	$myqq_£nd_im_to_qun
Ğ
qqş›Á
* 
qq
, 
ušt
 
št_uid
, * 
msg
, 
wa™
 )

298 
	`qun_£nd_mes§ge
Ğ
qq
, 
št_uid
, 
msg
 );

299 ifĞ
wa™
 )

301 ifĞ
	`qqş›Á_wa™
Ğ
qq
, 15 ) < 0 )

305 
	}
}

306 
	$myqq_£nd_im_to_buddy
Ğ
qqş›Á
* 
qq
, 
ušt
 
št_uid
, * 
msg
, 
wa™
 )

308 
	`buddy_£nd_mes§ge
Ğ
qq
, 
št_uid
, 
msg
 );

309 ifĞ
wa™
 )

311 ifĞ
	`qqş›Á_wa™
Ğ
qq
, 15 ) < 0 )

315 
	}
}

316 
	$myqq_g‘_buddy_šfo
Ğ
qqş›Á
* 
qq
, 
ušt
 
uid
, * 
buf
, 
size
 )

318 
qqbuddy
 *
b
 = 
	`buddy_g‘
Ğ
qq
, 
uid
, 0 );

319 ifĞ
size
 < 256 )

321 ifĞ
b
 =ğ
NULL
 )

323 
Ën
, 

 = 
	`htÚl
(
b
->ip);

324 
Ën
 = 
	`¥rštf
Ğ
buf
, "å¥½å‹æ˜µç§°\t%-32s\n"

332 
b
->
nickÇme
, b->
numb”
, 
	`š‘_Áß
Ğ*(
š_addr
*)&

 ), b->
pÜt
, b->
çû
, b->
age
,

333 (
b
->
£x
==0x00)?"M®e": (b->£x==0x01)?"Fem®e":"A£xu®", 
	`mode_¡ršg
(b->
¡©us
) );

334  
Ën
;

335 
	}
}

340 * 
	$ut_esÿ³
Ğ* 
¡r
 )

342 * 
ch
;

343 
ch
 = (*)
¡r
;

344  *
ch
 )

346 ifĞ*
ch
 < 0x80 )

348 ifĞ!
	`i¥ršt
(*
ch
) )

349 *
ch
 = ' ';

350 
ch
 ++;

354 
ch
 +=2;

357  
¡r
;

358 
	}
}

366 
	$myqq_g‘_buddy_li¡
Ğ
qqş›Á
* 
qq
, * 
buf
, 
size
, 
Úlše
 )

368 
i
, 
Ën
 = 0;

370 
buf
[0] = 0;

371 
	`±h»ad_mu‹x_lock
Ğ&
qq
->
buddy_li¡
.
mu‹x
 );

372 
Ê
 = 1;

373  
i
=0; i<
qq
->
buddy_li¡
.
couÁ
; i++ )

375 
qqbuddy
 * 
b
 = (qqbuddy*)
qq
->
buddy_li¡
.
™ems
[
i
];

376 ifĞ
Úlše
 && 
b
->
¡©us
 =ğ
QQ_OFFLINE
 ) ;

377 
Ën
 = 
	`¥rštf
Ğ
buf
, "%s%-8d%-16d%-16s%-16.64s\n", buf, 
Ê
 ++, 
b
->
numb”
,

378 
	`mode_¡ršg
Ğ(è
b
->
¡©us
 ), 
	`ut_esÿ³
Ğb->
nickÇme
 ) );

379 ifĞ
Ën
 + 80 > 
size
 ) ;

381 
	`±h»ad_mu‹x_uÆock
Ğ&
qq
->
buddy_li¡
.
mu‹x
 );

382  
Ën
;

383 
	}
}

391 
	$myqq_g‘_qun_li¡
Ğ
qqş›Á
* 
qq
, * 
buf
, 
size
 )

393 
i
, 
Ën
 = 0, 
Ê
=1;

395 
buf
[0] = 0;

396 
	`±h»ad_mu‹x_lock
Ğ&
qq
->
qun_li¡
.
mu‹x
 );

397  
i
=0; i<
qq
->
qun_li¡
.
couÁ
; i++ )

399 
qqqun
 * 
q
 = (qqquÀ*)
qq
->
qun_li¡
.
™ems
[
i
];

400 
Ën
 = 
	`¥rštf
Ğ
buf
, "%s%-8d%-16d%-16d%-16.64s\n", buf, 
Ê
 ++, 
q
->
numb”
,

401 
q
->
ext_numb”
, 
	`ut_esÿ³
Ğq->
Çme
 ) );

402 ifĞ
Ën
 + 80 > 
size
 ) ;

404 
	`±h»ad_mu‹x_uÆock
Ğ&
qq
->
qun_li¡
.
mu‹x
 );

405  
Ën
;

406 
	}
}

414 
	$myqq_g‘_qun_memb”_li¡
Ğ
qqş›Á
* 
qq
, 
ušt
 
št_uid
, * 
buf
, 
size
, 
Úlše
 )

416 
qqqun
 * 
q
 = 
	`qun_g‘
Ğ
qq
, 
št_uid
, 0 );

417 ifĞ!
q
 ) 0;

419 
i
, 
Ën
 = 0, 
Ê
 = 1;

420 
buf
[0] = 0;

421 
	`±h»ad_mu‹x_lock
Ğ&
q
->
memb”_li¡
.
mu‹x
 );

422  
i
=0; i<
q
->
memb”_li¡
.
couÁ
; i++ )

424 
qunmemb”
 * 
m
 = (qunmemb” *)
q
->
memb”_li¡
.
™ems
[
i
];

425 ifĞ
Úlše
 && 
m
->
¡©us
 =ğ
QQ_OFFLINE
 ) ;

426 
Ën
 = 
	`¥rštf
Ğ
buf
, "%s%-8d%-16d%-16s%-16.64s\n", buf, 
Ê
++, 
m
->
numb”
,

427 (
m
->
rŞe
&1)?"Admš":"F–low", 
	`ut_esÿ³
Ğm->
nickÇme
 ) );

428 ifĞ
Ën
 + 80 > 
size
 )

431 
	`±h»ad_mu‹x_uÆock
Ğ&
q
->
memb”_li¡
.
mu‹x
 );

432  
Ën
;

433 
	}
}

438 
	$myqq_g‘_qun_šfo
Ğ
qqş›Á
* 
qq
, 
ušt
 
št_uid
, * 
buf
, 
size
 )

441 
ÿ‹_¡r
[4][10] = {"Classmate", "Friend", "Workmate", "Other" };

442 
qqqun
 *
q
 = 
	`qun_g‘
Ğ
qq
, 
št_uid
, 0 );

443 ifĞ!
q
 ) 0;

444 
Ën
;

445 ifĞ
size
 < 256 )

448 ifĞ
q
 =ğ
NULL
 )

450 
Ën
 = 
	`¥rštf
Ğ
buf
, "åç§°\t\t%-32s\n"

460 
q
->
Çme
, q->
numb”
, q->
ext_numb”
, (q->
ty³
==0x01)?"Normal":"Special",

461 (
q
->
auth_ty³
==0x01)?"No": (q->auth_type==0x02)?"Yes":

462 (
q
->
auth_ty³
==0x03)?"RejectAll":"Unknown",

463 
q
->
ÿ‹gÜy
 > 3 ? 
ÿ‹_¡r
[3] : cate_str[()q->category],

464 
q
->
owÃr
, q->
memb”_li¡
.
couÁ
, q->
šŒo
, q->
ªn
 );

465  
Ën
;

466 
	}
}

469 
	$buddy_msg_ÿÎback
 ( 
qqş›Á
* 
qq
, 
ušt
 
uid
, 
time_t
 
t
, * 
msg
 )

471 
	`ch¬cŞÜ
Ğ
CCOL_LIGHTBLUE
 );

472 
time¡r
[12];

473 
msg¡r
[64];

474 
tm
 * 
timešfo
;

476 cÚ¡ * 
nick
 = 
	`myqq_g‘_buddy_Çme
Ğ
qq
, 
uid
 );

477 
timešfo
 = 
	`loÿÉime
 ( &
t
 );

478 
	`¡ráime
Ğ
time¡r
, 12, "%H:%M:%S", 
timešfo
 );

479 
tmp
[20], *
p
;

480 
	`¥rštf
Ğ
tmp
, "%-16d", 
uid
 );

481 
p
 = 
	`¡r¡r
Ğ
buddy_buf
, 
tmp
 );

482 ifĞ
p
 )

484 
p
 -= 8;

485 ifĞ
p
>=
buddy_buf
 )

487 
Ê
;

488 
	`ssÿnf
Ğ
p
, "%d", &
Ê
 );

489 
	`¥rštf
Ğ
msg¡r
, "\n%d)%s[", 
Ê
, 
time¡r
 );

490 
	`¡rÿt
Ğ
msg¡r
, 
nick
 );

491 
	`¡rÿt
Ğ
msg¡r
, "]\n\t" );

492 
	`MSG
("%s", 
	`_TEXT
Ğ
msg¡r
 ) );

493 
	`puts
Ğ
	`_TEXT
Ğ
msg
 ) );

494 
RESET_INPUT


499 
	`¥rštf
Ğ
msg¡r
, "\n%s[", 
time¡r
 );

500 
	`¡rÿt
Ğ
msg¡r
, 
nick
 );

501 
	`¡rÿt
Ğ
msg¡r
, "]\n\t" );

502 
	`MSG
("%s", 
	`_TEXT
Ğ
msg¡r
 ) );

503 
	`puts
Ğ
	`_TEXT
Ğ
msg
 ) );

504 
RESET_INPUT


506 
	}
}

509 
	$qun_msg_ÿÎback
 ( 
qqş›Á
* 
qq
, 
ušt
 
uid
, ušˆ
št_uid
, 
time_t
 
t
, * 
msg
 )

511 
	`ch¬cŞÜ
Ğ
CCOL_REDGREEN
 );

512 
time¡r
[12];

513 
msg¡r
[64];

514 cÚ¡ * 
qun_Çme
 = 
	`myqq_g‘_qun_Çme
Ğ
qq
, 
št_uid
 );

515 cÚ¡ * 
nick
 = 
	`myqq_g‘_qun_memb”_Çme
Ğ
qq
, 
št_uid
, 
uid
 );

516 
tm
 * 
timešfo
;

517 
timešfo
 = 
	`loÿÉime
 ( &
t
 );

518 
	`¡ráime
Ğ
time¡r
, 12, "%H:%M:%S", 
timešfo
 );

519 
tmp
[20], *
p
;

520 
	`¥rštf
Ğ
tmp
, "%-16d", 
št_uid
 );

521 
p
 = 
	`¡r¡r
Ğ
qun_buf
, 
tmp
 );

522 ifĞ
p
 )

524 
p
 -= 8;

525 ifĞ
p
>=
qun_buf
 )

527 
Ê
;

528 
	`ssÿnf
Ğ
p
, "%d", &
Ê
 );

529 
	`¥rštf
Ğ
msg¡r
, "\n%d)%s{", 
Ê
, 
time¡r
 );

530 
	`¡rÿt
Ğ
msg¡r
, 
qun_Çme
 );

531 
	`¡rÿt
Ğ
msg¡r
, "}[" );

532 
	`¡rÿt
Ğ
msg¡r
, 
nick
 );

533 
	`¡rÿt
Ğ
msg¡r
, "]\n\t" );

534 
	`MSG
("%s", 
	`_TEXT
Ğ
msg¡r
 ) );

535 
	`puts
Ğ
	`_TEXT
Ğ
msg
 ) );

536 
RESET_INPUT


541 
	`¥rštf
Ğ
msg¡r
, "\n%s{", 
time¡r
 );

542 
	`¡rÿt
Ğ
msg¡r
, 
qun_Çme
 );

543 
	`¡rÿt
Ğ
msg¡r
, "}[" );

544 
	`¡rÿt
Ğ
msg¡r
, 
nick
 );

545 
	`¡rÿt
Ğ
msg¡r
, "]\n\t" );

546 
	`MSG
("%s", 
	`_TEXT
Ğ
msg¡r
 ) );

547 
	`puts
Ğ
	`_TEXT
Ğ
msg
 ) );

548 
RESET_INPUT


550 
	}
}

552 #iâdeà
__WIN32__


553 
	$»ad_·sswÜd
(*
lš•Œ
 )

555 
‹rmios
 
Şd
, 
Ãw_
;

556 
Ä—d
;

558 ià(
	`tcg‘©Œ
 (
	`f’o
 (
¡dout
), &
Şd
) != 0)

560 
Ãw_
 = 
Şd
;

561 
Ãw_
.
c_læag
 &ğ~
ECHO
;

562 ià(
	`tc£‰r
 (
	`f’o
 (
¡dout
), 
TCSAFLUSH
, &
Ãw_
) != 0)

565 
Ä—d
 = 
	`sÿnf
 ("%31s", 
lš•Œ
);

567 (è
	`tc£‰r
 (
	`f’o
 (
¡dout
), 
TCSAFLUSH
, &
Şd
);

568  
Ä—d
;

569 
	}
}

572 
	$myqq
(
¬gc
, ** 
¬gv
)

574 
cmdid
, 
Ï¡cmd
=-1, 
Ën
;

575 
cmd
[16], 
¬g
[1008];

576 
	`¤ªd
(
	`time
(
NULL
));

578 
	`cÚfig_š™
();

579 
	`qqsock‘_š™
();

580 
	`NEW
Ğ
qun_buf
, 
QUN_BUF_SIZE
, );

581 
	`NEW
Ğ
buddy_buf
, 
BUDDY_BUF_SIZE
 ,);

582 
	`NEW
Ğ
´št_buf
, 
PRINT_BUF_SIZE
, );

583 
	`NEW
Ğ
qq
, (
qqş›Á
), qqclient);

585 ifĞ!
qun_buf
 || !
buddy_buf
 || !
´št_buf
 || !
qq
 )

587 
	`MSG
("%s","noƒnough memory.");

591 
Ïb
:ifĞ
¬gc
<3 )

593 
ušt
 
uid
;

595 
·sswÜd
[32];

596 
	`MSG
("%s",
	`_TEXT
("QQè´¦å·:"));

597 
	`sÿnf
("%u", &
uid
 );

598 
	`MSG
("%s",
	`_TEXT
("QQå¯†ç :"));

599 #ifdeà
__WIN32__


600 
ušt
 
pwi
;

601 
pswd
;

602 
pwi
=0;pwi<=32;pwi++)

604 
pswd
 = 
	`g‘ch
();

605 if(
pswd
 == '\x0d')

607 
·sswÜd
[
pwi
] ='\0';

610 if(
pswd
 == '\x08')

612 ifĞ
pwi
>0 )…wi=-1;

613 
	`MSG
("%s",
	`_TEXT
("\nè¯·é‡è¾“QQå¯†ç :"));

616 
	`´štf
("*");

617 
·sswÜd
[
pwi
] =
pswd
;

620 
	`»ad_·sswÜd
Ğ
·sswÜd
 );

622 
	`MSG
("%s",
	`_TEXT
("\næ˜¯å¦éšèº«ç™»é™†ï¼Ÿ(y/n)"));

623 
	`sÿnf
("%s", 
šput
 );

624 
	`qqş›Á_ü—‹
Ğ
qq
, 
uid
, 
·sswÜd
 );

625 
qq
->
mode
 = *
šput
=='y' ? 
QQ_HIDDEN
 : 
QQ_ONLINE
;

626 
	`qqş›Á_logš
Ğ
qq
 );

627 
	`sÿnf
("%c", 
šput
 );

629 
	`qqş›Á_ü—‹
Ğ
qq
, 
	`©oi
(
¬gv
[1]),‡rgv[2] );

630 ifĞ
¬gc
 > 3 )

631 
qq
->
mode
 = 
	`©oi
(
¬gv
[3])!=0 ? 
QQ_HIDDEN
 : 
QQ_ONLINE
;

632 
	`qqş›Á_logš
Ğ
qq
 );

634 
	`MSG
("%s",
	`_TEXT
("ç™»é™†ä¸­...\n"));

635  
qq
->
´oûss
 =ğ
P_LOGGING
 )

636 
	`qqş›Á_wa™
Ğ
qq
, 1 );

637  
qq
->
´oûss
 =ğ
P_VERIFYING
 ){

643 
	`MSG
("%s",
	`_TEXT
("è¯·è¾“å…¥éªŒè¯ç ï¼ˆéªŒè¯ç ç›®å½•ä¸‹ï¼‰: "));

644 
	`sÿnf
Ğ"%s", 
šput
 );

645 
	`qqş›Á_v”ify
Ğ
qq
, *(
ušt
*)
šput
 );

646  
qq
->
´oûss
 =ğ
P_LOGGING
 )

647 
	`qqş›Á_wa™
Ğ
qq
, 1 );

649 ifĞ
qq
->
´oûss
 !ğ
P_LOGIN
 ){

650  
qq
->
´oûss
 ){

651 
P_ERROR
:

652 
	`MSG
("%s",
	`_TEXT
("ç½‘ç»œé”™è¯¯.\n"));

653 
Ïb
;

654 
P_DENIED
:

655 
	`MSG
("%s",
	`_TEXT
("æ‚¨çš„QQéœ€è¦æ¿€æ´»(http://jihuo.qq.com).\n"));

656 #ifdeà
__WIN32__


657 
	`Sh–lExecu‹
(
NULL
,"İ’","h‰p://jihuo.qq.com/",NULL,NULL,
SW_SHOWNORMAL
);

659 
Ïb
;

660 
P_WRONGPASS
:

661 
	`MSG
("%s",
	`_TEXT
("æ‚¨çš„å¯†ç é”™è¯¯.\n"));

662 
Ïb
;

664 
	`qqş›Á_logout
Ğ
qq
 );

665 
	`qqş›Á_ş—nup
Ğ
qq
 );

668 
	`MSG
("%s", 
	`_TEXT
(
h–p_msg
) );

669  
qq
->
´oûss
 !ğ
P_INIT
 ){

670 
RESET_INPUT


671 
Ën
 = 
	`_g‘lše
Ğ
šput
, 1023 );

672 ifĞ
Ën
 < 1 ) ;

673 * 
¥
 = 
	`¡rchr
Ğ
šput
, ' ' );

674 ifĞ
¥
 ){

675 *
¥
 = '\0';

676 
	`¡ºıy
Ğ
cmd
, 
šput
, 16-1 );

677 
	`¡ºıy
Ğ
¬g
, 
¥
+1, 1008-1 );

678 *
¥
 = ' ';

680 
	`¡ºıy
Ğ
cmd
, 
šput
, 16-1 );

681 
¬g
[0] = '\0';

683 
Ãed_»£t
 = 1;

684  
cmdid
=0; cmdid<(
commªds
)/16; cmdid++ )

685 ifĞ
	`¡rcmp
Ğ
commªds
[
cmdid
], 
cmd
 )==0 )

687 
SELECT_CMD
:

688  
cmdid
 ){

689 
CMD_TO
:

690 
CMD_TO2
:

692 ifĞ
’‹r
 )

694 
	`MSG
("%s",
	`_TEXT
("æ‚¨åœ¨ä¸€ä¸ªç¾¤ä¸­, ä½ å¯ä»¥å’Œä»»ä½•äººè°ˆè¯.\n"));

697 
n
 = 
	`©oi
Ğ
¬g
 );

698 ifĞ
n
 < 0xFFFF )

700 *
p
;

701 
p
 = 
	`sk_lše
Ğ
buddy_buf
, 
n
-1 );

702 ifĞ
p
 )

704 
	`ssÿnf
Ğ
p
, "%u%u", &
n
, &
to_uid
 );

705 
	`¥rštf
Ğ
´št_buf
, "æ‚¨å°†å’Œ % è¿›è¡Œè°ˆè¯\n", 
	`myqq_g‘_buddy_Çme
(
qq
, 
to_uid
) );

706 
	`MSG
("%s", 
	`_TEXT
(
´št_buf
) );

710 
to_uid
 = 
n
;

711 
	`¥rštf
Ğ
´št_buf
, "æ‚¨å°†å’Œ % è¿›è¡Œè°ˆè¯\n", 
	`myqq_g‘_buddy_Çme
(
qq
, 
to_uid
) );

712 
	`MSG
("%s", 
	`_TEXT
(
´št_buf
) );

715 
	`¥rštf
Ğ
´št_buf
, "to: % æ²¡æœ‰æ‰¾åˆ°.\n", 
¬g
 );

716 
	`MSG
("%s", 
	`_TEXT
(
´št_buf
) );

719 
CMD_SAY
:

720 
CMD_SAY2
:

722 ifĞ
’‹r
 )

724 #ifdef 
__WIN32__


725 ifĞ
	`myqq_£nd_im_to_qun
Ğ
qq
, 
qun_št_uid
, 
	`to_utf8
(
¬g
), 1 ) < 0 ){

727 ifĞ
	`myqq_£nd_im_to_qun
Ğ
qq
, 
qun_št_uid
, 
¬g
, 1 ) < 0 ){

729 
	`MSG
("%s",
	`_TEXT
("è¶…æ—¶: æ‚¨çš„æ¶ˆæ¯å‘é€å¤±è´¥.\n"));

732 ifĞ
to_uid
 == 0 )

734 
	`MSG
("%s",
	`_TEXT
("say: å’Œè°è°ˆè¯?\n"));

737 #ifdef 
__WIN32__


738 ifĞ
	`myqq_£nd_im_to_buddy
Ğ
qq
, 
to_uid
, 
	`to_utf8
(
¬g
), 1 ) < 0 ){

740 ifĞ
	`myqq_£nd_im_to_buddy
Ğ
qq
, 
to_uid
, 
¬g
, 1 ) < 0 ){

742 
	`MSG
("%s",
	`_TEXT
("è¶…æ—¶: æ‚¨çš„æ¶ˆæ¯å‘é€å¤±è´¥.\n"));

747 
CMD_EXIT
:

748 
CMD_EXIT2
:

750 
’d
;

751 
CMD_HELP
:

752 
	`MSG
("%s", 
	`_TEXT
(
h–p_msg
) );

754 
CMD_STATUS
:

755 ifĞ
	`¡rcmp
Ğ
¬g
, "away") == 0 )

756 
	`qqş›Á_chªge_¡©us
Ğ
qq
, 
QQ_AWAY
 );

757 ifĞ
	`¡rcmp
Ğ
¬g
, "online") == 0 )

758 
	`qqş›Á_chªge_¡©us
Ğ
qq
, 
QQ_ONLINE
 );

759 ifĞ
	`¡rcmp
Ğ
¬g
, "hidden") == 0 )

760 
	`qqş›Á_chªge_¡©us
Ğ
qq
, 
QQ_HIDDEN
 );

761 ifĞ
	`¡rcmp
Ğ
¬g
, "killme") == 0 )

762 
	`qqş›Á_chªge_¡©us
Ğ
qq
, 
QQ_KILLME
 );

763 ifĞ
	`¡rcmp
Ğ
¬g
, "busy") == 0 )

764 
	`qqş›Á_chªge_¡©us
Ğ
qq
, 
QQ_BUSY
 );

766 
	`MSG
("%s",
	`_TEXT
("æœªçŸ¥çŠ¶æ€\n") );

769 
CMD_ENTER
:

770 
CMD_ENTER2
:

772 
n
 = 
	`©oi
Ğ
¬g
 );

773 ifĞ
n
 < 0xFFFF )

775 *
p
;

776 
p
 = 
	`sk_lše
Ğ
qun_buf
, 
n
-1 );

777 ifĞ
p
 )

779 
	`ssÿnf
Ğ
p
, "%u%u", &
n
, &
qun_št_uid
 );

780 
	`¥rštf
Ğ
´št_buf
, "æ‚¨åœ¨ % ç¾¤ä¸­\n", 
	`myqq_g‘_qun_Çme
Ğ
qq
, 
qun_št_uid
) );

781 
	`MSG
("%s", 
	`_TEXT
(
´št_buf
) );

782 
’‹r
 = 1;

786 
qun_št_uid
 = 
n
;

787 
	`¥rštf
Ğ
´št_buf
, "æ‚¨åœ¨ % ç¾¤ä¸­\n", 
	`myqq_g‘_qun_Çme
Ğ
qq
, 
qun_št_uid
) );

788 
	`MSG
("%s", 
	`_TEXT
(
´št_buf
) );

789 
’‹r
 = 1;

792 
	`¥rštf
Ğ
´št_buf
, "’‹r: % æ²¡æœ‰æ‰¾åˆ°.\n", 
¬g
 );

793 
	`MSG
("%s", 
	`_TEXT
(
´št_buf
) );

796 
CMD_LEAVE
:

797 
CMD_LEAVE2
:

798 ifĞ!
’‹r
 )

800 
	`MSG
("%s",
	`_TEXT
("æ‚¨æ²¡æœ‰è¿›å…¥ç¾¤.\n"));

803 
’‹r
 = 0;

804 
	`¥rštf
Ğ
´št_buf
, "ç¦»å¼€ %s. æ‚¨å°†å’Œ %s è¿›è¡Œè°ˆè¯\n",

805 
	`myqq_g‘_qun_Çme
Ğ
qq
, 
qun_št_uid
 ), 
	`myqq_g‘_buddy_Çme
Ğqq, 
to_uid
 ) );

806 
	`MSG
("%s", 
	`_TEXT
(
´št_buf
) );

808 
CMD_QUN
:

809 
CMD_QUN2
:

811 
	`myqq_g‘_qun_li¡
Ğ
qq
, 
qun_buf
, 
QUN_BUF_SIZE
 );

812 
	`MSG
("%s", 
	`_TEXT
Ğ
qun_buf
 ) );

815 
CMD_UPDATE
:

816 
CMD_UPDATE2
:

817 
	`qun_upd©e_®l
Ğ
qq
 );

818 
	`buddy_upd©e_li¡
Ğ
qq
 );

819 
	`group_upd©e_li¡
Ğ
qq
 );

820 
	`MSG
("%s",
	`_TEXT
("æ›´æ–°ä¸­...\n"));

821 ifĞ
	`qqş›Á_wa™
Ğ
qq
, 20 )<0 ){

822 
	`MSG
("%s",
	`_TEXT
("æ›´æ–°è¶…æ—¶.\n"));

825 
CMD_INFO
:

826 
CMD_INFO2
:

828 ifĞ!
’‹r
 )

830 ifĞ
to_uid
==0 )

832 
	`MSG
("%s",
	`_TEXT
("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå¥½å‹.\n"));

834 * 
buf
 = (*)
	`m®loc
(1024*4);

835 ifĞ
	`myqq_g‘_buddy_šfo
Ğ
qq
, 
to_uid
, 
buf
, 1024*4 ) < 0 ){

836 
	`¥rštf
Ğ
´št_buf
, "è·å– % çš„ä¿¡æ¯å¤±è´¥\n", 
	`myqq_g‘_buddy_Çme
Ğ
qq
, 
to_uid
 ) );

837 
	`MSG
("%s", 
	`_TEXT
(
´št_buf
) );

839 
	`MSG
("%s", 
	`_TEXT
Ğ
buf
 ) );

841 
	`ä“
(
buf
);

844 * 
buf
 = (*)
	`m®loc
(1024*4);

845 ifĞ
	`myqq_g‘_qun_šfo
Ğ
qq
, 
qun_št_uid
, 
buf
, 1024*4 ) < 0 ){

846 
	`¥rštf
Ğ
´št_buf
, "è·å– % çš„ä¿¡æ¯å¤±è´¥\n", 
	`myqq_g‘_qun_Çme
Ğ
qq
, 
qun_št_uid
 ) );

847 
	`MSG
("%s", 
	`_TEXT
(
´št_buf
) );

849 
	`MSG
Ğ"%s",
	`_TEXT
Ğ
buf
 ) );

851 
	`ä“
(
buf
);

855 
CMD_VIEW
:

856 
CMD_VIEW2
:

857 ifĞ
’‹r
 )

859 
	`myqq_g‘_qun_memb”_li¡
Ğ
qq
, 
qun_št_uid
, 
buddy_buf
,

860 
BUDDY_BUF_SIZE
, 0 );

861 
	`MSG
("%s", 
	`_TEXT
Ğ
buddy_buf
 ) );

863 
	`myqq_g‘_buddy_li¡
Ğ
qq
, 
buddy_buf
, 
BUDDY_BUF_SIZE
, 0 );

864 
	`MSG
("%s", 
	`_TEXT
Ğ
buddy_buf
 ) );

867 
CMD_WHO
:

868 
CMD_WHO2
:

869 ifĞ
’‹r
 )

871 
	`myqq_g‘_qun_memb”_li¡
Ğ
qq
, 
qun_št_uid
, 
buddy_buf
,

872 
QUN_BUF_SIZE
, 1 );

873 
	`MSG
("%s", 
	`_TEXT
Ğ
buddy_buf
 ) );

875 
	`myqq_g‘_buddy_li¡
Ğ
qq
, 
buddy_buf
, 
QUN_BUF_SIZE
, 1 );

876 
	`MSG
("%s", 
	`_TEXT
Ğ
buddy_buf
 ) );

879 
CMD_CHANGE
:

880 
CMD_CHANGE2
:

881 
	`qqş›Á_logout
Ğ
qq
 );

882 
	`qqş›Á_ş—nup
Ğ
qq
 );

883 
	`myqq
Ğ0, 
NULL
 );

884 
’d
;

885 
CMD_VERIFY
:

886 
CMD_VERIFY2
:

887 
	`qqş›Á_v”ify
Ğ
qq
, *((
ušt
*)
¬g
) );

889 
CMD_ADD
:

890 
CMD_ADD2
:

892 
	`¥rštf
Ğ
´št_buf
, "æ·»åŠ [%d]çš„é™„è¨€ï¼ˆé»˜è®¤ç©ºï¼‰ï¼š", 
	`©oi
(
¬g
) );

893 
	`MSG
("%s", 
	`_TEXT
(
´št_buf
) );

894 
	`_g‘lše
Ğ
šput
, 50 );

895 
	`qqş›Á_add
Ğ
qq
, 
	`©oi
(
¬g
), 
šput
 );

898 
CMD_DEL
:

899 
	`qqş›Á_d–
Ğ
qq
, 
	`©oi
(
¬g
) );

903 ifĞ
Ï¡cmd
 && *
šput
 )

905 
cmdid
 = 
Ï¡cmd
;

906 
	`¡ºıy
Ğ
¬g
, 
šput
, 1008-1 );

907 *
šput
 = 0;

908 
SELECT_CMD
;

912 
Ï¡cmd
 = 
cmdid
;

914 
’d
:

915 
	`qqş›Á_logout
Ğ
qq
 );

916 
	`qqş›Á_ş—nup
Ğ
qq
 );

917 
	`cÚfig_’d
();

918 
	`DEL
Ğ
qq
 );

919 
	`MSG
("%s",
	`_TEXT
("ç¦»å¼€.\n"));

920 
	`DEL
Ğ
qun_buf
 );

921 
	`DEL
Ğ
buddy_buf
 );

922 
	`DEL
Ğ
´št_buf
 );

923 
	`£tcŞÜ
Ğ
CCOL_NONE
 );

924 
	`memÜy_’d
();

926 
	}
}

	@packetmgr.c

15 
	~<¡dlib.h
>

16 
	~<¡ršg.h
>

17 
	~<time.h
>

18 #ifdeà
__WIN32__


19 
	~<wšsock.h
>

20 
	~<wšš‘.h
>

22 
	~<sys/sock‘.h
>

23 
	~<¬·/š‘.h
>

24 
	~<Ãtdb.h
>

27 
	~"qqdef.h
"

28 
	~"memÜy.h
"

29 
	~"debug.h
"

30 
	~"qqş›Á.h
"

31 
	~"qq·ck‘.h
"

32 
	~"qqsock‘.h
"

33 
	~"·ck‘mgr.h
"

34 
	~"´ÙocŞ.h
"

37 
	$d–‘e_func
(cÚ¡ *
p
)

39 
	`DEL
Ğ((
qq·ck‘
*)
p
)->
buf
 ); DEL(… );

40 
	}
}

42 
qq·ck‘
* 
	$·ck‘mgr_Ãw_·ck‘
Ğ
qqş›Á
* 
qq
 )

44 
qq·ck‘
* 
p
;

46 
	`NEW
Ğ
p
, (
qq·ck‘
) ,qqpacket);

47 ifĞ!
p
 ){

48 
	`DBG
("Error: Noƒnough memory.");

49  
NULL
;

51 
p
->
time_ü—‹
 =…->
time_®ive
 = 
	`time
Ğ
NULL
 );

52 
	`NEW
Ğ
p
->
buf
, (
by‹bufãr
) ,bytebuffer);

53 ifĞ!
p
->
buf
 ){

54 
	`DBG
("Error: Noƒnough memory.");

55  
NULL
;

57 
p
->
buf
->
size
 = 
PACKET_SIZE
;

58 
p
->
buf
->
pos
 = 0;

59 
p
->
Ãed_ack
 = 1;

60 
p
->
m©ch
 = 
NULL
;

61  
p
;

62 
	}
}

64 
qq·ck‘
* 
	$·ck‘mgr_Ãw_£nd
Ğ
qqş›Á
* 
qq
, 
cmd
 )

67 
qq·ck‘
* 
p
 = 
	`·ck‘mgr_Ãw_·ck‘
Ğ
qq
 );

68 ifĞ!
p
 ){

69 
	`DBG
("Error: No…acket‡llocated.");

70  
NULL
;

72 
p
->
h—d
 = 0x02;

73 
p
->

 = 0x03;

74 
p
->
commªd
 = 
cmd
;

75 
p
->
v”siÚ
 = 
qq
->version;

76 
p
->
£qno
 = 
qq
->seqno;

77 
	`·ck‘mgr_šc_£qno
Ğ
qq
 );

78 
p
->
buf
->
pos
 = 0;

79  
p
;

80 
	}
}

82 
	$·ck‘mgr_šc_£qno
Ğ
qqş›Á
* 
qq
 )

84 
qq
->
£qno
 ++;

85 
	}
}

87 
	$·ck‘mgr_Ãw_£qno
Ğ
qqş›Á
* 
qq
 )

89 
qq
->
£qno
 = (
	`¿nd
()&0xF)<<3;

90 
	}
}

92 
	$·ck‘mgr_d–_·ck‘
Ğ
qq·ck‘mgr
* 
mgr
, 
qq·ck‘
* 
p
 )

94 ifĞ
p
->
m©ch
 ){

95 
	`loİ_»move
Ğ&
mgr
->
£Á_loİ
, 
p
->
m©ch
 );

96 
	`d–‘e_func
Ğ
p
->
m©ch
 );

98 
	`d–‘e_func
Ğ
p
 );

99 
	}
}

101 
	$check_»ady_·ck‘s
Ğ
qqş›Á
* 
qq
 )

103 
qq·ck‘mgr
* 
mgr
 = &
qq
->
·ck‘mgr
;

104 ifĞ!
	`loİ_is_em±y
(&
mgr
->
£Á_loİ
è||†oİ_is_em±y(&mgr->
»ady_loİ
) )

107 ifĞ
	`loİ_is_em±y
(&
mgr
->
£Á_loİ
) )

109 
qq·ck‘
* 
p
 =(qq·ck‘ *è
	`loİ_pİ_äom_h—d
Ğ&
mgr
->
»ady_loİ
 );

110 ifĞ
p
 &&…->
buf
 ){

112 ifĞ
p
->
h—d
!=0x02 ||…->

 !=0x03 ){

113 
	`DBG
("F©®ƒ¼Ü:…->commªd=%x…->h—d: %x…->: %x", 
p
->
commªd
,…->
h—d
,

114 
p
->

 );

115 
	`d–‘e_func
Ğ
p
 );

118 
»t
 = 
	`qqsock‘_£nd
Ğ
qq
->
sock‘
, 
p
->
buf
->
d©a
,…->buf->
Ën
 );

120 ifĞ
»t
 !ğ
p
->
buf
->
Ën
 ){

121 
	`DBG
("£nd…ack‘ faed.„‘(%d)!õ->Ën(%d)", 
»t
, 
p
->
buf
->
Ën
 );

122 
	`d–‘e_func
Ğ
p
 );

123 
	`qqş›Á_£t_´oûss
Ğ
qq
, 
P_ERROR
 );

125 ifĞ
p
->
Ãed_ack
 ){

126 
p
->
time_®ive
 = 
	`time
(
NULL
);

127 
	`loİ_push_to_
Ğ&
mgr
->
£Á_loİ
, 
p
 );

129 
	`d–‘e_func
Ğ
p
 );

133 
	`DBG
("no…acket. ");

136 
	}
}

138 
	$·ck‘mgr_put
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 )

141  
	`·ck‘mgr_put_urge
Ğ
qq
, 
p
, 0 );

142 
	}
}

145 
	$·ck‘mgr_put_urge
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
, 
urge
 )

147 
qq·ck‘mgr
* 
mgr
 = &
qq
->
·ck‘mgr
;

148 
p
->
time_®ive
 = 
	`time
(
NULL
);

149 
p
->
£nd_times
 ++;

151 ifĞ
	`±h»ad_equ®
Ğ
	`±h»ad_£lf
(), 
mgr
->
th»ad_»cv
 ) ){

153 
	`loİ_push_to_
Ğ&
mgr
->
‹mp_loİ
, 
p
 );

155 
	`loİ_push_to_
Ğ&
mgr
->
»ady_loİ
, 
p
 );

156 
	`check_»ady_·ck‘s
Ğ
qq
 );

159 
	}
}

162 
	$m©ch_£¬ch”
ĞcÚ¡ * 
p
, cÚ¡ * 
v
 )

164  ( ((
qq·ck‘
*)
p
)->
commªd
 =ğ((qq·ck‘*)
v
)->command &&

165 ((
qq·ck‘
*)
p
)->
£qno
 =ğ((qq·ck‘*)
v
)->seqno );

166 
	}
}

167 
qq·ck‘
* 
	$m©ch_·ck‘
Ğ
qq·ck‘mgr
* 
mgr
, 
qq·ck‘
* 
p
 )

169 
qq·ck‘
* 
m
;

170 
m
 =(
qq·ck‘
 *è
	`loİ_£¬ch
Ğ&
mgr
->
£Á_loİ
, (*)
p
, 
m©ch_£¬ch”
 );

171  
m
;

172 
	}
}

175 
	$»³©_£¬ch”
ĞcÚ¡ * 
p
, cÚ¡ * 
v
 )

177  ( 
p
 =ğ
v
 );

178 
	}
}

179 
	$hªdË_·ck‘
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
, 
uch¬
* 
d©a
, 
Ën
 )

181 
qq·ck‘mgr
* 
mgr
 = &
qq
->
·ck‘mgr
;

182 
mgr
->
»cv_·ck‘s
 ++;

183 
by‹bufãr
* 
buf
;

184 
	`NEW
Ğ
buf
, Ğ
by‹bufãr
 ) ,bytebuffer);

185 ifĞ!
buf
 ){

186 
	`DBG
("Error:‚oƒnough memoryo‡llocate buf.");

189 
buf
->
pos
 = 0;

190 
buf
->
Ën
 = buf->
size
 =†en;

191 
	`memıy
Ğ
buf
->
d©a
, d©a, buf->
Ën
 );

193 ifĞ
qq
->
ÃtwÜk
 =ğ
TCP
 )

194 
	`g‘_wÜd
Ğ
buf
 );

195 
p
->
h—d
 = 
	`g‘_by‹
Ğ
buf
 );

196 
p
->

 = 
buf
->
d©a
[buf->
Ën
-1];

197 ifĞ
p
->
h—d
 !ğ0x02 ||…->

!=0x03 || 
buf
->
Ën
 > 2000 ){

198 
	`DBG
("[%u] wrÚg…ack‘.†’=%d h—d: %da: %d", 
qq
->
numb”
, 
buf
->
Ën
, 
p
->
h—d
,…->

 );

199 
	`DEL
Ğ
buf
 );

202 
p
->
v”siÚ
 = 
	`g‘_wÜd
Ğ
buf
 );

203 
p
->
commªd
 = 
	`g‘_wÜd
Ğ
buf
 );

204 
p
->
£qno
 = 
	`g‘_wÜd
Ğ
buf
 );

205 
ušt
 
chk_»³©
 = (
p
->
£qno
<<16)|p->
commªd
;

207 ifĞ
	`loİ_£¬ch
Ğ&
mgr
->
»cv_loİ
, (*)
chk_»³©
, 
»³©_£¬ch”
 ) =ğ
NULL
 ){

208 
	`loİ_push_to_
Ğ&
mgr
->
»cv_loİ
, (*)
chk_»³©
 );

209 
p
->
m©ch
 = 
	`m©ch_·ck‘
Ğ
mgr
,… );

210 
p
->
time_®ive
 = 
	`time
(
NULL
);

212 iàĞ!
p
->
buf
 ){

213 
	`DBG
("%u: E¼Ü impossibË.…->buf: %x…->commªd: %x", 
qq
->
numb”
, 
p
->
buf
,…->
commªd
 );

216 
	`´oûss_·ck‘
Ğ
qq
, 
p
, 
buf
 );

217 
qq·ck‘
* 
t
;

218  (
t
 =(
qq·ck‘
 *è
	`loİ_pİ_äom_
Ğ&
mgr
->
‹mp_loİ
 )) ){

219 
	`loİ_push_to_h—d
Ğ&
mgr
->
»ady_loİ
, 
t
 );

221 ifĞ
p
->
m©ch
 ){

222 
	`loİ_»move
Ğ&
mgr
->
£Á_loİ
, 
p
->
m©ch
 );

223 
	`d–‘e_func
Ğ
p
->
m©ch
 );

225 
p
->
m©ch
 = 
NULL
;

226 
mgr
->
çed_·ck‘s
 = 0;

230 
	`DEL
Ğ
buf
 );

231 
	`check_»ady_·ck‘s
Ğ
qq
 );

233 
	}
}

234 * 
	$·ck‘mgr_»cv
Ğ* 
d©a
 )

236 
»t
;

237 
qq·ck‘
* 
p
;

238 
qqş›Á
* 
qq
 = (qqş›Á*)
d©a
;

239 
qq·ck‘mgr
* 
mgr
 = &
qq
->
·ck‘mgr
;

240 
uch¬
* 
»cv_buf
;

241 
pos
;

242 
	`NEW
Ğ
»cv_buf
, 
PACKET_SIZE
 ,
uch¬
);

243 
p
 = 
	`·ck‘mgr_Ãw_·ck‘
Ğ
qq
 );

244 ifĞ!
p
 || !
»cv_buf
 ){

245 
	`DBG
("E¼Ü:…=%x buf=%x", 
p
, 
»cv_buf
 );

246 
	`DEL
Ğ
p
 ); DELĞ
»cv_buf
 );

247  
NULL
;

249 
pos
 = 0;

250  
qq
->
´oûss
 !ğ
P_INIT
 ){

251 
»t
 = 
	`qqsock‘_»cv
Ğ
qq
->
sock‘
, 
»cv_buf
, 
PACKET_SIZE
-
pos
 );

252 ifĞ
»t
 <= 0 ){

253 ifĞ
qq
->
´oûss
 !ğ
P_INIT
 ){

255 
	`SLEEP
(1);

261 
pos
 +ğ
»t
;

263 ifĞ
qq
->
ÃtwÜk
 =ğ
TCP
 ){

264 iàĞ
pos
 > 2 ){

265 
Ën
 = 
	`Áohs
(*(
ushÜt
*)
»cv_buf
);

266 ifĞ
pos
 >ğ
Ën
 )

268 ifĞ
	`hªdË_·ck‘
Ğ
qq
, 
p
, 
»cv_buf
, 
Ën
 ) < 0 ) {

269 
pos
 = 0;

272 
pos
 -ğ
Ën
;

274 ifĞ
pos
 > 0 ){

275 
	`memmove
Ğ
»cv_buf
,„ecv_buf+
Ën
, 
pos
 );

277 }ifĞ
pos
 =ğ
PACKET_SIZE
 ){

278 
	`DBG
("”rÜ:…os: %x ", 
pos
 );

279 
pos
 = 0;

283 
	`hªdË_·ck‘
Ğ
qq
, 
p
, 
»cv_buf
, 
»t
 );

284 
pos
 = 0;

287 
	`DEL
Ğ
»cv_buf
 );

288 
	`·ck‘mgr_d–_·ck‘
Ğ
mgr
, 
p
 );

289 
	`DBG
("end.");

290  
NULL
;

291 
	}
}

293 
	$·ck‘mgr_¡¬t
Ğ
qqş›Á
* 
qq
 )

295 
»t
;

296 
qq·ck‘mgr
 *
mgr
 = &
qq
->
·ck‘mgr
;

297 
	`mem£t
Ğ
mgr
, 0, (
qq·ck‘mgr
) );

298 
	`loİ_ü—‹
Ğ&
mgr
->
»cv_loİ
, 
MAX_LOOP_PACKET
, 
NULL
 );

299 
	`loİ_ü—‹
Ğ&
mgr
->
»ady_loİ
, 128, 
d–‘e_func
 );

300 
	`loİ_ü—‹
Ğ&
mgr
->
‹mp_loİ
, 64, 
d–‘e_func
 );

301 
	`loİ_ü—‹
Ğ&
mgr
->
£Á_loİ
, 32, 
d–‘e_func
 );

302 
»t
 = 
	`±h»ad_ü—‹
Ğ&
mgr
->
th»ad_»cv
, 
NULL
, 
·ck‘mgr_»cv
, (*)
qq
 );

304 
	}
}

307 
	$·ck‘mgr_’d
Ğ
qqş›Á
* 
qq
 )

309 
qq·ck‘mgr
 *
mgr
 = &
qq
->
·ck‘mgr
;

310 
	`±h»ad_još
Ğ
mgr
->
th»ad_»cv
, 
NULL
 );

311 
	`DBG
("removing…ackets.");

312 
	`loİ_ş—nup
Ğ&
mgr
->
»cv_loİ
 );

313 
	`loİ_ş—nup
Ğ&
mgr
->
£Á_loİ
 );

314 
	`loİ_ş—nup
Ğ&
mgr
->
»ady_loİ
 );

315 
	`loİ_ş—nup
Ğ&
mgr
->
‹mp_loİ
 );

316 
	`DBG
("packetmgr_end");

317 
	}
}

319 
	$timeout_£¬ch”
ĞcÚ¡ * 
p
, cÚ¡ * 
v
 )

321 ifĞ(
time_t
)
v
-((
qq·ck‘
*)
p
)->
time_®ive
 > 0 ){

326 
	}
}

327 
	$·ck‘mgr_check_·ck‘
Ğ
qqş›Á
* 
qq
, 
timeout
 )

329 
qq·ck‘mgr
 *
mgr
 = &
qq
->
·ck‘mgr
;

330 
qq·ck‘
* 
p
;

331 
time_t
 
timeout_time
 = 
	`time
(
NULL
è- 
timeout
;

334 
p
 = (
qq·ck‘
 *)
	`loİ_£¬ch
Ğ&
mgr
->
£Á_loİ
, (*)
timeout_time
, 
timeout_£¬ch”
 );

335 ifĞ
p
 ){

336 
	`loİ_»move
Ğ&
mgr
->
£Á_loİ
, 
p
 );

338 ifĞ
p
 ){

339 ifĞ
p
->
£nd_times
 >= 3 ){

340 
	`MSG
("å‘é€æ•°æ®åŒ…å¤±è´¥. commªd: %x\n", 
p
->
commªd
 );

341 
	`d–‘e_func
Ğ
p
 );

342 
mgr
->
çed_·ck‘s
 ++;

343 ifĞ
mgr
->
çed_·ck‘s
 > 2 || 
qq
->
´oûss
 !ğ
P_LOGIN
 ){

344 
	`qqş›Á_£t_´oûss
Ğ
qq
, 
P_ERROR
 );

347 
	`DBG
("»£nd…ack‘ cmd: %x", 
p
->
commªd
 );

348 
	`·ck‘mgr_put_urge
Ğ
qq
, 
p
, 1 );

351 } 0 && 
p
 );

352 
	`check_»ady_·ck‘s
(
qq
);

354 
	}
}

	@packetmgr.h

1 #iâdeà
_PACKETMGR_H


2 
	#_PACKETMGR_H


	)

4 
	~<±h»ad.h
>

5 
	~"qqdef.h
"

6 
	~"loİ.h
"

8 
	~"qq·ck‘.h
"

9 
	gqqş›Á
;

10 
	sqq·ck‘mgr
{

11 
	m»cv_·ck‘s
;

12 
	mçed_·ck‘s
;

13 
±h»ad_t
 
	mth»ad_»cv
;

15 
loİ
 
	m»ady_loİ
;

16 
loİ
 
	m‹mp_loİ
;

17 
loİ
 
	m£Á_loİ
;

20 
loİ
 
	m»cv_loİ
;

21 }
	tqq·ck‘mgr
;

23 
qq·ck‘
* 
·ck‘mgr_Ãw_·ck‘
Ğ
qqş›Á
* 
qq
 );

24 
qq·ck‘
* 
·ck‘mgr_Ãw_£nd
Ğ
qqş›Á
* 
qq
, 
cmd
 );

25 
·ck‘mgr_d–_·ck‘
Ğ
qq·ck‘mgr
* 
mgr
, 
qq·ck‘
* 
p
 );

26 
·ck‘mgr_šc_£qno
Ğ
qqş›Á
* 
qq
 );

27 
·ck‘mgr_Ãw_£qno
Ğ
qqş›Á
* 
qq
 );

28 
·ck‘mgr_put
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 );

29 
·ck‘mgr_put_urge
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
, 
urge
 );

30 
·ck‘mgr_¡¬t
Ğ
qqş›Á
* 
qq
 );

31 
·ck‘mgr_’d
Ğ
qqş›Á
* 
qq
 );

32 
·ck‘mgr_check_·ck‘
Ğ
qqş›Á
* 
qq
, 
timeout
 );

	@prot_buddy.c

14 
	~<time.h
>

15 
	~<¡dlib.h
>

16 
	~<¡ršg.h
>

18 
	~"qqş›Á.h
"

19 
	~"memÜy.h
"

20 
	~"debug.h
"

21 
	~"qq·ck‘.h
"

22 
	~"·ck‘mgr.h
"

23 
	~"´ÙocŞ.h
"

24 
	~"buddy.h
"

26 
	$´Ù_buddy_upd©e_li¡
Ğ
qqş›Á
* 
qq
, 
ushÜt
 
pos
 )

28 
qq·ck‘
* 
p
 = 
	`·ck‘mgr_Ãw_£nd
Ğ
qq
, 
QQ_CMD_GET_BUDDY_LIST
 );

29 ifĞ!
p
 ) ;

30 
by‹bufãr
 *
buf
 = 
p
->buf;

31 
	`put_by‹
Ğ
buf
, 01 );

32 
	`put_št
Ğ
buf
, 00000000 );

33 
	`put_št
Ğ
buf
, 00000000 );

34 
	`put_by‹
Ğ
buf
, 02 );

35 
	`put_wÜd
Ğ
buf
, 
pos
 );

36 
	`put_wÜd
Ğ
buf
, 0 );

37 
	`po¡_·ck‘
Ğ
qq
, 
p
, 
SESSION_KEY
 );

38 
	}
}

40 
	$´Ù_buddy_upd©e_li¡_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 )

42 
by‹bufãr
 *
buf
 = 
p
->buf;

43 
buf
->
pos
 += 10;

44 
ushÜt
 
Ãxt_pos
 = 
	`g‘_wÜd
Ğ
buf
 );

45 
buf
->
pos
 += 5;

46 
ušt
 
numb”
;

47 
qqbuddy
* 
b
;

48  
buf
->
pos
 < buf->
Ën
-5 ){

49 
numb”
 = 
	`g‘_št
Ğ
buf
 );

50 
b
 = 
	`buddy_g‘
Ğ
qq
, 
numb”
, 1 );

51 ifĞ
b
 =ğ
NULL
 ){

52 
	`DBG
("Error: failedo‡llocate buddy.");

55 
b
->
çû
 = 
	`g‘_wÜd
Ğ
buf
 );

56 
b
->
age
 = 
	`g‘_by‹
Ğ
buf
 );

57 
b
->
£x
 = 
	`g‘_by‹
Ğ
buf
 );

58 
uch¬
 
Çme_Ën
 = 
	`g‘_by‹
Ğ
buf
 );

59 
	`g‘_d©a
Ğ
buf
, (
uch¬
*)
b
->
nickÇme
, 
Çme_Ën
 );

60 
b
->
nickÇme
[
Çme_Ën
] = 0;

61 
buf
->
pos
 += 27;

63 ifĞ
Ãxt_pos
 != 0xffff ){

64 
	`´Ù_buddy_upd©e_li¡
Ğ
qq
, 
Ãxt_pos
 );

66 
	`DBG
("buddy_couÁ: %d", 
qq
->
buddy_li¡
.
couÁ
 );

67 
	`buddy_£t_®l_off
Ğ
qq
 );

68 #iâdeà
NO_BUDDY_DETAIL_INFO


69 
	`´Ù_buddy_upd©e_sign™u»
Ğ
qq
, 0 );

70 
	`´Ù_buddy_upd©e_accouÁ
Ğ
qq
, 0 );

71 
	`´Ù_buddy_upd©e_®Ÿs
Ğ
qq
 );

73 
	`buddy_put_ev’t
Ğ
qq
 );

75 
	}
}

78 
	$´Ù_buddy_upd©e_Úlše
Ğ
qqş›Á
* 
qq
, 
ušt
 
Ãxt_numb”
 )

80 
qq·ck‘
* 
p
 = 
	`·ck‘mgr_Ãw_£nd
Ğ
qq
, 
QQ_CMD_GET_BUDDY_ONLINE
 );

81 ifĞ!
p
 ) ;

82 
by‹bufãr
 *
buf
 = 
p
->buf;

83 
	`put_by‹
Ğ
buf
, 0x02 );

84 
	`put_št
Ğ
buf
, 
Ãxt_numb”
 );

85 
	`po¡_·ck‘
Ğ
qq
, 
p
, 
SESSION_KEY
 );

86 
	}
}

88 
	$´Ù_buddy_upd©e_Úlše_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 )

90 
by‹bufãr
 *
buf
 = 
p
->buf;

91 
uch¬
 
Ãxt_Üd”
 = 
	`g‘_by‹
Ğ
buf
 );

92 
ušt
 
numb”
;

93 
qqbuddy
* 
b
;

94 
ušt
 
max_numb”
 = 0;

95  
buf
->
pos
 < buf->
Ën
 ){

96 
numb”
 = 
	`g‘_št
Ğ
buf
 );

97 ifĞ
numb”
 > 
max_numb”
 )

98 
max_numb”
 = 
numb”
;

99 
b
 = 
	`buddy_g‘
Ğ
qq
, 
numb”
, 0 );

100 ifĞ!
b
 ){

101 
	`DBG
("buddy_g‘(%dèçed.", 
numb”
 );

104 
	`g‘_by‹
Ğ
buf
 );

105 
b
->

 = 
	`g‘_št
Ğ
buf
 );

106 
b
->
pÜt
 = 
	`g‘_wÜd
Ğ
buf
 );

107 
	`g‘_by‹
Ğ
buf
 );

108 
b
->
¡©us
 = 
	`g‘_by‹
Ğ
buf
 );

109 
b
->
v”siÚ
 = 
	`g‘_wÜd
Ğ
buf
 );

110 
	`g‘_d©a
Ğ
buf
, 
b
->
£ssiÚ_key
, 16 );

111 
buf
->
pos
 += 11;

113 ifĞ
Ãxt_Üd”
 != 0xff ){

114 
	`´Ù_buddy_upd©e_Úlše
Ğ
qq
, 
max_numb”
 );

116 
	`buddy_put_ev’t
Ğ
qq
 );

119 
	}
}

122 
	$´Ù_buddy_¡©us
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 )

124 
by‹bufãr
 *
buf
 = 
p
->buf;

125 
ušt
 
numb”
 = 
	`g‘_št
Ğ
buf
 );

126 
qqbuddy
* 
b
 = 
	`buddy_g‘
Ğ
qq
, 
numb”
, 0 );

127 ifĞ
b
 ){

128 
	`g‘_by‹
Ğ
buf
 );

129 
b
->

 = 
	`g‘_št
Ğ
buf
 );

130 
b
->
pÜt
 = 
	`g‘_wÜd
Ğ
buf
 );

131 
	`g‘_by‹
Ğ
buf
 );

132 
b
->
¡©us
 = 
	`g‘_by‹
Ğ
buf
 );

133 
	`DBG
("¡©u tØ%x", 
b
->
¡©us
 );

134 
b
->
v”siÚ
 = 
	`g‘_wÜd
Ğ
buf
 );

135 
	`g‘_d©a
Ğ
buf
, 
b
->
£ssiÚ_key
, 16 );

136 
ev’t
[64];

137 
	`¥rštf
Ğ
ev’t
, "buddy¡©us^$%u^$%s", 
numb”
, 
	`buddy_¡©us_¡ršg
(
b
->
¡©us
) );

138 
	`qqş›Á_put_ev’t
Ğ
qq
, 
ev’t
 );

140 
	}
}

143 
	$´Ù_buddy_upd©e_sign™u»
Ğ
qqş›Á
* 
qq
, 
ušt
 
pos
 )

145 
qq·ck‘
* 
p
 = 
	`·ck‘mgr_Ãw_£nd
Ğ
qq
, 
QQ_CMD_GET_BUDDY_SIGN
 );

146 ifĞ!
p
 ) ;

147 
by‹bufãr
 *
buf
 = 
p
->buf;

149 
	`buddy_sÜt_li¡
Ğ
qq
 );

150 
	`put_by‹
Ğ
buf
, 0x83 );

151 
	`put_by‹
Ğ
buf
, 0x00 );

153 
i
, 
j
, 
couÁ
=1;

154 
	`±h»ad_mu‹x_lock
Ğ&
qq
->
buddy_li¡
.
mu‹x
 );

155  
i
=0; i<
qq
->
buddy_li¡
.
couÁ
; i++ )

156 ifĞ((
qqbuddy
*)
qq
->
buddy_li¡
.
™ems
[
i
])->
numb”
 >ğ
pos
 )

158 
couÁ
 = 
	`MIN
Ğ50, 
qq
->
buddy_li¡
.couÁ-
i
 );

159 ifĞ
couÁ
 == 0 ){

160 
	`±h»ad_mu‹x_uÆock
Ğ&
qq
->
buddy_li¡
.
mu‹x
 );

161 
	`DBG
("signiture finished.");

162 
	`·ck‘mgr_d–_·ck‘
Ğ&
qq
->
·ck‘mgr
, 
p
 );

166 
	`put_by‹
Ğ
buf
, 
couÁ
 );

167  
j
=
i
; j<i+
couÁ
; j++ ){

168 
	`put_št
Ğ
buf
, ((
qqbuddy
*)
qq
->
buddy_li¡
.
™ems
[
j
])->
numb”
 );

169 
	`put_št
Ğ
buf
, 0 );

171 
	`±h»ad_mu‹x_uÆock
Ğ&
qq
->
buddy_li¡
.
mu‹x
 );

172 
	`po¡_·ck‘
Ğ
qq
, 
p
, 
SESSION_KEY
 );

173 
	}
}

175 #iâdeà
NO_BUDDY_DETAIL_INFO


176 
	$´Ù_buddy_upd©e_sign™u»_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 )

178 
by‹bufãr
 *
buf
 = 
p
->buf;

179 
uch¬
 
cmd
 = 
	`g‘_by‹
Ğ
buf
 );

180  
cmd
 ){

183 
uch¬
 
»suÉ
 = 
	`g‘_by‹
Ğ
buf
 );

184 ifĞ
»suÉ
!=0 ){

185 
	`DBG
("»u¦ˆğ%d", 
»suÉ
 );

188 
ušt
 
Ãxt_pos
;

189 
Ãxt_pos
 = 
	`g‘_št
Ğ
buf
 );

190  
buf
->
pos
 < buf->
Ën
 ){

191 
ušt
 
numb”
 = 
	`g‘_št
Ğ
buf
 );

192 
qqbuddy
* 
b
 = 
	`buddy_g‘
Ğ
qq
, 
numb”
, 0 );

193 ifĞ!
b
 ){

194 
	`DBG
("buddy_g‘(%dèçed", 
numb”
);

197 
b
->
sign_time
 = 
	`g‘_št
Ğ
buf
 );

198 
uch¬
 
Ën
 = 
	`g‘_by‹
Ğ
buf
 );

200 
	`g‘_d©a
Ğ
buf
, (
uch¬
*)
b
->
sign™u»
, 
Ën
 );

201 
b
->
sign™u»
[
Ën
] = 0;

204 ifĞ
Ãxt_pos
 != 0 &&‚ext_pos != 0xffffffff ){

206 
	`´Ù_buddy_upd©e_sign™u»
Ğ
qq
, 
Ãxt_pos
 );

211 
	`DBG
("unknowÀcmd = %x", 
cmd
 );

213 
	}
}

215 
	$´Ù_buddy_upd©e_accouÁ
Ğ
qqş›Á
* 
qq
, 
ušt
 
pos
 )

217 
qq·ck‘
* 
p
 = 
	`·ck‘mgr_Ãw_£nd
Ğ
qq
, 
QQ_CMD_ACCOUNT
 );

218 ifĞ!
p
 ) ;

219 
by‹bufãr
 *
buf
 = 
p
->buf;

221 
	`buddy_sÜt_li¡
Ğ
qq
 );

222 
	`put_by‹
Ğ
buf
, 0x01 );

223 
	`put_št
Ğ
buf
, 
qq
->
numb”
 );

225 
i
, 
j
, 
couÁ
;

226 
	`±h»ad_mu‹x_lock
Ğ&
qq
->
buddy_li¡
.
mu‹x
 );

227  
i
=0; i<
qq
->
buddy_li¡
.
couÁ
; i++ )

228 ifĞ((
qqbuddy
*)
qq
->
buddy_li¡
.
™ems
[
i
])->
numb”
 >ğ
pos
 )

230 
couÁ
 = 
	`MIN
Ğ50, 
qq
->
buddy_li¡
.couÁ-
i
 );

231 ifĞ
couÁ
 == 0 ){

232 
	`±h»ad_mu‹x_uÆock
Ğ&
qq
->
buddy_li¡
.
mu‹x
 );

233 
	`DBG
("account finished.");

234 
	`·ck‘mgr_d–_·ck‘
Ğ&
qq
->
·ck‘mgr
, 
p
 );

237 
	`put_by‹
Ğ
buf
, 
couÁ
 );

238  
j
=
i
; j<i+
couÁ
; j++ ){

239 
	`put_št
Ğ
buf
, ((
qqbuddy
*)
qq
->
buddy_li¡
.
™ems
[
j
])->
numb”
 );

241 
	`±h»ad_mu‹x_uÆock
Ğ&
qq
->
buddy_li¡
.
mu‹x
 );

242 
	`po¡_·ck‘
Ğ
qq
, 
p
, 
SESSION_KEY
 );

243 
	}
}

245 
	$´Ù_buddy_upd©e_accouÁ_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 )

247 
by‹bufãr
 *
buf
 = 
p
->buf;

248 
uch¬
 
cmd
 = 
	`g‘_by‹
Ğ
buf
 );

249  
cmd
 ){

252 
	`g‘_št
(
buf
 );

253 
ushÜt
 
»suÉ
 = 
	`g‘_wÜd
Ğ
buf
 );

254 ifĞ
»suÉ
!=0x0001 ){

255 
	`DBG
("»u¦ˆğ%d", 
»suÉ
 );

258 
ušt
 
Ãxt_pos
;

259 
Ãxt_pos
 = 
	`g‘_št
Ğ
buf
 );

260 
couÁ
;

261 
couÁ
 = 
	`g‘_wÜd
Ğ
buf
 );

262  
buf
->
pos
 < buf->
Ën
 ){

263 
ušt
 
numb”
 = 
	`g‘_št
Ğ
buf
 );

264 
qqbuddy
* 
b
 = 
	`buddy_g‘
Ğ
qq
, 
numb”
, 0 );

265 ifĞ!
b
 ){

266 
	`DBG
("b==NULL");

269 
b
->
accouÁ_æag
 = 
	`g‘_št
Ğ
buf
 );

270 ifĞ
b
->
accouÁ_æag
 > 0 ){

271 
uch¬
 
Ën
 = 
	`g‘_by‹
Ğ
buf
 );

272 
Ën
 = 
	`MIN
ĞËn, 
ACCOUNT_LEN
-1 );

273 
	`g‘_d©a
Ğ
buf
, (
uch¬
*)
b
->
accouÁ
, 
Ën
 );

274 
b
->
accouÁ
[
Ën
] = 0;

278 ifĞ
Ãxt_pos
 != 0 &&‚ext_pos != 0xffffffff ){

280 
	`´Ù_buddy_upd©e_accouÁ
Ğ
qq
, 
Ãxt_pos
 );

286 
uch¬
 
ty³
, 
»suÉ
;

287 
ušt
 
numb”
;

288 
ty³
 = 
	`g‘_by‹
Ğ
buf
 );

289 
numb”
 = 
	`g‘_št
Ğ
buf
 );

290 
»suÉ
 = 
	`g‘_by‹
Ğ
buf
 );

291 ifĞ
»suÉ
 != 00 ){

292 
	`DBG
("failedo verify‡dding buddy msg.");

294 
	`DBG
("v”if›d‡ddšg buddy msg %u„esuÉ: %d", 
numb”
, 
»suÉ
 );

298 
	`DBG
("unknowÀcmd = %x", 
cmd
 );

300 
	}
}

303 
	$´Ù_buddy_upd©e_®Ÿs
Ğ
qqş›Á
* 
qq
 )

305 
qq·ck‘
* 
p
 = 
	`·ck‘mgr_Ãw_£nd
Ğ
qq
, 
QQ_CMD_BUDDY_ALIAS
 );

306 ifĞ!
p
 ) ;

307 
by‹bufãr
 *
buf
 = 
p
->buf;

308 
	`put_by‹
Ğ
buf
, 0x68 );

309 
	`put_by‹
Ğ
buf
, 0x00 );

310 
	`po¡_·ck‘
Ğ
qq
, 
p
, 
SESSION_KEY
 );

311 
	}
}

313 
	$´Ù_buddy_upd©e_®Ÿs_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 )

315 
by‹bufãr
 *
buf
 = 
p
->buf;

316 
uch¬
 
cmd
 = 
	`g‘_by‹
Ğ
buf
 );

317  
cmd
 ){

320 
uch¬
 
»suÉ
 = 
	`g‘_by‹
Ğ
buf
 );

321 ifĞ
»suÉ
!=0x01 ){

322 
	`DBG
("»u¦ˆğ%d", 
»suÉ
 );

325  
buf
->
pos
 < buf->
Ën
 ){

326 
ušt
 
numb”
 = 
	`g‘_št
Ğ
buf
 );

327 
qqbuddy
* 
b
 = 
	`buddy_g‘
Ğ
qq
, 
numb”
, 0 );

328 ifĞ!
b
 ){

329 
	`DBG
("b==NULL");

332 
uch¬
 
Ën
 = 
	`g‘_by‹
Ğ
buf
 );

333 
Ën
 = 
	`MIN
ĞËn, 
ALIAS_LEN
-1 );

334 
	`g‘_d©a
Ğ
buf
, (
uch¬
*)
b
->
®Ÿs
, 
Ën
 );

335 
b
->
®Ÿs
[
Ën
] = 0;

338 
	`buddy_put_ev’t
Ğ
qq
 );

342 
	`DBG
("unknowÀcmd = %x", 
cmd
 );

344 
	}
}

347 
	$´Ù_buddy_»que¡_addbuddy
Ğ
qqş›Á
* 
qq
, 
ušt
 
numb”
 )

349 
qq·ck‘
* 
p
 = 
	`·ck‘mgr_Ãw_£nd
Ğ
qq
, 
QQ_CMD_ADDBUDDY_REQUEST
 );

350 ifĞ!
p
 ) ;

351 
by‹bufãr
 *
buf
 = 
p
->buf;

352 
	`put_št
Ğ
buf
, 
numb”
 );

353 
	`po¡_·ck‘
Ğ
qq
, 
p
, 
SESSION_KEY
 );

354 
	}
}

356 
	$´Ù_buddy_»que¡_addbuddy_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 )

358 
by‹bufãr
 *
buf
 = 
p
->buf;

359 
ušt
 
numb”
 = 
	`g‘_št
Ğ
buf
 );

360 
uch¬
 
»suÉ
 = 
	`g‘_by‹
Ğ
buf
 );

361 
uch¬
 
æag
 = 
	`g‘_by‹
Ğ
buf
 );

362 ifĞ
»suÉ
 == 0 ){

363 
qq
->
d©a
.
İ”©šg_numb”
 = 
numb”
;

364 
qqbuddy
* 
b
 = 
	`buddy_g‘
Ğ
qq
, 
numb”
 , 1 );

365 ifĞ
b
 ){

366 
b
->
v”ify_æag
 = 
æag
;

368  
æag
 ){

370 
	`´Ù_u£r_»que¡_tok’
Ğ
qq
, 
numb”
, 
OP_ADDBUDDY
, 1, 0 );

373 
	`´Ù_u£r_»que¡_tok’
Ğ
qq
, 
numb”
, 
OP_ADDBUDDY
, 1, 0 );

377 
msg
[128];

378 
	`¥rštf
Ğ
msg
, "[%u]æ‹’ç»è¢«ä»»ä½•äººåŠ ä¸ºå¥½å‹ã€‚", 
numb”
 );

379 
	`buddy_msg_ÿÎback
Ğ
qq
, 100, 
	`time
(
NULL
), 
msg
 );

384 
msg
[128];

385 
	`¥rštf
Ğ
msg
, "[%u]éœ€è¦å›ç­”é—®é¢˜æ‰èƒ½åŠ ä¸ºå¥½å‹ã€‚", 
numb”
 );

386 
	`buddy_msg_ÿÎback
Ğ
qq
, 100, 
	`time
(
NULL
), 
msg
 );

390 
	`DBG
("UnknowÀæag = %x", 
æag
 );

393 
	}
}

395 
	$´Ù_buddy_v”ify_addbuddy
Ğ
qqş›Á
* 
qq
, 
uch¬
 
cmd
, 
ušt
 
numb”
 )

397 
qq·ck‘
* 
p
 = 
	`·ck‘mgr_Ãw_£nd
Ğ
qq
, 
QQ_CMD_ADDBUDDY_VERIFY
 );

398 ifĞ!
p
 ) ;

399 
by‹bufãr
 *
buf
 = 
p
->buf;

400 
	`put_by‹
Ğ
buf
, 
cmd
 );

401 
	`put_št
Ğ
buf
, 
numb”
 );

402 
	`put_wÜd
Ğ
buf
, 0x0000 );

403  
cmd
 ){

405 
	`put_by‹
Ğ
buf
, 0x00 );

408 
	`put_wÜd
Ğ
buf
, 
qq
->
d©a
.
u£r_tok’
.
Ën
 );

409 
	`put_d©a
Ğ
buf
, 
qq
->
d©a
.
u£r_tok’
.d©a, qq->d©a.u£r_tok’.
Ën
 );

410 
	`put_by‹
Ğ
buf
, 1 );

411 
	`put_by‹
Ğ
buf
, 0 );

412 
	`put_by‹
Ğ
buf
, 
	`¡¾’
(
qq
->
d©a
.
addbuddy_¡r
) );

413 
	`put_d©a
Ğ
buf
, (
uch¬
*)
qq
->
d©a
.
addbuddy_¡r
, 
	`¡¾’
(qq->data.addbuddy_str) );

416 
	`put_wÜd
Ğ
buf
, 
qq
->
d©a
.
u£r_tok’
.
Ën
 );

417 
	`put_d©a
Ğ
buf
, 
qq
->
d©a
.
u£r_tok’
.d©a, qq->d©a.u£r_tok’.
Ën
 );

418 
	`put_by‹
Ğ
buf
, 0x00 );

421 
	`put_wÜd
Ğ
buf
, 
qq
->
d©a
.
u£r_tok’
.
Ën
 );

422 
	`put_d©a
Ğ
buf
, 
qq
->
d©a
.
u£r_tok’
.d©a, qq->d©a.u£r_tok’.
Ën
 );

423 
	`put_by‹
Ğ
buf
, 1 );

424 
	`put_by‹
Ğ
buf
, 0 );

427 
	`po¡_·ck‘
Ğ
qq
, 
p
, 
SESSION_KEY
 );

428 
	}
}

430 
	$´Ù_buddy_v”ify_addbuddy_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 )

432 
by‹bufãr
 *
buf
 = 
p
->buf;

433 
uch¬
 
cmd
 = 
	`g‘_by‹
Ğ
buf
 );

434 
ušt
 
numb”
;

435 
numb”
 = 
	`g‘_št
Ğ
buf
 );

436  
cmd
 ){

444 
uch¬
 
»suÉ
 = 
	`g‘_by‹
Ğ
buf
 );

445 ifĞ
»suÉ
 == 0x00 ){

446 
msg
[128];

447 
	`DBG
("add buddy %u ok!! [cmd=%x]", 
numb”
, 
cmd
 );

448 
	`¥rštf
Ğ
msg
, "ä½ å·²ç»æŠŠ[%u]æ·»åŠ ä¸ºå¥½å‹ã€‚", 
numb”
 );

449 
	`buddy_msg_ÿÎback
Ğ
qq
, 100, 
	`time
(
NULL
), 
msg
 );

451 
	`buddy_upd©e_li¡
Ğ
qq
 );

453 
	`DBG
("çedØadd buddy %u„esuÉ=%d", 
numb”
, 
»suÉ
 );

458 
	`DBG
("unknowÀcmd = %x", 
cmd
 );

460 
	}
}

462 
	$´Ù_buddy_d–_buddy
Ğ
qqş›Á
* 
qq
, 
ušt
 
numb”
 )

464 
qq·ck‘
* 
p
 = 
	`·ck‘mgr_Ãw_£nd
Ğ
qq
, 
QQ_CMD_DEL_BUDDY
 );

465 ifĞ!
p
 ) ;

466 
by‹bufãr
 *
buf
 = 
p
->buf;

467 
	`put_by‹
Ğ
buf
, 
qq
->
d©a
.
u£r_tok’
.
Ën
 );

468 
	`put_d©a
Ğ
buf
, 
qq
->
d©a
.
u£r_tok’
.d©a, qq->d©a.u£r_tok’.
Ën
 );

469 
s
[16];

470 
	`¥rštf
Ğ
s
, "%u", 
numb”
 );

471 
	`put_d©a
Ğ
buf
, (
uch¬
*)
s
, 
	`¡¾’
(s) );

472 
	`po¡_·ck‘
Ğ
qq
, 
p
, 
SESSION_KEY
 );

473 
	}
}

475 
	$´Ù_buddy_d–_buddy_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 )

477 
by‹bufãr
 *
buf
 = 
p
->buf;

478 ifĞ
	`g‘_by‹
Ğ
buf
 ) != 0 ){

479 
	`DBG
("FaedØd– buddy %u.", 
qq
->
d©a
.
İ”©šg_numb”
 );

481 
msg
[128];

482 
	`buddy_»move
Ğ
qq
, qq->
d©a
.
İ”©šg_numb”
 );

483 
	`¥rštf
Ğ
msg
, "åˆ é™¤å¥½å‹[%u]æˆåŠŸã€‚", 
qq
->
d©a
.
İ”©šg_numb”
 );

484 
	`buddy_msg_ÿÎback
Ğ
qq
, 100, 
	`time
(
NULL
), 
msg
 );

486 
	}
}

	@prot_group.c

14 
	~<time.h
>

15 
	~<¡dlib.h
>

16 
	~<¡ršg.h
>

18 
	~"qqş›Á.h
"

19 
	~"memÜy.h
"

20 
	~"debug.h
"

21 
	~"qq·ck‘.h
"

22 
	~"·ck‘mgr.h
"

23 
	~"´ÙocŞ.h
"

24 
	~"qun.h
"

25 
	~"group.h
"

26 
	~"utf8.h
"

78 
	$´Ù_group_dowÆßd_Ïb–s
Ğ
qqş›Á
* 
qq
, 
ušt
 
pos
 )

80 
qq·ck‘
* 
p
 = 
	`·ck‘mgr_Ãw_£nd
Ğ
qq
, 
QQ_CMD_GROUP_LABEL
 );

81 ifĞ!
p
 ) ;

82 
by‹bufãr
 *
buf
 = 
p
->buf;

83 
	`put_by‹
Ğ
buf
, 0x1F );

84 
	`put_by‹
Ğ
buf
, 0x01 );

85 
	`put_št
Ğ
buf
, 
pos
 );

86 
	`po¡_·ck‘
Ğ
qq
, 
p
, 
SESSION_KEY
 );

87 
	}
}

89 
	$´Ù_group_dowÆßd_Ïb–s_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 )

91 
by‹bufãr
 *
buf
 = 
p
->buf;

92 
uch¬
 
cmd
 = 
	`g‘_by‹
Ğ
buf
 );

93 ifĞ
cmd
 == 0x1F ){

94 
ušt
 
Ãxt_pos
 = 
	`g‘_št
Ğ
buf
 );

95 ifĞ
Ãxt_pos
 == 0x1000000 ){

98 ifĞ
Ãxt_pos
 != 0x00 ){

99 
	`DBG
("Ãxt_po =ğ0x%x", 
Ãxt_pos
 );

101 
	`g‘_by‹
Ğ
buf
 );

102 
	`g‘_wÜd
Ğ
buf
 );

103 
uch¬
 
Ën
;

104  
buf
->
pos
 < buf->
Ën
 ){

105 
uch¬
 
numb”
 = 
	`g‘_by‹
Ğ
buf
 );

106 
	`g‘_by‹
Ğ
buf
 );

107 
Ën
 = 
	`g‘_by‹
Ğ
buf
 );

109 
qqgroup
 *
g
 = 
	`group_g‘
Ğ
qq
, 
numb”
, 1 );

110 ifĞ
g
 =ğ
NULL
 )

112 
	`mem£t
Ğ
g
->
Çme
, 0, 
NICKNAME_LEN
 );

113 
	`g‘_d©a
Ğ
buf
, (
uch¬
*)
g
->
Çme
, 
Ën
 );

116 
	`group_put_ev’t
Ğ
qq
 );

117 
	`buddy_put_ev’t
Ğ
qq
 );

119 
	`DBG
("unknowÀcmd=%x", 
cmd
 );

121 
	}
}

	@prot_im.c

15 
	~<time.h
>

16 
	~<¡dlib.h
>

17 
	~<¡ršg.h
>

18 #ifdeà
__WIN32__


19 
	~<wšsock.h
>

20 
	~<wšš‘.h
>

23 
	~<sys/sock‘.h
>

24 
	~<¬·/š‘.h
>

25 
	~<Ãtdb.h
>

28 
	~"qqş›Á.h
"

29 
	~"memÜy.h
"

30 
	~"debug.h
"

31 
	~"qq·ck‘.h
"

32 
	~"·ck‘mgr.h
"

33 
	~"qqüy±.h
"

34 
	~"md5.h
"

35 
	~"buddy.h
"

36 
	~"´ÙocŞ.h
"

37 
	~"utf8.h
"

38 
	~"ut.h
"

41 
	$´Ù_im_£nd_msg
Ğ
qqş›Á
* 
qq
, 
ušt
 
to
, * 
msg
 )

43 
Ën
 = 
	`¡¾’
Ğ
msg
 );

44 ifĞ
Ën
 > 700 ){

48 
qq·ck‘
* 
p
 = 
	`·ck‘mgr_Ãw_£nd
Ğ
qq
, 
QQ_CMD_SEND_IM
 );

49 ifĞ!
p
 ) ;

50 
by‹bufãr
 *
buf
 = 
p
->buf;

51 
	`put_št
Ğ
buf
, 
qq
->
numb”
 );

52 
	`put_št
Ğ
buf
, 
to
 );

53 
	`put_wÜd
Ğ
buf
, 
qq
->
v”siÚ
 );

54 
	`put_št
Ğ
buf
, 
qq
->
numb”
 );

55 
	`put_št
Ğ
buf
, 
to
 );

56 
	`put_d©a
Ğ
buf
, 
qq
->
d©a
.
im_key
, 16 );

57 
	`put_wÜd
Ğ
buf
, 
QQ_NORMAL_IM_TEXT
 );

58 
	`put_wÜd
Ğ
buf
, 
p
->
£qno
 );

59 
	`put_št
Ğ
buf
, 
p
->
time_ü—‹
 );

60 
	`put_wÜd
Ğ
buf
, 0x008D );

61 
	`put_št
Ğ
buf
, 1 );

62 
	`put_by‹
Ğ
buf
, 1 );

63 
	`put_by‹
Ğ
buf
, 0 );

64 
	`put_by‹
Ğ
buf
, 0 );

65 
	`put_by‹
Ğ
buf
, 0 );

66 
	`put_by‹
Ğ
buf
, 
QQ_IM_TEXT
 );

67 
	`put_št
Ğ
buf
, 0x4D534700 );

68 
	`put_št
Ğ
buf
, 0x00000000 );

69 
	`put_št
Ğ
buf
, 
p
->
time_ü—‹
 );

70 
	`put_št
Ğ
buf
, 
	`¿nd
() );

71 
	`put_št
Ğ
buf
, 0x00000000 );

72 
	`put_št
Ğ
buf
, 0x09008600 );

73 
fÚt_Çme
[] = "å®‹ä½“";

74 
	`put_wÜd
Ğ
buf
, 
	`¡¾’
(
fÚt_Çme
) );

75 
	`put_d©a
Ğ
buf
, (
uch¬
*)
fÚt_Çme
, 
	`¡¾’
( font_name) );

76 
	`put_wÜd
Ğ
buf
, 0x0000 );

77 
	`put_by‹
Ğ
buf
, 0x01 );

78 
	`put_wÜd
Ğ
buf
, 
Ën
+3 );

79 
	`put_by‹
Ğ
buf
, 1 );

80 
	`put_wÜd
Ğ
buf
, 
Ën
 );

82 
	`put_d©a
Ğ
buf
, (
uch¬
*)
msg
, 
Ën
 );

83 
	`po¡_·ck‘
Ğ
qq
, 
p
, 
SESSION_KEY
 );

84 
	}
}

86 
	$´Ù_im_ack_»cv
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
´e
 )

88 
qq·ck‘
* 
p
 = 
	`·ck‘mgr_Ãw_£nd
Ğ
qq
, 
QQ_CMD_RECV_IM
 );

89 ifĞ!
p
 ) ;

90 
by‹bufãr
 *
buf
 = 
p
->buf;

91 
p
->
£qno
 = 
´e
->seqno;

92 
	`put_d©a
Ğ
buf
, 
´e
->buf->
d©a
, 16 );

93 
p
->
Ãed_ack
 = 0;

94 
	`po¡_·ck‘
Ğ
qq
, 
p
, 
SESSION_KEY
 );

95 
	}
}

97 
	$·r£_mes§ge_09
Ğ
qq·ck‘
* 
p
, 
qqmes§ge
* 
msg
, * 
tmp
, 
ou’
 )

99 
by‹bufãr
 *
buf
 = 
p
->buf;

100 
i
 = 0;

101 
ushÜt
 
Ën
;

102 
buf
->
pos
 += 8;

103 
msg
->
msg_time
 = 
	`g‘_št
Ğ
buf
 );

104 
buf
->
pos
 += 12;

105 
Ën
 = 
	`g‘_wÜd
Ğ
buf
 );

106 
buf
->
pos
 +ğ
Ën
;

107 
	`g‘_wÜd
Ğ
buf
 );

108  
buf
->
pos
 < buf->
Ën
 ){

109 
uch¬
 
ty³
 = 
	`g‘_by‹
(
buf
);

110 
Ën
 = 
	`g‘_wÜd
(
buf
);

111 
	`g‘_by‹
(
buf
);

112 
ushÜt
 
Ën_¡r
;

113  
ty³
 ){

115 
Ën_¡r
 = 
	`g‘_wÜd
Ğ
buf
 );

116 
Ën_¡r
 = 
	`MIN
Ö’_¡r, 
ou’
-
i
);

117 
	`g‘_d©a
Ğ
buf
, (
uch¬
*)&
tmp
[
i
], 
Ën_¡r
 );

118 
i
 +ğ
Ën_¡r
;

121 
Ën_¡r
 = 
	`g‘_wÜd
Ğ
buf
 );

122 
buf
->
pos
 +ğ
Ën_¡r
;

123 
	`g‘_by‹
Ğ
buf
 );

124 
Ën_¡r
 = 
	`g‘_wÜd
Ğ
buf
 );

125 ifĞ
Ën_¡r
 == 2 ){

126 
	`g‘_by‹
Ğ
buf
 );

127 ifĞ
ou’
-
i
 > 15 )

128 
i
 +ğ
	`¥rštf
Ğ&
tmp
[i], "[çû:%d]", 
	`g‘_by‹
Ğ
buf
 ) );

130 
buf
->
pos
 +ğ
Ën_¡r
;

134 
Ën_¡r
 = 
	`g‘_wÜd
Ğ
buf
 );

135 
buf
->
pos
 +ğ
Ën_¡r
;

136 
	`g‘_by‹
Ğ
buf
 );

137 
tok’
 
tok_pic
;

138 
	`g‘_tok’
Ğ
buf
, &
tok_pic
 );

139 ifĞ
ou’
-
i
 > 10 )

140 
i
 +ğ
	`¥rštf
Ğ&
tmp
[i], "[image]" );

142 
Ën
 = 0;

144 
tmp
[
i
] = 0;

145 
	}
}

147 
	$´oûss_buddy_im_‹xt
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
, 
qqmes§ge
* 
msg
 )

149 
by‹bufãr
 *
buf
 = 
p
->buf;

150 
tmp
[
MSG_CONTENT_LEN
];

151 
	`g‘_wÜd
Ğ
buf
 );

152 
msg
->
msg_time
 = 
	`g‘_št
Ğ
buf
 );

153 
	`g‘_wÜd
Ğ
buf
 );

154 
buf
->
pos
 += 4;

156 
msg
->
¦iû_couÁ
 = 
	`g‘_by‹
Ğ
buf
 );

157 
msg
->
¦iû_no
 = 
	`g‘_by‹
Ğ
buf
 );

158 
msg
->
msg_id
 = 
	`g‘_wÜd
Ğ
buf
 );

159 
msg
->
auto_»¶y
 = 
	`g‘_by‹
Ğ
buf
 );

160  
msg
->
im_ty³
 ){

161 
QQ_RECV_IM_BUDDY_09
:

162 
	`·r£_mes§ge_09
Ğ
p
, 
msg
, 
tmp
, 
MSG_CONTENT_LEN
 );

163 
	`¡rıy
Ğ
msg
->
msg_cÚ‹Á
, 
tmp
 );

165 
QQ_RECV_IM_BUDDY_0801
:

166 
	`g‘_¡ršg
Ğ
buf
, 
tmp
, 
MSG_CONTENT_LEN
 );

167 
	`gb_to_utf8
Ğ
tmp
,mp, 
MSG_CONTENT_LEN
-1 );

168 
	`Œªs_çûs
Ğ
tmp
, 
msg
->
msg_cÚ‹Á
, 
MSG_CONTENT_LEN
 );

170 
QQ_RECV_IM_BUDDY_0802
:

171 
buf
->
pos
 += 8;

172 
	`g‘_¡ršg
Ğ
buf
, 
tmp
, 
MSG_CONTENT_LEN
 );

173 
	`gb_to_utf8
Ğ
tmp
,mp, 
MSG_CONTENT_LEN
-1 );

174 
	`Œªs_çûs
Ğ
tmp
, 
msg
->
msg_cÚ‹Á
, 
MSG_CONTENT_LEN
 );

179 ifĞ
qq
->
auto_»¶y
[0]!='\0' ){

180 
	`´Ù_im_£nd_msg
Ğ
qq
, 
msg
->
äom
, qq->
auto_»¶y
 );

182 
	`buddy_msg_ÿÎback
Ğ
qq
, 
msg
->
äom
, msg->
msg_time
, msg->
msg_cÚ‹Á
 );

183 
	}
}

185 
	$´oûss_buddy_im
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
, 
qqmes§ge
* 
msg
 )

187 
by‹bufãr
 *
buf
 = 
p
->buf;

188 
	`g‘_wÜd
Ğ
buf
 );

189 
msg
->
äom
 = 
	`g‘_št
Ğ
buf
 );

190 ifĞ
	`g‘_št
Ğ
buf
 ) !ğ
qq
->
numb”
 ){

191 
	`DBG
("nothing buthis is impossible!!");

194 
	`buddy_g‘
Ğ
qq
, 
msg
->
äom
, 1 );

196 
uch¬
 
key
[16];

197 
	`g‘_d©a
Ğ
buf
, 
key
, 16 );

198 
ushÜt
 
cÚ‹Á_ty³
 = 
	`g‘_wÜd
Ğ
buf
 );

199  
cÚ‹Á_ty³
 ){

200 
QQ_NORMAL_IM_TEXT
:

202 
	`´oûss_buddy_im_‹xt
Ğ
qq
, 
p
, 
msg
 );

204 
QQ_NORMAL_IM_FILE_REQUEST_TCP
:

205 
	`DBG
("QQ_NORMAL_IM_FILE_REQUEST_TCP");

207 
QQ_NORMAL_IM_FILE_APPROVE_TCP
:

208 
	`DBG
("QQ_NORMAL_IM_FILE_APPROVE_TCP");

210 
QQ_NORMAL_IM_FILE_REJECT_TCP
:

211 
	`DBG
("QQ_NORMAL_IM_FILE_REJECT_TCP");

213 
QQ_NORMAL_IM_FILE_REQUEST_UDP
:

214 
	`DBG
("QQ_NORMAL_IM_FILE_REQUEST_UDP");

216 
QQ_NORMAL_IM_FILE_APPROVE_UDP
:

217 
	`DBG
("QQ_NORMAL_IM_FILE_APPROVE_UDP");

219 
QQ_NORMAL_IM_FILE_REJECT_UDP
:

220 
	`DBG
("QQ_NORMAL_IM_FILE_REJECT_UDP");

222 
QQ_NORMAL_IM_FILE_NOTIFY
:

223 
	`DBG
("QQ_NORMAL_IM_FILE_NOTIFY");

225 
QQ_NORMAL_IM_FILE_PASV
:

226 
	`DBG
("QQ_NORMAL_IM_FILE_PASV");

228 
QQ_NORMAL_IM_FILE_CANCEL
:

229 
	`DBG
("QQ_NORMAL_IM_FILE_CANCEL");

231 
QQ_NORMAL_IM_FILE_EX_REQUEST_UDP
:

234 
QQ_NORMAL_IM_FILE_EX_REQUEST_ACCEPT
:

235 
	`DBG
("QQ_NORMAL_IM_FILE_EX_REQUEST_ACCEPT");

237 
QQ_NORMAL_IM_FILE_EX_REQUEST_CANCEL
:

238 
	`DBG
("QQ_NORMAL_IM_FILE_EX_REQUEST_CANCEL");

240 
QQ_NORMAL_IM_FILE_EX_NOTIFY_IP
:

241 
	`DBG
("QQ_NORMAL_IM_FILE_EX_NOTIFY_IP");

244 
	`DBG
("UNKNOWNy³: %x", 
cÚ‹Á_ty³
 );

247 
	}
}

249 
	$´oûss_sys_im
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
, 
qqmes§ge
* 
msg
 )

251 
by‹bufãr
 *
buf
 = 
p
->buf;

252 
msg
->
msg_time
 = 
	`time
(
NULL
);

253 
uch¬
 
cÚ‹Á_ty³
;

254 
cÚ‹Á_ty³
 = 
	`g‘_by‹
Ğ
buf
 );

255 
uch¬
 
Ën
 = 
	`g‘_by‹
Ğ
buf
 );

256 
	`g‘_d©a
Ğ
buf
, (
uch¬
*)
msg
->
msg_cÚ‹Á
, 
Ën
 );

257 
msg
->
msg_cÚ‹Á
[
Ën
] = 0;

258 
	`buddy_msg_ÿÎback
Ğ
qq
, 
msg
->
äom
, msg->
msg_time
, msg->
msg_cÚ‹Á
 );

259 ifĞ
	`¡r¡r
Ğ
msg
->
msg_cÚ‹Á
, "å¦ä¸€åœ°ç‚¹ç™»å½•" ) !ğ
NULL
 ){

260 
	`qqş›Á_£t_´oûss
Ğ
qq
, 
P_BUSY
 );

262 
	`qqş›Á_£t_´oûss
Ğ
qq
, 
P_ERROR
 );

265 
	}
}

267 
	$´oûss_qun_im
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
, 
qqmes§ge
* 
msg
 )

269 
by‹bufãr
 *
buf
 = 
p
->buf;

270 
tmp
[
MSG_CONTENT_LEN
];

271 
	`g‘_št
Ğ
buf
 );

272 
	`g‘_by‹
Ğ
buf
 );

273 
msg
->
äom
 = 
	`g‘_št
Ğ
buf
 );

274 ifĞ
msg
->
äom
 =ğ
qq
->
numb”
 )

276 
	`g‘_wÜd
Ğ
buf
 );

277 
msg
->
msg_id
 = 
	`g‘_wÜd
Ğ
buf
 );

278 
msg
->
msg_time
 = 
	`g‘_št
Ğ
buf
 );

279  
msg
->
im_ty³
 ){

280 
QQ_RECV_IM_QUN_IM_09
:

281 
buf
->
pos
 += 16;

282 
	`·r£_mes§ge_09
Ğ
p
, 
msg
, 
tmp
, 
MSG_CONTENT_LEN
 );

283 
	`¡rıy
Ğ
msg
->
msg_cÚ‹Á
, 
tmp
 );

285 
QQ_RECV_IM_QUN_IM
:

286 
buf
->
pos
 += 16;

287 
	`g‘_¡ršg
Ğ
buf
, 
tmp
, 
MSG_CONTENT_LEN
 );

288 
	`gb_to_utf8
Ğ
tmp
,mp, 
MSG_CONTENT_LEN
-1 );

289 
	`Œªs_çûs
Ğ
tmp
, 
msg
->
msg_cÚ‹Á
, 
MSG_CONTENT_LEN
 );

295 
	`qun_msg_ÿÎback
Ğ
qq
, 
msg
->
äom
, msg->
qun_numb”
, msg->
msg_time
, msg->
msg_cÚ‹Á
 );

296 
	}
}

298 
	$´oûss_qun_memb”_im
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
, 
qqmes§ge
* 
msg
 )

300 
by‹bufãr
 *
buf
 = 
p
->buf;

301 
tok’
 
tok_unknown
;

302 
buf
->
pos
 += 14;

303 
	`g‘_tok’
Ğ
buf
, &
tok_unknown
 );

304 
buf
->
pos
 += 8;

305 
	`g‘_št
Ğ
buf
 );

306 
	`g‘_št
Ğ
buf
 );

307 
msg
->
äom
 = 
	`g‘_št
Ğ
buf
 );

308 
	`g‘_št
Ğ
buf
 );

309 
	`g‘_št
Ğ
buf
 );

310 
msg
->
msg_time
 = 
	`g‘_št
Ğ
buf
 );

311 
msg
->
qun_numb”
 = 
	`g‘_št
Ğ
buf
 );

312 
	`g‘_št
Ğ
buf
 );

313 
buf
->
pos
 += 15;

314 
	`´oûss_buddy_im
Ğ
qq
, 
p
, 
msg
 );

315 
	`DBG
("´oûss_qun_memb”_im: qun_numb”: %u", 
msg
->
qun_numb”
 );

316 
	}
}

319 
	$´Ù_im_»cv_msg
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 )

321 
by‹bufãr
 *
buf
 = 
p
->buf;

322 
ušt
 
äom
, 
äom_
;

323 
ushÜt
 
äom_pÜt
;

324 
ushÜt
 
im_ty³
;

325 
qqmes§ge
 *
msg
;

326 ifĞ!
qq
->
logš_fšish
 ){

327 
	`DBG
("Early message ... Abandoned.");

330 
	`NEW
Ğ
msg
, Ğ
qqmes§ge
 ) ,qqmessage);

331 ifĞ!
msg
 )

334 
äom
 = 
	`g‘_št
Ğ
buf
 );

335 ifĞ
	`g‘_št
Ğ
buf
 ) !ğ
qq
->
numb”
 ){

336 
	`DBG
("qq->number is‚otƒqualo yours");

338 
	`g‘_št
Ğ
buf
 );

339 
äom_
 = 
	`g‘_št
Ğ
buf
 );

340 
äom_pÜt
 = 
	`g‘_wÜd
Ğ
buf
 );

341 
im_ty³
 = 
	`g‘_wÜd
Ğ
buf
 );

342 
msg
->
im_ty³
 = im_type;

343  
im_ty³
 ){

344 
QQ_RECV_IM_BUDDY_0801
:

345 
	`DBG
("QQ_RECV_IM_BUDDY_0801");

346 
msg
->
msg_ty³
 = 
MT_BUDDY
;

347 
	`´oûss_buddy_im
Ğ
qq
, 
p
, 
msg
 );

349 
QQ_RECV_IM_BUDDY_0802
:

350 
	`DBG
("QQ_RECV_IM_BUDDY_0802");

351 
msg
->
msg_ty³
 = 
MT_BUDDY
;

352 
	`´oûss_buddy_im
Ğ
qq
, 
p
, 
msg
 );

354 
QQ_RECV_IM_BUDDY_09
:

355 
	`DBG
("QQ_RECV_IM_BUDDY_09");

356 
msg
->
msg_ty³
 = 
MT_BUDDY
;

357 
p
->
buf
->
pos
 += 7;

358 
	`´oûss_buddy_im
Ğ
qq
, 
p
, 
msg
 );

359 
QQ_RECV_IM_WRITING
:

362 
QQ_RECV_IM_QUN_IM
:

363 
QQ_RECV_IM_QUN_IM_09
:

364 
msg
->
msg_ty³
 = 
MT_QUN
;

365 
msg
->
qun_numb”
 = 
äom
;

366 
	`´oûss_qun_im
Ğ
qq
, 
p
, 
msg
 );

368 
QQ_RECV_IM_TO_UNKNOWN
:

369 
	`DBG
("QQ_RECV_IM_TO_UNKNOWN");

371 
QQ_RECV_IM_NEWS
:

372 
	`DBG
("QQ_RECV_IM_NEWS");

374 
QQ_RECV_IM_UNKNOWN_QUN_IM
:

375 
	`DBG
("QQ_RECV_IM_UNKNOWN_QUN_IM");

377 
QQ_RECV_IM_ADD_TO_QUN
:

378 
	`DBG
("QQ_RECV_IM_ADD_TO_QUN");

380 
QQ_RECV_IM_DEL_FROM_QUN
:

381 
	`DBG
("QQ_RECV_IM_DEL_FROM_QUN");

383 
QQ_RECV_IM_APPLY_ADD_TO_QUN
:

384 
	`DBG
("QQ_RECV_IM_APPLY_ADD_TO_QUN");

386 
QQ_RECV_IM_APPROVE_APPLY_ADD_TO_QUN
:

387 
	`DBG
("QQ_RECV_IM_APPROVE_APPLY_ADD_TO_QUN");

389 
QQ_RECV_IM_REJCT_APPLY_ADD_TO_QUN
:

390 
	`DBG
("QQ_RECV_IM_REJCT_APPLY_ADD_TO_QUN");

392 
QQ_RECV_IM_CREATE_QUN
:

393 
	`DBG
("QQ_RECV_IM_CREATE_QUN");

395 
QQ_RECV_IM_TEMP_QUN_IM
:

396 
	`DBG
("QQ_RECV_IM_TEMP_QUN_IM");

397 
QQ_RECV_IM_SYS_NOTIFICATION
:

398 
msg
->
msg_ty³
 = 
MT_SYSTEM
;

399 
	`´oûss_sys_im
Ğ
qq
, 
p
, 
msg
 );

401 
QQ_RECV_IM_QUN_MEMBER_IM
:

402 
msg
->
msg_ty³
 = 
MT_QUN_MEMBER
;

403 
	`´oûss_qun_memb”_im
Ğ
qq
, 
p
, 
msg
 );

406 
	`DBG
("UnknowÀmes§gty³ : %x", 
im_ty³
 );

409 
	`´Ù_im_ack_»cv
Ğ
qq
, 
p
 );

410 
	`DEL
Ğ
msg
 );

411 
	}
}

	@prot_login.c

16 
	~<time.h
>

17 
	~<¡dlib.h
>

18 
	~<¡ršg.h
>

19 #ifdeà
__WIN32__


20 
	~<wšsock.h
>

21 
	~<wšš‘.h
>

23 
	~<sys/sock‘.h
>

24 
	~<¬·/š‘.h
>

25 
	~<Ãtdb.h
>

28 
	~"qqş›Á.h
"

29 
	~"memÜy.h
"

30 
	~"debug.h
"

31 
	~"qq·ck‘.h
"

32 
	~"·ck‘mgr.h
"

33 
	~"qqüy±.h
"

34 
	~"md5.h
"

35 
	~"üc32.h
"

36 
	~"´ÙocŞ.h
"

37 
	~"group.h
"

38 
	~"buddy.h
"

39 
	~"qun.h
"

41 
	#RANDOM


	)

42 #ifdeà
RANDOM


44 
	$¿nd2
()

47 
	}
}

48 
	$¿ndkey
(
uch¬
* 
key
)

50 
i
;

51  
i
=0; i<16; i++ )

52 
key
[
i
] = 
	`¿nd2
();

53 
	}
}

55 
	$»¡Üe_v”siÚ_d©a
Ğ
qqş›Á
* 
qq
 )

57 
uch¬
 
QQ09_LOCALE
[] = {0x00,0x00,0x08,0x04,0x01,0xE0};

58 
uch¬
 
QQ09_VERSION_SPEC
[] = {0x00,0x00,0x02,0x00,0x00,

60 
uch¬
 
QQ09_EXE_HASH
[] = {0x62,0x0C,0x12,0x15,0x53,0x7E,

62 
	`memıy
Ğ
qq
->
d©a
.
loÿË
, 
QQ09_LOCALE
, (QQ09_LOCALE) );

63 
	`memıy
Ğ
qq
->
d©a
.
v”siÚ_¥ec
, 
QQ09_VERSION_SPEC
,

64 (
QQ09_VERSION_SPEC
) );

65 
	`memıy
Ğ
qq
->
d©a
.
exe_hash
, 
QQ09_EXE_HASH
,

66 (
QQ09_EXE_HASH
) );

67 
	}
}

69 
	$´Ù_logš_touch
Ğ
qqş›Á
* 
qq
 )

71 
uch¬
 
z”os
[15]={0,};

72 
	`´Ù_logš_touch_w™h_šfo
Ğ
qq
, 
z”os
, (zeros) );

73 
	}
}

75 
	$´Ù_logš_touch_w™h_šfo
Ğ
qqş›Á
* 
qq
, 
uch¬
* 
£rv”_d©a
, uch¬ 
Ën
 )

77 
qq·ck‘
* 
p
 = 
	`·ck‘mgr_Ãw_£nd
Ğ
qq
, 
QQ_CMD_TOUCH
 );

78 ifĞ!
p
 ) ;

79 
by‹bufãr
 *
buf
 = 
p
->buf;

80 
	`»¡Üe_v”siÚ_d©a
Ğ
qq
 );

81 
	`¿ndkey
Ğ
p
->
key
 );

82 
	`memıy
Ğ
qq
->
d©a
.
£rv”_d©a
, s”v”_d©a, 
	`MIN
(
Ën
,(qq->data.server_data)) );

83 
	`put_wÜd
Ğ
buf
, 1 );

84 
	`put_d©a
Ğ
buf
, 
qq
->
d©a
.
loÿË
, (qq->data.locale) );

85 
	`put_d©a
Ğ
buf
, 
qq
->
d©a
.
v”siÚ_¥ec
, (qq->data.version_spec) );

86 
	`put_d©a
Ğ
buf
, 
£rv”_d©a
, (
qq
->
d©a
.server_data) );

87 
	`po¡_·ck‘
Ğ
qq
, 
p
, 
RANDOM_KEY
 );

88 
	}
}

90 
	$´Ù_logš_touch_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 )

92 
by‹bufãr
 *
buf
 = 
p
->buf;

93 
uch¬
 
»suÉ
 = 
	`g‘_by‹
Ğ
buf
 ), 
‹¡_»suÉ
;

94 ifĞ
»suÉ
 == 0x00 ){

95 
qq
->
£rv”_time
 = 
	`g‘_št
Ğ
buf
 );

96 
qq
->
£rv”_
 = 
	`g‘_št
Ğ
buf
 );

97 
buf
->
pos
 += 8;

98 
	`g‘_tok’
Ğ
buf
, &
qq
->
d©a
.
logš_tok’
 );

99 
‹¡_»suÉ
 = 
	`g‘_by‹
Ğ
buf
 );

100 ifĞ
‹¡_»suÉ
 == 0 ){

101 
	`´Ù_logš_»que¡
Ğ
qq
, 
NULL
, 0, 0 );

103 
qq
->
d©a
.
£rv”_šfo
.
w_»dœeù_couÁ
 = 1;

104 
qq
->
d©a
.
£rv”_šfo
.
c_»dœeù_couÁ
 = 
	`g‘_by‹
Ğ
buf
 );

105 
qq
->
d©a
.
£rv”_šfo
.
cÚn_i¥_id
 = 
	`g‘_št
Ğ
buf
 );

106 
qq
->
d©a
.
£rv”_šfo
.
£rv”_»v”£
 = 
	`g‘_št
Ğ
buf
 );

107 
qq
->
d©a
.
£rv”_šfo
.
cÚn_
 = qq->
£rv”_
;

108 
qq
->
£rv”_
 = 
	`g‘_št
Ğ
buf
 );

109 
š_addr
 
addr
;

110 
addr
.
s_addr
 = 
	`htÚl
Ğ
qq
->
£rv”_
 );

111 
	`DBG
("»dœeùšgØ%s", 
	`š‘_Áß
Ğ
addr
 ) );

112 
	`cÚÃù_£rv”
Ğ
qq
 );

113 
	`´Ù_logš_touch_w™h_šfo
Ğ
qq
, qq->
d©a
.
£rv”_d©a
, (qq->data.server_data) );

116 
	`DBG
("»suÉ!=00: %d", 
»suÉ
 );

118 
	}
}

120 
	$´Ù_logš_»que¡
Ğ
qqş›Á
* 
qq
, 
tok’
* 
tok
, 
ušt
 
code
, 
²g_d©a
 )

123 
qq·ck‘
* 
p
 = 
	`·ck‘mgr_Ãw_£nd
Ğ
qq
, 
QQ_CMD_LOGIN_REQUEST
 );

124 ifĞ!
p
 ) ;

125 
by‹bufãr
 *
buf
 = 
p
->buf;

126 
	`put_wÜd
Ğ
buf
, 0x0001 );

127 
	`put_d©a
Ğ
buf
, 
qq
->
d©a
.
loÿË
, (qq->data.locale) );

128 
	`put_d©a
Ğ
buf
, 
qq
->
d©a
.
v”siÚ_¥ec
, (qq->data.version_spec) );

130 
	`put_wÜd
Ğ
buf
, 
qq
->
d©a
.
logš_tok’
.
Ën
 );

131 
	`put_d©a
Ğ
buf
, 
qq
->
d©a
.
logš_tok’
.d©a, qq->d©a.logš_tok’.
Ën
 );

132 ifĞ
code
 )

133 
	`put_by‹
Ğ
buf
, 4 );

135 
	`put_by‹
Ğ
buf
, 3 );

136 
	`put_by‹
Ğ
buf
, 0 );

137 
	`put_by‹
Ğ
buf
, 5 );

138 
	`put_št
Ğ
buf
, 0 );

139 
	`put_by‹
Ğ
buf
, 
²g_d©a
 );

140 ifĞ
code
 && 
tok
 ){

141 
	`put_by‹
Ğ
buf
, 4 );

142 
	`put_št
Ğ
buf
, 
	`htÚl
Ğ
code
 ) );

144 
	`put_wÜd
Ğ
buf
, 
tok
->
Ën
 );

145 
	`put_d©a
Ğ
buf
, 
tok
->
d©a
,ok->
Ën
 );

146 }ifĞ
²g_d©a
 && 
tok
 ){

148 
	`put_wÜd
Ğ
buf
, 
tok
->
Ën
 );

149 
	`put_d©a
Ğ
buf
, 
tok
->
d©a
,ok->
Ën
 );

151 
	`put_by‹
Ğ
buf
, 0 );

152 
	`put_by‹
Ğ
buf
, 0 );

154 
	`po¡_·ck‘
Ğ
qq
, 
p
, 
RANDOM_KEY
 );

155 
	}
}

157 
	$´Ù_logš_»que¡_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 )

159 
by‹bufãr
 *
buf
 = 
p
->buf;

160 
tok’
 
ªsw”_tok’
;

161 
tok’
 
²g_tok’
;

162 
uch¬
 
Ãxt
 = 0;

163 
uch¬
 
»suÉ
 = 
	`g‘_by‹
Ğ
buf
 );

164 
	`g‘_by‹
Ğ
buf
 );

165 
	`g‘_by‹
Ğ
buf
 );

166 
uch¬
 
²g_d©a
 = 
	`g‘_by‹
Ğ
buf
 );

167 
	`g‘_št
Ğ
buf
 );

168 
	`g‘_tok’
Ğ
buf
, &
ªsw”_tok’
 );

169 ifĞ
²g_d©a
 == 1 ){

170 
Ën
;

171 
Ën
 = 
	`g‘_wÜd
Ğ
buf
 );

172 
uch¬
* 
d©a
;

173 
	`NEW
Ğ
d©a
, 
Ën
 ,
uch¬
);

174 ifĞ!
d©a
 )

176 
	`g‘_d©a
Ğ
buf
, 
d©a
, 
Ën
 );

177 
	`g‘_by‹
Ğ
buf
 );

178 
Ãxt
 = 
	`g‘_by‹
Ğ
buf
 );

179 
·th
[
PATH_LEN
];

180 
	`¥rštf
Ğ
·th
, "%s/%u.²g", 
qq
->
v”ify_dœ
, qq->
numb”
 );

181 
FILE
 *
å
;

182 ifĞ
Ãxt
 ){

183 
å
 = 
	`fİ’
Ğ
·th
, "wb" );

185 
å
 = 
	`fİ’
Ğ
·th
, "ab" );

186 
	`DBG
("gÙ…ng‡ˆ%s", 
·th
 );

188 ifĞ
å
 ){

189 
	`fwr™e
Ğ
d©a
, 
Ën
, 1, 
å
 );

190 
	`fşo£
Ğ
å
 );

192 
	`DEL
Ğ
d©a
 );

193 
	`g‘_tok’
Ğ
buf
, &
²g_tok’
 );

196 ifĞ
²g_d©a
 ){

197 ifĞ
Ãxt
 ){

198 
	`´Ù_logš_»que¡
Ğ
qq
, &
²g_tok’
, 0, 1 );

200 
qq
->
d©a
.
v”ify_tok’
 = 
ªsw”_tok’
;

201 
	`qqş›Á_£t_´oûss
Ğ
qq
, 
P_VERIFYING
 );

204 
	`DBG
("process verify…assword");

205 
qq
->
d©a
.
tok’_c
 = 
ªsw”_tok’
;

206 
	`´Ù_logš_v”ify
Ğ
qq
 );

208 
»suÉ
 = 0;

209 
	}
}

212 
	$´Ù_logš_v”ify
Ğ
qqş›Á
* 
qq
 )

214 
qq·ck‘
* 
p
 = 
	`·ck‘mgr_Ãw_£nd
Ğ
qq
, 
QQ_CMD_LOGIN_VERIFY
 );

215 ifĞ!
p
 ) ;

216 
by‹bufãr
 *
buf
 = 
p
->buf;

217 
by‹bufãr
 *
v”ify_d©a
;

218 
	`NEW
Ğ
v”ify_d©a
, (
by‹bufãr
) ,bytebuffer);

219 ifĞ!
v”ify_d©a
 ) {

220 
	`·ck‘mgr_d–_·ck‘
Ğ&
qq
->
·ck‘mgr
, 
p
 );

223 
v”ify_d©a
->
size
 = 
PACKET_SIZE
;

224 
	`put_št
Ğ
v”ify_d©a
, 0xEE21B81B );

225 
	`put_wÜd
Ğ
v”ify_d©a
, 0x0001 );

226 
	`put_št
Ğ
v”ify_d©a
, 
qq
->
numb”
 );

227 
	`put_d©a
Ğ
v”ify_d©a
, 
qq
->
d©a
.
v”siÚ_¥ec
, (qq->data.version_spec) );

228 
	`put_by‹
Ğ
v”ify_d©a
, 00 );

229 
	`put_wÜd
Ğ
v”ify_d©a
, 0x0001 );

230 
	`put_d©a
Ğ
v”ify_d©a
, 
qq
->
md5_·ss1
, (qq->md5_pass1) );

231 
	`put_št
Ğ
v”ify_d©a
, 
qq
->
£rv”_time
 );

232 
v”ify_d©a
->
pos
 += 13;

233 
	`put_št
Ğ
v”ify_d©a
, 
qq
->
ş›Á_
 );

234 
	`put_št
Ğ
v”ify_d©a
, 0 );

235 
	`put_št
Ğ
v”ify_d©a
, 0 );

236 
	`put_wÜd
Ğ
v”ify_d©a
, 0x0010 );

237 
	`put_d©a
Ğ
v”ify_d©a
, 
qq
->
d©a
.
v”ify_key1
, 0x10 );

238 
	`put_d©a
Ğ
v”ify_d©a
, 
qq
->
d©a
.
v”ify_key2
, 0x10 );

240 
	`put_wÜd
Ğ
buf
, 0x00CA );

241 
	`put_wÜd
Ğ
buf
, 0x0001 );

242 
	`put_d©a
Ğ
buf
, 
qq
->
d©a
.
loÿË
, (qq->data.locale) );

243 
	`put_d©a
Ğ
buf
, 
qq
->
d©a
.
v”siÚ_¥ec
, (qq->data.version_spec) );

244 
	`put_wÜd
Ğ
buf
, 
qq
->
d©a
.
tok’_c
.
Ën
 );

245 
	`put_d©a
Ğ
buf
, 
qq
->
d©a
.
tok’_c
.d©a, qq->d©a.tok’_c.
Ën
 );

246 ifĞ
v”ify_d©a
->
pos
 !ğ104 ){ 
	`DBG
("wrong…os!!!"); }

248 
out_Ën
 = 120;

249 
uch¬
 
’üy±ed
[120+10];

250 
	`qq’üy±
Ğ
v”ify_d©a
->
d©a
, v”ify_d©a->
pos
, 
qq
->
md5_·ss2
, 
’üy±ed
, &
out_Ën
 );

251 
	`put_wÜd
Ğ
buf
, 
out_Ën
 );

252 
	`put_d©a
Ğ
buf
, 
’üy±ed
, 
out_Ën
 );

254 
	`put_wÜd
Ğ
buf
, 0x0000 );

255 
	`put_wÜd
Ğ
buf
, 0x018B );

256 
buf
->
pos
 += 0x018B;

258 
	`DEL
Ğ
v”ify_d©a
 );

259 
	`po¡_·ck‘
Ğ
qq
, 
p
, 
RANDOM_KEY
 );

260 
	}
}

262 
	$´Ù_logš_v”ify_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 )

264 
by‹bufãr
 *
buf
 = 
p
->buf;

265 
	`g‘_wÜd
Ğ
buf
 );

266 
code
 = 
	`g‘_by‹
Ğ
buf
 );

267  
code
 ){

269 
	`g‘_tok’
Ğ
buf
, &
qq
->
d©a
.
logš_šfo_tok’
 );

270 
qq
->
d©a
.
logš_šfo_unknown1
 = 
	`g‘_št
Ğ
buf
 );

271 
qq
->
£rv”_time
 = 
	`g‘_št
Ğ
buf
 );

272 
	`g‘_tok’
Ğ
buf
, &
qq
->
d©a
.
logš_šfo_d©a
 );

273 
	`g‘_tok’
Ğ
buf
, &
qq
->
d©a
.
logš_šfo_magic
 );

274 
	`g‘_d©a
Ğ
buf
, 
qq
->
d©a
.
logš_šfo_key1
, 16 );

276 
	`´Ù_logš_g‘_šfo
Ğ
qq
 );

280 
	`qqş›Á_£t_´oûss
Ğ
qq
, 
P_DENIED
 );

281 
	`DBG
("Denied.");

284 
	`DBG
("Nohis‚umber.");

286 
	`DBG
("Wrong…assword.");

287 
	`qqş›Á_£t_´oûss
Ğ
qq
, 
P_WRONGPASS
 );

290 
	`hex_dump
Ğ
buf
->
d©a
, buf->
Ën
 );

293 
buf
->
pos
 = 11;

294 
uch¬
 
Ën
 = 
	`g‘_wÜd
Ğ
buf
 );

295 
msg
[256];

296 
	`g‘_d©a
Ğ
buf
, (
uch¬
*)
msg
, 
Ën
 );

297 
msg
[
Ën
] = 0;

298 
	`DBG
Ğ
msg
 );

300 
	}
}

303 
	$´Ù_logš_g‘_šfo
Ğ
qqş›Á
* 
qq
 )

305 
qq·ck‘
* 
p
 = 
	`·ck‘mgr_Ãw_£nd
Ğ
qq
, 
QQ_CMD_LOGIN_GET_INFO
 );

306 ifĞ!
p
 ) ;

307 
by‹bufãr
 *
buf
 = 
p
->buf;

308 
	`put_wÜd
Ğ
buf
, 0x00FD );

309 
	`put_by‹
Ğ
buf
, 0x00 );

310 
	`put_wÜd
Ğ
buf
, 0x0101 );

311 
	`put_d©a
Ğ
buf
, 
qq
->
d©a
.
loÿË
, (qq->data.locale) );

312 
	`put_d©a
Ğ
buf
, 
qq
->
d©a
.
v”siÚ_¥ec
, (qq->data.version_spec) );

313 
	`put_wÜd
Ğ
buf
, 
qq
->
d©a
.
tok’_c
.
Ën
 );

314 
	`put_d©a
Ğ
buf
, 
qq
->
d©a
.
tok’_c
.d©a, qq->d©a.tok’_c.
Ën
 );

315 
	`put_wÜd
Ğ
buf
, 
qq
->
d©a
.
logš_šfo_tok’
.
Ën
 );

316 
	`put_d©a
Ğ
buf
, 
qq
->
d©a
.
logš_šfo_tok’
.d©a, qq->d©a.logš_šfo_tok’.
Ën
 );

317 
	`put_št
Ğ
buf
, 
qq
->
d©a
.
logš_šfo_unknown1
 );

318 
	`put_št
Ğ
buf
, 
qq
->
£rv”_time
 );

319 
	`put_wÜd
Ğ
buf
, 
qq
->
d©a
.
logš_šfo_d©a
.
Ën
 );

320 
	`put_d©a
Ğ
buf
, 
qq
->
d©a
.
logš_šfo_d©a
.d©a, qq->d©a.logš_šfo_d©a.
Ën
 );

321 
	`put_wÜd
Ğ
buf
, 0x0000 );

322 
	`put_št
Ğ
buf
, 0x00000000 );

323 
	`memıy
Ğ
p
->
key
, 
qq
->
d©a
.
logš_šfo_key1
, (qq->data.login_info_key1) );

324 
	`po¡_·ck‘
Ğ
qq
, 
p
, 
RANDOM_KEY
 );

325 
	}
}

327 
	$´Ù_logš_g‘_šfo_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 )

329 
by‹bufãr
 *
buf
 = 
p
->buf;

330 
	`g‘_wÜd
Ğ
buf
 );

331 
	`g‘_wÜd
Ğ
buf
 );

332 
	`g‘_d©a
Ğ
buf
, 
qq
->
d©a
.
logš_šfo_key2
, 16 );

333 
buf
->
pos
 += 8;

334 
qq
->
d©a
.
logš_šfo_unknown2
 = 
	`g‘_št
Ğ
buf
 );

335 
qq
->
£rv”_time
 = 
	`g‘_št
Ğ
buf
 );

336 
qq
->
ş›Á_
 = 
	`g‘_št
Ğ
buf
 );

337 
	`g‘_št
Ğ
buf
 );

338 
	`g‘_tok’
Ğ
buf
, &
qq
->
d©a
.
logš_šfo_Ïrge
 );

339 
	`g‘_št
Ğ
buf
 );

340 
uch¬
 
Ën
 = 
	`g‘_by‹
Ğ
buf
 );

341 
	`g‘_d©a
Ğ
buf
, (
uch¬
*)
qq
->
£lf
->
nickÇme
, 
Ën
 );

342 
qq
->
£lf
->
nickÇme
[
Ën
] = 0;

343 
	`DBG
("H–lo, %s", 
qq
->
£lf
->
nickÇme
 );

345 
qq
->
d©a
.
logš_li¡_couÁ
 = 0;

346 
	`´Ù_logš_g‘_li¡
Ğ
qq
, 0 );

347 
	}
}

350 
	$´Ù_logš_g‘_li¡
Ğ
qqş›Á
* 
qq
, 
ushÜt
 
pos
 )

352 
qq·ck‘
* 
p
 = 
	`·ck‘mgr_Ãw_£nd
Ğ
qq
, 
QQ_CMD_LOGIN_GET_LIST
 );

353 ifĞ!
p
 ) ;

354 
by‹bufãr
 *
buf
 = 
p
->buf;

355 
	`put_wÜd
Ğ
buf
, 0x010A );

356 
	`put_wÜd
Ğ
buf
, 0x0001 );

357 
	`put_d©a
Ğ
buf
, 
qq
->
d©a
.
loÿË
, (qq->data.locale) );

358 
	`put_d©a
Ğ
buf
, 
qq
->
d©a
.
v”siÚ_¥ec
, (qq->data.version_spec) );

359 
	`put_wÜd
Ğ
buf
, 
qq
->
d©a
.
tok’_c
.
Ën
 );

360 
	`put_d©a
Ğ
buf
, 
qq
->
d©a
.
tok’_c
.d©a, qq->d©a.tok’_c.
Ën
 );

361 
	`put_št
Ğ
buf
, 
qq
->
d©a
.
logš_šfo_unknown2
 );

362 
	`put_št
Ğ
buf
, 
qq
->
£rv”_time
 );

363 
	`put_št
Ğ
buf
, 
qq
->
ş›Á_
 );

364 
	`put_št
Ğ
buf
, 00000000 );

365 
	`put_wÜd
Ğ
buf
, 
qq
->
d©a
.
logš_šfo_Ïrge
.
Ën
 );

366 
	`put_d©a
Ğ
buf
, 
qq
->
d©a
.
logš_šfo_Ïrge
.d©a, qq->d©a.logš_šfo_Ïrge.
Ën
 );

367 
	`put_wÜd
Ğ
buf
, 
pos
 );

368 
	`put_wÜd
Ğ
buf
, 0x0000 );

369 
	`put_wÜd
Ğ
buf
, 0x0081 );

370 
buf
->
pos
 += 0x0081;

371 
	`memıy
Ğ
p
->
key
, 
qq
->
d©a
.
logš_šfo_key1
, (qq->data.login_info_key1) );

372 
	`po¡_·ck‘
Ğ
qq
, 
p
, 
RANDOM_KEY
 );

373 
	}
}

375 
	$´Ù_logš_g‘_li¡_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 )

377 
by‹bufãr
 *
buf
 = 
p
->buf;

378 
ushÜt
 
Ãxt_pos
, 
Ën
;

379 
Ën
 = 
	`g‘_wÜd
Ğ
buf
 );

380 
	`g‘_št
Ğ
buf
 );

381 
Ãxt_pos
 = 
	`g‘_wÜd
Ğ
buf
 );

382 ifĞ
Ãxt_pos
 > 0x0000 ){

385 
	`DBG
("Ãxt_po ğ%d", 
Ãxt_pos
 );

386 ifĞ
Ën
 == 0x038A ){

387 
	`´Ù_logš_g‘_li¡
Ğ
qq
, ++ qq->
d©a
.
logš_li¡_couÁ
 );

390 
	`´Ù_logš_£nd_šfo
Ğ
qq
 );

392  
buf
->
pos
 < buf->
Ën
-2 ){

393 
ušt
 
numb”
 = 
	`g‘_št
Ğ
buf
 );

394 
uch¬
 
ty³
 = 
	`g‘_by‹
Ğ
buf
 );

395 
uch¬
 
gid
 = 
	`g‘_by‹
Ğ
buf
 );

396 ifĞ
ty³
 == 0x04 )

398 #iâdeà
NO_QUN_INFO


399 
	`qun_g‘
Ğ
qq
, 
numb”
, 1 );

401 }ifĞ
ty³
 == 0x01 ){

402 #iâdeà
NO_BUDDY_INFO


403 
qqbuddy
* 
b
 = 
	`buddy_g‘
Ğ
qq
, 
numb”
, 1 );

405 
b
->
gid
 = gid / 4;

409 
	}
}

412 
	$´Ù_logš_£nd_šfo
Ğ
qqş›Á
* 
qq
 )

414 
uch¬
 
unknown5
[] = { 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00,

416 
uch¬
 
unknown6
[] = {0x3C,0xE7,0x06,0xE8,0x28,0xE9,

418 
uch¬
 
unknown7
[] = {0x34,0x40,0xA8,0x12,0x97,0xE3,

421 
qq·ck‘
* 
p
 = 
	`·ck‘mgr_Ãw_£nd
Ğ
qq
, 
QQ_CMD_LOGIN_SEND_INFO
 );

422 ifĞ!
p
 ) ;

423 
by‹bufãr
 *
buf
 = 
p
->buf;

425 
	`¿ndkey
Ğ
unknown6
 );

426 
	`¿ndkey
Ğ
unknown7
 );

428 
	`put_wÜd
Ğ
buf
, 0x0001 );

429 
	`put_d©a
Ğ
buf
, 
qq
->
d©a
.
v”siÚ_¥ec
, (qq->data.version_spec) );

430 
	`put_št
Ğ
buf
, 
qq
->
d©a
.
logš_šfo_unknown2
 );

431 
	`put_št
Ğ
buf
, 
qq
->
£rv”_time
 );

432 
	`put_št
Ğ
buf
, 
qq
->
ş›Á_
 );

433 
	`put_št
Ğ
buf
, 00000000 );

434 
	`put_wÜd
Ğ
buf
, 
qq
->
d©a
.
logš_šfo_Ïrge
.
Ën
 );

435 
	`put_d©a
Ğ
buf
, 
qq
->
d©a
.
logš_šfo_Ïrge
.d©a, qq->d©a.logš_šfo_Ïrge.
Ën
 );

436 
buf
->
pos
 += 35;

437 
	`put_d©a
Ğ
buf
, 
qq
->
d©a
.
exe_hash
, (qq->data.exe_hash) );

438 
	`put_by‹
Ğ
buf
, 
	`¿nd
() );

439 
	`put_by‹
Ğ
buf
, 
qq
->
mode
 );

440 
	`put_d©a
Ğ
buf
, 
unknown5
, (unknown5) );

441 
	`put_d©a
Ğ
buf
, 
qq
->
d©a
.
£rv”_d©a
, (qq->data.server_data) );

442 
	`put_d©a
Ğ
buf
, 
qq
->
d©a
.
loÿË
, (qq->data.locale) );

443 
buf
->
pos
 += 16;

444 
	`put_wÜd
Ğ
buf
, 
qq
->
d©a
.
tok’_c
.
Ën
 );

445 
	`put_d©a
Ğ
buf
, 
qq
->
d©a
.
tok’_c
.d©a, qq->d©a.tok’_c.
Ën
 );

446 
	`put_št
Ğ
buf
, 0x00000007 );

447 
	`put_št
Ğ
buf
, 0x00000000 );

448 
	`put_wÜd
Ğ
buf
, 0x0804 );

449 
	`put_št
Ğ
buf
, 0x10014001 );

450 
	`put_wÜd
Ğ
buf
, (
unknown6
) );

451 
	`put_d©a
Ğ
buf
, 
unknown6
, (unknown6) );

452 
	`put_d©a
Ğ
buf
, 
unknown5
, (unknown5) );

453 
	`put_d©a
Ğ
buf
, 
qq
->
d©a
.
£rv”_d©a
, (qq->data.server_data) );

454 
	`put_by‹
Ğ
buf
, 0x02 );

455 
	`put_št
Ğ
buf
, 0x812807B8 );

456 
	`put_wÜd
Ğ
buf
, (
unknown7
) );

457 
	`put_d©a
Ğ
buf
, 
unknown7
, (unknown7) );

458 
buf
->
pos
 += 249;

459 
	`memıy
Ğ
p
->
key
, 
qq
->
d©a
.
logš_šfo_key1
, (qq->data.login_info_key1) );

460 
	`po¡_·ck‘
Ğ
qq
, 
p
, 
RANDOM_KEY
 );

461 
	}
}

463 
	$´Ù_logš_£nd_šfo_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 )

465 
by‹bufãr
 *
buf
 = 
p
->buf;

467 
uch¬
 
»suÉ
 = 
	`g‘_by‹
Ğ
buf
 );

468 ifĞ
»suÉ
 != 0 )

470 
	`DBG
("logš„esuÉ = %d", 
»suÉ
 );

471 
	`qqş›Á_£t_´oûss
Ğ
qq
, 
P_ERROR
 );

474 
	`g‘_d©a
Ğ
buf
, 
qq
->
d©a
.
£ssiÚ_key
, (qq->data.session_key) );

475 
	`DBG
("session key: " );

476 
	`hex_dump
Ğ
qq
->
d©a
.
£ssiÚ_key
, 16 );

477 ifĞ
qq
->
numb”
 !ğ
	`g‘_št
Ğ
buf
 ) ){

478 
	`DBG
("qq->number is wrong?");

480 
qq
->
ş›Á_
 = 
	`g‘_št
Ğ
buf
 );

481 
qq
->
ş›Á_pÜt
 = 
	`g‘_wÜd
Ğ
buf
 );

482 
qq
->
loÿl_
 = 
	`g‘_št
Ğ
buf
 );

483 
qq
->
loÿl_pÜt
 = 
	`g‘_wÜd
Ğ
buf
 );

484 
qq
->
logš_time
 = 
	`g‘_št
Ğ
buf
 );

485 
	`g‘_by‹
Ğ
buf
 );

486 
	`g‘_by‹
Ğ
buf
 );

487 
buf
->
pos
 += 96;

488 
qq
->
Ï¡_logš_time
 = 
	`g‘_št
Ğ
buf
 );

490 
uch¬
 
d©a
[20];

491 *(
ušt
*)
d©a
 = 
	`htÚl
Ğ
qq
->
numb”
 );

492 
	`memıy
Ğ
d©a
+4, 
qq
->d©a.
£ssiÚ_key
, 16 );

494 
md5_¡©e_t
 
m¡
;

495 
	`md5_š™
Ğ&
m¡
 );

496 
	`md5_­³nd
Ğ&
m¡
, (
md5_by‹_t
*)
d©a
, 20 );

497 
	`md5_fšish
Ğ&
m¡
, (
md5_by‹_t
*)
qq
->
d©a
.
im_key
 );

499 
time_t
 
t
;

500 
t
 = 
	`CN_TIME
Ğ
qq
->
Ï¡_logš_time
 );

501 
	`DBG
("Ï¡†ogšime: %s", 
	`ùime
Ğ&
t
 ) );

502 
	`qqş›Á_£t_´oûss
Ğ
qq
, 
P_LOGIN
 );

505 
	`´Ù_u£r_chªge_¡©us
Ğ
qq
 );

506 
	`´Ù_u£r_g‘_Ëv–
Ğ
qq
 );

507 
	`group_upd©e_li¡
Ğ
qq
 );

508 
	`buddy_upd©e_li¡
Ğ
qq
 );

509 #iâdeà
NO_QUN_INFO


510 
	`qun_upd©e_®l
Ğ
qq
 );

512 
qq
->
Úlše_şock
 = 0;

513 
	}
}

516 
	$´Ù_logš_logout
Ğ
qqş›Á
* 
qq
 )

518 
qq·ck‘
* 
p
 = 
	`·ck‘mgr_Ãw_£nd
Ğ
qq
, 
QQ_CMD_LOGOUT
 );

519 ifĞ!
p
 ) ;

520 
by‹bufãr
 *
buf
 = 
p
->buf;

521 
buf
->
pos
 += 16;

522 
p
->
Ãed_ack
 = 0;

523 
	`po¡_·ck‘
Ğ
qq
, 
p
, 
SESSION_KEY
 );

524 
	}
}

	@prot_misc.c

14 
	~<time.h
>

15 
	~<¡dlib.h
>

16 
	~<¡ršg.h
>

17 #ifdeà
__WIN32__


18 
	~<wšsock.h
>

19 
	~<wšš‘.h
>

21 
	~<sys/sock‘.h
>

22 
	~<¬·/š‘.h
>

23 
	~<Ãtdb.h
>

26 
	~"qqş›Á.h
"

27 
	~"memÜy.h
"

28 
	~"debug.h
"

29 
	~"qq·ck‘.h
"

30 
	~"·ck‘mgr.h
"

31 
	~"qqüy±.h
"

32 
	~"md5.h
"

33 
	~"´ÙocŞ.h
"

38 
	$´Ù_misc_brßdÿ¡
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 )

40 
by‹bufãr
 *
buf
 = 
p
->buf;

41 
e
[4][256];

42 * 
¡r
 = (*)
buf
->
d©a
;

43 
i
, 
Ën
, 
s
, 
j
;

44 
Ën
 = 
buf
->len;

45 
	`mem£t
Ğ
e
, 0, (e) );

46  
i
=0, 
s
=0, 
j
=0; i<=
Ën
 && j<4; i++ ){

47 ifĞ
¡r
[
i
] =ğ0x1à|| i==
Ën
 ){

48 
	`memıy
Ğ
e
[
j
], &
¡r
[
s
], 
	`MIN
(
i
-s, 255) );

49 
j
++;

50 
s
 = 
i
+1;

53 ifĞ
	`¡rcmp
Ğ
e
[0], "06" ) == 0 ){

55 
ev’t
[384];

56 
	`¥rštf
Ğ
ev’t
, "brßdÿ¡^$%s^$%s", 
e
[1],ƒ[3] );

57 
	`qqş›Á_put_ev’t
Ğ
qq
, 
ev’t
 );

58 }ifĞ
	`¡rcmp
Ğ
e
[0], "41" ) == 0 ){

59 
ušt
 
äom
, 
to
;

60 
uch¬
 
ty³
;

61 
äom
 = 
	`©oi
Ğ
e
[1] );

62 
to
 = 
	`©oi
Ğ
e
[2] );

63 
uch¬
 
Ën
 = 
e
[3][0];

64 
uch¬
* 
p
 = (uch¬*)(&
e
[3][1]+
Ën
);

65 
ty³
 = *
p
++;

66 
qqbuddy
 *
b
 = 
	`buddy_g‘
Ğ
qq
, 
äom
, 1 );

67 ifĞ
b
 && 
ty³
 == 1 ){

68 
b
->
v”ify_æag
 = 
VF_OK
;

69 ifĞ
qq
->
auto_acû±
 ){

70 
	`´Ù_buddy_v”ify_addbuddy
Ğ
qq
, 03, 
äom
 );

74 ifĞ
Ën
 > 0 ){

75 
	`¡ºıy
Ğ
e
[0], &e[3][1], 
Ën
 );

76 
e
[0][
Ën
] = 0;

78 
	`¡rıy
Ğ
e
[0], "Nothing" );

80 
	`¥rštf
Ğ
e
[1], "[%u]è¯·æ±‚ä½ æ·»åŠ ä¸ºå¥½å‹ã€‚é™„è¨€ï¼š%s", 
äom
,ƒ[0] );

81 
	`buddy_msg_ÿÎback
Ğ
qq
, 101, 
	`time
(
NULL
), 
e
[1] );

82 }ifĞ
	`¡rcmp
Ğ
e
[0], "04" ) == 0 ){

83 
ušt
 
äom
, 
to
;

84 
äom
 = 
	`©oi
Ğ
e
[1] );

85 
to
 = 
	`©oi
Ğ
e
[2] );

86 
uch¬
 
Ën
 = 
e
[3][0];

88 ifĞ
Ën
 > 0 ){

89 
	`¡ºıy
Ğ
e
[0], &e[3][1], 
Ën
 );

90 
e
[0][
Ën
] = 0;

92 
	`¡rıy
Ğ
e
[0], "Nothing" );

94 
	`¥rštf
Ğ
e
[1], "[%u]æ‹’ç»ä½ æ·»åŠ ä¸ºå¥½å‹ã€‚é™„è¨€ï¼š%s", 
äom
,ƒ[0] );

95 
	`buddy_msg_ÿÎback
Ğ
qq
, 100, 
	`time
(
NULL
), 
e
[1] );

96 }ifĞ
	`¡rcmp
Ğ
e
[0], "40" ) == 0 ){

97 
ušt
 
äom
;

98 
äom
 = 
	`©oi
Ğ
e
[1] );

100 
	`¥rštf
Ğ
e
[1], "[%u]å·²ç»æŠŠä½ æ·»åŠ ä¸ºå¥½å‹ã€‚", 
äom
 );

101 
	`buddy_msg_ÿÎback
Ğ
qq
, 101, 
	`time
(
NULL
), 
e
[1] );

102 }ifĞ
	`¡rcmp
Ğ
e
[0], "43" ) == 0 ){

103 
ušt
 
äom
, 
to
;

104 
äom
 = 
	`©oi
Ğ
e
[1] );

105 
to
 = 
	`©oi
Ğ
e
[2] );

107 
	`buddy_upd©e_li¡
Ğ
qq
 );

108 
	`¥rštf
Ğ
e
[1], "[%u]å·²ç»æŠŠä½ æ·»åŠ ä¸ºå¥½å‹ï¼", 
äom
 );

109 
	`buddy_msg_ÿÎback
Ğ
qq
, 100, 
	`time
(
NULL
), 
e
[1] );

110 }ifĞ
	`¡rcmp
Ğ
e
[0], "03" ) == 0 ){

111 
ušt
 
äom
, 
to
;

112 
äom
 = 
	`©oi
Ğ
e
[1] );

113 
to
 = 
	`©oi
Ğ
e
[2] );

115 
	`buddy_upd©e_li¡
Ğ
qq
 );

116 
	`¥rštf
Ğ
e
[1], "ä½ å·²ç»æŠŠ[%u]æ·»åŠ ä¸ºå¥½å‹ï¼", 
äom
 );

117 
	`buddy_msg_ÿÎback
Ğ
qq
, 100, 
	`time
(
NULL
), 
e
[1] );

119 
	`DBG
("e[0]: %s", 
e
[0] );

121 
	}
}

	@prot_qun.c

15 
	~<time.h
>

16 
	~<¡dlib.h
>

17 
	~<¡ršg.h
>

19 
	~"qqş›Á.h
"

20 
	~"memÜy.h
"

21 
	~"debug.h
"

22 
	~"qq·ck‘.h
"

23 
	~"·ck‘mgr.h
"

24 
	~"´ÙocŞ.h
"

25 
	~"qun.h
"

26 
	~"utf8.h
"

28 
	$´Ù_qun_g‘_šfo
Ğ
qqş›Á
* 
qq
, 
ušt
 
numb”
, ušˆ
pos
 )

30 
qq·ck‘
* 
p
 = 
	`·ck‘mgr_Ãw_£nd
Ğ
qq
, 
QQ_CMD_QUN_CMD
 );

31 ifĞ!
p
 ) ;

32 
by‹bufãr
 *
buf
 = 
p
->buf;

33 
	`put_by‹
Ğ
buf
, 0x72 );

34 
	`put_št
Ğ
buf
, 
numb”
 );

35 
	`put_št
Ğ
buf
, 
pos
 );

36 
	`po¡_·ck‘
Ğ
qq
, 
p
, 
SESSION_KEY
 );

37 
	}
}

39 
	$´Ù_qun_£nd_msg
Ğ
qqş›Á
* 
qq
, 
ušt
 
numb”
, * 
msg_cÚ‹Á
 )

41 
qq·ck‘
* 
p
 = 
	`·ck‘mgr_Ãw_£nd
Ğ
qq
, 
QQ_CMD_QUN_CMD
 );

42 ifĞ!
p
 ) ;

43 
ushÜt
 
Ën
 = 
	`¡¾’
Ğ
msg_cÚ‹Á
 );

44 
by‹bufãr
 *
buf
 = 
p
->buf;

45 
	`put_by‹
Ğ
buf
, 0x2A );

46 
	`put_št
Ğ
buf
, 
numb”
 );

47 
by‹bufãr
* 
cÚ‹Á_buf
;

48 
	`NEW
Ğ
cÚ‹Á_buf
, (
by‹bufãr
) ,bytebuffer);

49 ifĞ!
cÚ‹Á_buf
 ) {

50 
	`·ck‘mgr_d–_·ck‘
Ğ&
qq
->
·ck‘mgr
, 
p
 );

53 
cÚ‹Á_buf
->
size
 = 
PACKET_SIZE
;

55 
	`put_wÜd
Ğ
cÚ‹Á_buf
, 0x0001 );

56 
	`put_by‹
Ğ
cÚ‹Á_buf
, 0x01 );

57 
	`put_by‹
Ğ
cÚ‹Á_buf
, 0x00 );

58 
	`put_wÜd
Ğ
cÚ‹Á_buf
, 0 );

59 
	`put_št
Ğ
cÚ‹Á_buf
, 0 );

61 
	`put_št
Ğ
cÚ‹Á_buf
, 0x4D534700 );

62 
	`put_št
Ğ
cÚ‹Á_buf
, 0x00000000 );

63 
	`put_št
Ğ
cÚ‹Á_buf
, 
p
->
time_ü—‹
 );

64 
	`put_št
Ğ
cÚ‹Á_buf
, 
	`¿nd
() );

65 
	`put_št
Ğ
cÚ‹Á_buf
, 0x00000000 );

66 
	`put_št
Ğ
cÚ‹Á_buf
, 0x09008600 );

67 
fÚt_Çme
[] = "å®‹ä½“";

68 
	`put_wÜd
Ğ
cÚ‹Á_buf
, 
	`¡¾’
(
fÚt_Çme
) );

69 
	`put_d©a
Ğ
cÚ‹Á_buf
, (
uch¬
*)
fÚt_Çme
, 
	`¡¾’
( font_name) );

70 
	`put_wÜd
Ğ
cÚ‹Á_buf
, 0x0000 );

71 
	`put_by‹
Ğ
cÚ‹Á_buf
, 0x01 );

72 
	`put_wÜd
Ğ
cÚ‹Á_buf
, 
Ën
+3 );

73 
	`put_by‹
Ğ
cÚ‹Á_buf
, 1 );

74 
	`put_wÜd
Ğ
cÚ‹Á_buf
, 
Ën
 );

75 
	`put_d©a
Ğ
cÚ‹Á_buf
, (
uch¬
*)
msg_cÚ‹Á
, 
Ën
 );

77 
	`put_wÜd
Ğ
buf
, 
cÚ‹Á_buf
->
pos
 );

78 
	`put_d©a
Ğ
buf
, 
cÚ‹Á_buf
->
d©a
, cÚ‹Á_buf->
pos
 );

79 
	`DEL
Ğ
cÚ‹Á_buf
 );

80 
	`po¡_·ck‘
Ğ
qq
, 
p
, 
SESSION_KEY
 );

81 
	}
}

83 
	$´Ù_qun_g‘_memb”šfo
Ğ
qqş›Á
* 
qq
, 
ušt
 
numb”
, ušt* 
numb”s
, 
couÁ
 )

85 
qq·ck‘
* 
p
 = 
	`·ck‘mgr_Ãw_£nd
Ğ
qq
, 
QQ_CMD_QUN_CMD
 );

86 ifĞ!
p
 ) ;

87 
by‹bufãr
 *
buf
 = 
p
->buf;

88 
	`put_by‹
Ğ
buf
, 0x0C );

89 
	`put_št
Ğ
buf
, 
numb”
 );

90 
i
;

91 ifĞ
couÁ
 > 30 ) count = 30;

92  
i
=0; i<
couÁ
; i++ ){

93 
	`put_št
Ğ
buf
, 
numb”s
[
i
] );

95 
	`po¡_·ck‘
Ğ
qq
, 
p
, 
SESSION_KEY
 );

96 
	}
}

98 
	$´Ù_qun_g‘_Úlše
Ğ
qqş›Á
* 
qq
, 
ušt
 
numb”
 )

100 
qq·ck‘
* 
p
 = 
	`·ck‘mgr_Ãw_£nd
Ğ
qq
, 
QQ_CMD_QUN_CMD
 );

101 ifĞ!
p
 ) ;

102 
by‹bufãr
 *
buf
 = 
p
->buf;

103 
	`put_by‹
Ğ
buf
, 0x0B );

104 
	`put_št
Ğ
buf
, 
numb”
 );

105 
	`po¡_·ck‘
Ğ
qq
, 
p
, 
SESSION_KEY
 );

106 
	}
}

108 
	$´Ù_qun_g‘_memb”Çme
Ğ
qqş›Á
* 
qq
, 
ušt
 
numb”
 )

110 
qq·ck‘
* 
p
 = 
	`·ck‘mgr_Ãw_£nd
Ğ
qq
, 
QQ_CMD_QUN_CMD
 );

111 ifĞ!
p
 ) ;

112 
by‹bufãr
 *
buf
 = 
p
->buf;

113 
	`put_by‹
Ğ
buf
, 0x0F );

114 
	`put_št
Ğ
buf
, 
numb”
 );

115 
	`put_št
Ğ
buf
, 0x0 );

116 
	`put_št
Ğ
buf
, 0x0 );

117 
	`po¡_·ck‘
Ğ
qq
, 
p
, 
SESSION_KEY
 );

118 
	}
}

120 
	$·r£_qunšfo
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
, 
qqqun
* 
q
 )

122 
ušt
 
Ï¡_numb”
;

123 
uch¬
 
mÜe
, 
¡©us
;

124 
by‹bufãr
 *
buf
 = 
p
->buf;

125 
q
->
ext_numb”
 = 
	`g‘_št
Ğ
buf
 );

126 
	`g‘_wÜd
Ğ
buf
 );

127 
	`g‘_by‹
Ğ
buf
 );

128 
¡©us
 = 
	`g‘_by‹
Ğ
buf
 );

129 ifĞ
¡©us
 == 3 ){

130 
q
->
ty³
 = 
	`g‘_by‹
Ğ
buf
 );

131 
	`g‘_št
Ğ
buf
 );

133 
q
->
owÃr
 = 
	`g‘_št
Ğ
buf
 );

134 
q
->
auth_ty³
 = 
	`g‘_by‹
Ğ
buf
 );

135 
buf
->
pos
 += 6;

136 
q
->
ÿ‹gÜy
 = 
	`g‘_št
Ğ
buf
 );

137 
q
->
max_memb”
 = 
	`g‘_wÜd
Ğ
buf
 );

138 
buf
->
pos
 += 9;

140 
uch¬
 
Ën
 = 
	`g‘_by‹
Ğ
buf
 );

141 
Ën
 = 
	`MIN
Ğ
NICKNAME_LEN
-1,†en );

142 
	`g‘_d©a
Ğ
buf
, (
uch¬
*)
q
->
Çme
, 
Ën
 );

143 
q
->
Çme
[
Ën
] = 0;

145 
	`g‘_by‹
Ğ
buf
 );

146 
	`g‘_by‹
Ğ
buf
 );

148 
Ën
 = 
	`g‘_by‹
Ğ
buf
 );

150 
	`g‘_d©a
Ğ
buf
, (
uch¬
*)
q
->
ªn
, 
Ën
 );

151 
q
->
ªn
[
Ën
] = 0;

153 
Ën
 = 
	`g‘_by‹
Ğ
buf
 );

154 
	`g‘_d©a
Ğ
buf
, (
uch¬
*)
q
->
šŒo
, 
Ën
 );

155 
q
->
šŒo
[
Ën
] = 0;

157 
	`g‘_tok’
Ğ
buf
, &
q
->
tok’_cmd
 );

159 
Ï¡_numb”
 = 
	`g‘_št
Ğ
buf
 );

160 
mÜe
 = 
	`g‘_by‹
Ğ
buf
 );

161  
buf
->
pos
 < buf->
Ën
 ){

162 
ušt
 
n
 = 
	`g‘_št
Ğ
buf
 );

163 
uch¬
 
Üg
 = 
	`g‘_by‹
Ğ
buf
 );

164 
uch¬
 
rŞe
 = 
	`g‘_by‹
Ğ
buf
 );

165 
qunmemb”
* 
m
 = 
	`qun_memb”_g‘
Ğ
qq
, 
q
, 
n
, 1 );

166 ifĞ
m
==
NULL
 ){

167 
	`DBG
("m==NULL");

170 
m
->
Üg
 = org;

171 
m
->
rŞe
 =„ole;

173 ifĞ
mÜe
 ){

174 
	`´Ù_qun_g‘_šfo
Ğ
qq
, 
q
->
numb”
, 
Ï¡_numb”
 );

176 
	`qun_upd©e_memb”šfo
Ğ
qq
, 
q
 );

177 
	`qun_£t_memb”s_off
Ğ
qq
, 
q
 );

178 
	`qun_upd©e_Úlše
Ğ
qq
, 
q
 );

180 
	}
}

182 
	$·r£_memb”šfo
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
, 
qqqun
* 
q
 )

184 
by‹bufãr
 *
buf
 = 
p
->buf;

185  
buf
->
pos
 < buf->
Ën
 ){

186 
ušt
 
numb”
 = 
	`g‘_št
Ğ
buf
 );

187 
qunmemb”
* 
m
 = 
	`qun_memb”_g‘
Ğ
qq
, 
q
, 
numb”
, 0 );

188 ifĞ!
m
 ){

189 
	`DBG
("m==NULL‚umb”: %d", 
numb”
);

192 
m
->
çû
 = 
	`g‘_wÜd
Ğ
buf
 );

193 
m
->
age
 = 
	`g‘_by‹
Ğ
buf
 );

194 
m
->
£x
 = 
	`g‘_by‹
Ğ
buf
 );

195 
uch¬
 
Çme_Ën
 = 
	`g‘_by‹
Ğ
buf
 );

196 
Çme_Ën
 = 
	`MIN
Ğ
NICKNAME_LEN
-1,‚ame_len );

197 
	`g‘_d©a
Ğ
buf
, (
uch¬
*)
m
->
nickÇme
, 
Çme_Ën
 );

198 
m
->
nickÇme
[
Çme_Ën
] = 0;

200 
	`gb_to_utf8
Ğ
m
->
nickÇme
, m->nickÇme, 
NICKNAME_LEN
-1 );

201 
	`g‘_wÜd
Ğ
buf
 );

202 
m
->
qqshow
 = 
	`g‘_by‹
Ğ
buf
 );

203 
m
->
æag
 = 
	`g‘_by‹
Ğ
buf
 );

205 
	}
}

207 
	$·r£_Úlše
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
, 
qqqun
* 
q
 )

209 
by‹bufãr
 *
buf
 = 
p
->buf;

210 
	`g‘_by‹
Ğ
buf
 );

212 
	`qun_£t_memb”s_off
Ğ
qq
, 
q
 );

213  
buf
->
pos
 < buf->
Ën
 ){

214 
ušt
 
numb”
 = 
	`g‘_št
Ğ
buf
 );

215 
qunmemb”
* 
m
 = 
	`qun_memb”_g‘
Ğ
qq
, 
q
, 
numb”
, 1 );

216 ifĞ
m
 )

217 
m
->
¡©us
 = 
QQ_ONLINE
;

219 
	`qun_put_sšgË_ev’t
Ğ
qq
, 
q
 );

220 
	}
}

222 
	$·r£_memb”Çme
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
, 
qqqun
* 
q
 )

224 
by‹bufãr
 *
buf
 = 
p
->buf;

225 
ušt
 
pos
;

226 
pos
 = 
	`g‘_št
Ğ
buf
 );

227 
	`g‘_št
Ğ
buf
 );

228  
buf
->
pos
 < buf->
Ën
 ){

229 
ušt
 
numb”
 = 
	`g‘_št
Ğ
buf
 );

230 
qunmemb”
* 
m
 = 
	`qun_memb”_g‘
Ğ
qq
, 
q
, 
numb”
, 0 );

231 ifĞ!
m
 ){

232 
	`DBG
("m==NULL");

235 
uch¬
 
Çme_Ën
 = 
	`g‘_by‹
Ğ
buf
 );

236 
Çme_Ën
 = 
	`MIN
Ğ
NICKNAME_LEN
-1,‚ame_len );

237 
	`g‘_d©a
Ğ
buf
, (
uch¬
*)
m
->
nickÇme
, 
Çme_Ën
 );

238 
m
->
nickÇme
[
Çme_Ën
] = 0;

240 
	}
}

242 
	$´Ù_qun_cmd_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 )

244 
by‹bufãr
 *
buf
 = 
p
->buf;

245 
uch¬
 
cmd
 = 
	`g‘_by‹
Ğ
buf
 );

246 
uch¬
 
»suÉ
 = 
	`g‘_by‹
Ğ
buf
 );

247 ifĞ
»suÉ
 != 0 ){

248 
	`DBG
("»suÉ = %d", 
»suÉ
 );

251 
ušt
 
numb”
 = 
	`g‘_št
Ğ
buf
 );

252 
qqqun
* 
q
 = 
	`qun_g‘
Ğ
qq
, 
numb”
, 0 );

253 ifĞ!
q
 ){

254 
	`DBG
("q==null");

257  
cmd
 ){

261 
	`·r£_qunšfo
Ğ
qq
, 
p
, 
q
 );

264 
	`·r£_memb”šfo
Ğ
qq
, 
p
, 
q
 );

267 
	`·r£_Úlše
Ğ
qq
, 
p
, 
q
 );

270 
	`·r£_memb”Çme
Ğ
qq
, 
p
, 
q
 );

273 
	`DBG
("unknowÀcmd = %x", 
cmd
 );

276 
	}
}

	@prot_user.c

14 
	~<time.h
>

15 
	~<¡dlib.h
>

16 
	~<¡ršg.h
>

17 #ifdeà
__WIN32__


18 
	~<wšsock.h
>

19 
	~<wšš‘.h
>

21 
	~<sys/sock‘.h
>

22 
	~<¬·/š‘.h
>

23 
	~<Ãtdb.h
>

26 
	~"qqş›Á.h
"

27 
	~"memÜy.h
"

28 
	~"debug.h
"

29 
	~"qq·ck‘.h
"

30 
	~"·ck‘mgr.h
"

31 
	~"´ÙocŞ.h
"

32 
	~"buddy.h
"

33 
	~"ut.h
"

35 
	$´Ù_u£r_k“p_®ive
Ğ
qqş›Á
* 
qq
 )

37 
qq·ck‘
* 
p
 = 
	`·ck‘mgr_Ãw_£nd
Ğ
qq
, 
QQ_CMD_KEEP_ALIVE
 );

38 ifĞ!
p
 ) ;

39 
by‹bufãr
 *
buf
 = 
p
->buf;

40 
num_¡r
[16];

41 
	`¥rštf
Ğ
num_¡r
, "%d", 
qq
->
numb”
 );

42 
	`put_d©a
Ğ
buf
, (
uch¬
*)
num_¡r
, 
	`¡¾’
(num_str) );

43 
	`po¡_·ck‘
Ğ
qq
, 
p
, 
SESSION_KEY
 );

44 
	}
}

46 
	$´Ù_u£r_k“p_®ive_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 )

48 
by‹bufãr
 *
buf
 = 
p
->buf;

49 
	`g‘_by‹
Ğ
buf
 );

50 
Úlšes
;

51 
Úlšes
 = 
	`g‘_št
Ğ
buf
 );

52 

;

53 

 = 
	`g‘_št
Ğ
buf
 );

54 
ushÜt
 
pÜt
 = 
	`g‘_wÜd
Ğ
buf
 );

55 
	`g‘_wÜd
Ğ
buf
 );

56 
ušt
 
£rv”_time
;

57 
£rv”_time
 = 
	`g‘_št
Ğ
buf
 );

59 
time_t
 
t
;

60 
t
 = 
	`CN_TIME
Ğ
£rv”_time
 );

61 
ev’t
[64];

62 
	`¥rštf
Ğ
ev’t
, "k“·live^$%u", 
qq
->
numb”
 );

63 
	`qqş›Á_put_ev’t
Ğ
qq
, 
ev’t
 );

65 
pÜt
 = 

= 0;

66 
	}
}

68 
	$´Ù_u£r_g‘_šfo
Ğ
qqş›Á
* 
qq
, 
ušt
 
numb”
 )

70 
qq·ck‘
* 
p
 = 
	`·ck‘mgr_Ãw_£nd
Ğ
qq
, 
QQ_CMD_GET_USER_INFO
 );

71 ifĞ!
p
 ) ;

72 
by‹bufãr
 *
buf
 = 
p
->buf;

73 
numb”_¡r
[16];

74 
	`¥rštf
Ğ
numb”_¡r
, "%u", 
numb”
 );

75 
	`put_d©a
Ğ
buf
, (
uch¬
*)
numb”_¡r
, 
	`¡¾’
(‚umber_str ) );

77 
p
->
m©ch
 = (
qq·ck‘
*)
numb”
;

78 
	`po¡_·ck‘
Ğ
qq
, 
p
, 
SESSION_KEY
 );

79 
	}
}

81 
	$´Ù_u£r_g‘_šfo_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 )

83 
by‹bufãr
 *
buf
 = 
p
->buf;

84 * 
¡r
 = (*)
buf
->
d©a
;

85 
ušt
 
numb”
;

86 
i
, 
j
, 
Ën
 = 
buf
->Ën, 
s
;

87 ifĞ!
p
->
m©ch
 )

89 
numb”
 = (
ušt
)
p
->
m©ch
->match;

91 
qqbuddy
* 
b
 = 
	`buddy_g‘
Ğ
qq
, 
numb”
, 1 );

92 ifĞ!
b
 )

94  
i
=0; i<
Ën
; i++ ){

95 ifĞ
¡r
[
i
] == 0x1E ) str[i] = '\0';

97 
¡r
[
i
] = '\0';

98  
i
=0, 
s
=0, 
j
=0; i<=
Ën
 && j<
MAX_USER_INFO
; i++ ){

99 ifĞ
¡r
[
i
] == '\0' ){

100 
	`¡ºıy
Ğ
b
->
šfo_¡ršg
[
j
], &
¡r
[
s
], 
i
-s );

101 
b
->
šfo_¡ršg
[
j
][
i
-
s
] = 0;

103 
j
++;

104 
s
 = 
i
+1;

109 
	`¡ºıy
Ğ
b
->
nickÇme
, b->
šfo_¡ršg
[1], 
NICKNAME_LEN
-1 );

110 
	`DBG
("gÙ u£¸šfØ%u(%s)", 
b
->
numb”
, b->
nickÇme
 );

111 
	}
}

113 
	$´Ù_u£r_chªge_¡©us
Ğ
qqş›Á
* 
qq
 )

115 
qq·ck‘
* 
p
 = 
	`·ck‘mgr_Ãw_£nd
Ğ
qq
, 
QQ_CMD_CHANGE_STATUS
 );

116 ifĞ!
p
 ) ;

117 
by‹bufãr
 *
buf
 = 
p
->buf;

118 
	`put_by‹
Ğ
buf
, 
qq
->
mode
 );

119 
	`put_št
Ğ
buf
, 0 );

120 
	`put_št
Ğ
buf
, 1 );

121 
	`put_wÜd
Ğ
buf
, 0 );

122 
	`po¡_·ck‘
Ğ
qq
, 
p
, 
SESSION_KEY
 );

123 
	}
}

125 
	$´Ù_u£r_chªge_¡©us_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 )

127 
by‹bufãr
 *
buf
 = 
p
->buf;

128 ifĞ
	`g‘_by‹
Ğ
buf
 ) == '0' ){

129 
qq
->
£lf
->
¡©us
 = qq->
mode
;

130 
	`DBG
("chªg¡©u tØ%d", 
qq
->
mode
 );

131 
ev’t
[16];

132 
	`¥rštf
Ğ
ev’t
, "¡©us^$%d", 
qq
->
mode
 );

133 
	`qqş›Á_put_ev’t
Ğ
qq
, 
ev’t
 );

135 
	`DBG
("change status failed.");

137 
	}
}

140 
	$´Ù_u£r_g‘_key
Ğ
qqş›Á
* 
qq
, 
uch¬
 
key
 )

142 
qq·ck‘
* 
p
 = 
	`·ck‘mgr_Ãw_£nd
Ğ
qq
, 
QQ_CMD_GET_KEY
 );

143 ifĞ!
p
 ) ;

144 
by‹bufãr
 *
buf
 = 
p
->buf;

145 
	`put_by‹
Ğ
buf
, 
key
 );

146 
	`po¡_·ck‘
Ğ
qq
, 
p
, 
SESSION_KEY
 );

147 
	}
}

149 
	$´Ù_u£r_g‘_key_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 )

151 
by‹bufãr
 *
buf
 = 
p
->buf;

152 
uch¬
 
cmd
, 
»suÉ
;

153 
uch¬
 
key
[16];

154 
tok’
 
tok
;

155 
cmd
 = 
	`g‘_by‹
Ğ
buf
 );

156 
»suÉ
 = 
	`g‘_by‹
Ğ
buf
 );

157 ifĞ
»suÉ
 != 0 ){

158 
	`DBG
("faildo get key.");

160  
cmd
 ){

162 
	`g‘_d©a
Ğ
buf
, 
key
, 16 );

163 
buf
->
pos
 += 12;

164 
	`g‘_tok’
Ğ
buf
, &
tok
 );

165 
	`memıy
Ğ
qq
->
d©a
.
fe_key
, 
key
, 16 );

166 
qq
->
d©a
.
fe_tok’
 = 
tok
;

167 
	`DBG
("got file key.");

170 
	`DBG
("got unknown key.");

172 
	}
}

174 
	$´Ù_u£r_g‘_nÙiû
Ğ
qqş›Á
* 
qq
, 
uch¬
 
ty³
 )

176 
qq·ck‘
* 
p
 = 
	`·ck‘mgr_Ãw_£nd
Ğ
qq
, 
QQ_CMD_GET_KEY
 );

177 ifĞ!
p
 ) ;

178 
by‹bufãr
 *
buf
 = 
p
->buf;

179 
p
->
Ãed_ack
 = 0;

180  
ty³
 ){

182 
	`put_št
Ğ
buf
, 
qq
->
numb”
 );

185 
	`put_št
Ğ
buf
, 
qq
->
numb”
 );

186 
	`put_wÜd
Ğ
buf
, 0x0007 );

187 
	`put_wÜd
Ğ
buf
, 0x0008 );

190 
	`DBG
("unknownype.");

192 
	`po¡_·ck‘
Ğ
qq
, 
p
, 
SESSION_KEY
 );

193 
	}
}

195 
	$´Ù_u£r_g‘_nÙiû_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 )

197 
by‹bufãr
 *
buf
 = 
p
->buf;

198 
uch¬
 
»suÉ
, 
cmd
;

199 
»suÉ
 = 
	`g‘_by‹
Ğ
buf
 );

200 
cmd
 = 
	`g‘_by‹
Ğ
buf
 );

201  
cmd
 ){

206 
ushÜt
 
Ën
 = 
	`g‘_wÜd
Ğ
buf
 );

207 * 
¡r
;

208 
	`NEW
Ğ
¡r
, 
Ën
+1 ,);

209 ifĞ!
¡r
 )

211 
	`g‘_d©a
Ğ
buf
, (
uch¬
*)
¡r
, 
Ën
 );

212 
¡r
[
Ën
] = 0;

213 
	`DBG
("nÙiû: %s", 
¡r
 );

214 
	`DEL
Ğ
¡r
 );

218 
	}
}

220 
	$´Ù_u£r_check_
Ğ
qqş›Á
* 
qq
 )

222 
qq·ck‘
* 
p
 = 
	`·ck‘mgr_Ãw_£nd
Ğ
qq
, 
QQ_CMD_CHECK_IP
 );

223 ifĞ!
p
 ) ;

224 
by‹bufãr
 *
buf
 = 
p
->buf;

225 
	`put_by‹
Ğ
buf
, 2 );

226 
	`put_by‹
Ğ
buf
, 2 );

227 
	`put_by‹
Ğ
buf
, 0 );

228 
	`put_št
Ğ
buf
, 0xD4020202 );

229 
	`put_št
Ğ
buf
, 
qq
->
Ï¡_logš_time
 );

230 
	`put_by‹
Ğ
buf
, 8 );

231 
	`put_by‹
Ğ
buf
, 3 );

232 
	`po¡_·ck‘
Ğ
qq
, 
p
, 
SESSION_KEY
 );

233 
	}
}

235 
	$´Ù_u£r_check__»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 )

237 
by‹bufãr
 *
buf
 = 
p
->buf;

238 
ushÜt
 
Ën
;

239 * 
¡r
, *
t
;

240 
	`NEW
Ğ
¡r
, 
buf
->
Ën
 ,);

241 ifĞ!
¡r
 ) ;

242 
t
 = 
¡r
;

243 ifĞ
	`g‘_by‹
Ğ
buf
 ) != 2 ){

244 
	`DBG
("reply != 2" );

247 ifĞ
buf
->
pos
 =ğbuf->
Ën
 )

249 
	`g‘_by‹
Ğ
buf
 );

250 
Ën
 = 
	`g‘_wÜd
Ğ
buf
 );

251 
	`g‘_d©a
Ğ
buf
, (
uch¬
*)
t
, 
Ën
 );

252 
t
 +ğ
Ën
;

253 
	`g‘_by‹
Ğ
buf
 );

254 
Ën
 = 
	`g‘_wÜd
Ğ
buf
 );

255 
	`g‘_d©a
Ğ
buf
, (
uch¬
*)
t
, 
Ën
 );

256 
t
 +ğ
Ën
;

257 
	`g‘_by‹
Ğ
buf
 );

258 
buf
->
pos
 += 9;

259 
Ën
 = 
	`g‘_wÜd
Ğ
buf
 );

260 
	`g‘_d©a
Ğ
buf
, (
uch¬
*)
t
, 
Ën
 );

261 
t
 +ğ
Ën
;

262 
	`g‘_by‹
Ğ
buf
 );

263 
	`g‘_wÜd
Ğ
buf
 );

264 
Ën
 = 
	`g‘_wÜd
Ğ
buf
 );

265 
	`g‘_d©a
Ğ
buf
, (
uch¬
*)
t
, 
Ën
 );

266 
t
 +ğ
Ën
;

267 
	`g‘_wÜd
Ğ
buf
 );

268 
	`g‘_by‹
Ğ
buf
 );

269 
Ën
 = 
	`g‘_wÜd
Ğ
buf
 );

270 
	`g‘_d©a
Ğ
buf
, (
uch¬
*)
t
, 
Ën
 );

271 
t
 +ğ
Ën
;

272 
	`g‘_wÜd
Ğ
buf
 );

273 
	`g‘_by‹
Ğ
buf
 );

274 
Ën
 = 
	`g‘_wÜd
Ğ
buf
 );

275 
	`g‘_d©a
Ğ
buf
, (
uch¬
*)
t
, 
Ën
 );

276 
t
 +ğ
Ën
;

277 
	`g‘_wÜd
Ğ
buf
 );

278 
	`g‘_by‹
Ğ
buf
 );

279 
Ën
 = 
	`g‘_wÜd
Ğ
buf
 );

280 
	`g‘_d©a
Ğ
buf
, (
uch¬
*)
t
, 
Ën
 );

281 
t
 +ğ
Ën
;

282 
	`g‘_wÜd
Ğ
buf
 );

283 
	`g‘_by‹
Ğ
buf
 );

284 
Ën
 = 
	`g‘_wÜd
Ğ
buf
 );

285 
	`g‘_d©a
Ğ
buf
, (
uch¬
*)
t
, 
Ën
 );

286 
t
 +ğ
Ën
;

287 
	`g‘_by‹
Ğ
buf
 );

288 
Ën
 = 
	`g‘_wÜd
Ğ
buf
 );

289 
	`g‘_d©a
Ğ
buf
, (
uch¬
*)
t
, 
Ën
 );

290 
t
 +ğ
Ën
;

291 *
t
 = 0;

293 
	`DEL
Ğ
¡r
 );

294 
	}
}

297 
	$´Ù_u£r_g‘_Ëv–
Ğ
qqş›Á
* 
qq
 )

299 
qq·ck‘
* 
p
 = 
	`·ck‘mgr_Ãw_£nd
Ğ
qq
, 
QQ_CMD_GET_LEVEL
 );

300 ifĞ!
p
 ) ;

301 
by‹bufãr
 *
buf
 = 
p
->buf;

302 
	`put_by‹
Ğ
buf
, 0x88 );

303 
	`put_št
Ğ
buf
, 
qq
->
numb”
 );

304 
	`put_by‹
Ğ
buf
, 0x00 );

305 
	`po¡_·ck‘
Ğ
qq
, 
p
, 
SESSION_KEY
 );

306 
	}
}

308 
	$´Ù_u£r_g‘_Ëv–_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 )

310 
by‹bufãr
 *
buf
 = 
p
->buf;

311 
uch¬
 
cmd
;

312 
cmd
 = 
	`g‘_by‹
Ğ
buf
 );

313 
	`g‘_št
Ğ
buf
 );

315  
cmd
 ){

317 
	`g‘_št
Ğ
buf
 );

318 
qq
->
Ëv–
 = 
	`g‘_wÜd
Ğ
buf
 );

319 
qq
->
aùive_days
 = 
	`g‘_wÜd
Ğ
buf
 );

320 
	`g‘_wÜd
Ğ
buf
 );

321 
qq
->
upg¿de_days
 = 
	`g‘_wÜd
Ğ
buf
 );

322 
	`DBG
("Ëv–: %d‡ùive_days: %d upg¿de_days: %d", 
qq
->
Ëv–
,

323 
qq
->
aùive_days
, qq->
upg¿de_days
 );

324 
ev’t
[32];

325 
	`¥rštf
Ğ
ev’t
, "Ëv–^$%d^$%d^$%d", 
qq
->
Ëv–
,

326 
qq
->
aùive_days
, qq->
upg¿de_days
 );

327 
	`qqş›Á_put_ev’t
Ğ
qq
, 
ev’t
 );

330 
	`DBG
("unknowÀcmd: 0x%x", 
cmd
 );

334 
	}
}

336 
	$´Ù_u£r_»que¡_tok’
Ğ
qqş›Á
* 
qq
, 
ušt
 
numb”
, 
uch¬
 
İ”©iÚ
, 
ushÜt
 
ty³
, ušˆ
code
 )

338 
qq·ck‘
* 
p
 = 
	`·ck‘mgr_Ãw_£nd
Ğ
qq
, 
QQ_CMD_REQUEST_TOKEN
 );

339 ifĞ!
p
 ) ;

340 
by‹bufãr
 *
buf
 = 
p
->buf;

341 
qq
->
d©a
.
İ”©iÚ
 = operation;

342 ifĞ
code
 ){

343 
	`put_by‹
Ğ
buf
, 2 );

344 
	`put_wÜd
Ğ
buf
, 
ty³
 );

345 
	`put_št
Ğ
buf
, 
numb”
 );

346 
	`put_wÜd
Ğ
buf
, 4 );

347 
	`put_št
Ğ
buf
, 
	`htÚl
(
code
) );

348 
	`put_wÜd
Ğ
buf
, 
	`¡¾’
(
qq
->
d©a
.
qq£ssiÚ
));

349 
	`put_d©a
Ğ
buf
, (
uch¬
*)
qq
->
d©a
.
qq£ssiÚ
, 
	`¡¾’
(qq->data.qqsession));

351 
	`put_by‹
Ğ
buf
, 1 );

352 
	`put_wÜd
Ğ
buf
, 
ty³
 );

353 
	`put_št
Ğ
buf
, 
numb”
 );

354 
qq
->
d©a
.
İ”©šg_numb”
 = 
numb”
 ;

356 
	`po¡_·ck‘
Ğ
qq
, 
p
, 
SESSION_KEY
 );

357 
	}
}

359 
	$´Ù_u£r_»que¡_tok’_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 )

361 
by‹bufãr
 *
buf
 = 
p
->buf;

362 
uch¬
 
cmd
 = 
	`g‘_by‹
Ğ
buf
 );

363 
	`g‘_wÜd
Ğ
buf
 );

364 
uch¬
 
v”ify
 = 
	`g‘_by‹
Ğ
buf
 );

365 ifĞ
v”ify
 ){

366 *
u¾
, *
d©a
, *
£ssiÚ
;

367 
d©®’
 = 
	`KB
(4);

368 
	`DBG
("need verifying...");

369 ifĞ
buf
->
pos
 =ğbuf->
Ën
 ) {

370 
	`puts
("Verifying code is incorrect!");

373 
	`NEW
Ğ
d©a
, 
d©®’
 ,);

374 
	`NEW
Ğ
u¾
, 128 ,);

375 
	`NEW
Ğ
£ssiÚ
, 128 ,);

376 
Ën
, 
»t
;

377 
Ën
 = 
	`g‘_wÜd
Ğ
buf
 );

378 ifĞ
Ën
 >= 128 ){

379 
	`DBG
("url isoo†ong."); ;

381 
	`g‘_d©a
Ğ
buf
, (
uch¬
*)
u¾
, 
Ën
 );

382 
»t
 = 
	`h‰p_»que¡
Ğ&
qq
->
h‰p_sock
, 
u¾
, 
£ssiÚ
, 
d©a
, &
d©®’
 );

383 ifĞ
»t
 == 0 ){

384 
·th
[
PATH_LEN
];

385 
	`¥rštf
Ğ
·th
, "%s/%u.jpg", 
qq
->
v”ify_dœ
, qq->
numb”
 );

386 
FILE
 *
å
;

387 
å
 = 
	`fİ’
Ğ
·th
, "wb" );

388 
	`DBG
("gÙ…ng‡ˆ%s", 
·th
 );

389 ifĞ
å
 ){

390 
	`fwr™e
Ğ
d©a
, 
d©®’
, 1, 
å
 );

391 
	`fşo£
Ğ
å
 );

393 
	`¡ºıy
Ğ
qq
->
d©a
.
qq£ssiÚ
, 
£ssiÚ
, 127 );

394 
	`qqş›Á_£t_´oûss
Ğ
qq
, 
P_VERIFYING
 );

395 
	`puts
("You‚eedo inputhe verifying code.");

397 
	`DBG
("h‰p_»que¡ faed.„‘=%d", 
»t
 );

399 
	`DEL
Ğ
d©a
 );

400 
	`DEL
Ğ
u¾
 );

401 
	`DEL
Ğ
£ssiÚ
 );

403 
	`g‘_tok’
Ğ
buf
, &
qq
->
d©a
.
u£r_tok’
 );

404 
qq
->
d©a
.
u£r_tok’_time
 = 
	`time
(
NULL
);

405 
	`DBG
("gotoken");

406 
qqbuddy
 *
b
 = 
	`buddy_g‘
Ğ
qq
, qq->
d©a
.
İ”©šg_numb”
, 0 );

407 ifĞ
b
 ){

408  
qq
->
d©a
.
İ”©iÚ
 ){

409 
OP_ADDBUDDY
:

410 ifĞ
b
->
v”ify_æag
 =ğ
VF_VERIFY
 ){

411 
	`´Ù_buddy_v”ify_addbuddy
Ğ
qq
, 02, qq->
d©a
.
İ”©šg_numb”
 );

412 }ifĞ
b
->
v”ify_æag
 =ğ
VF_OK
 ){

413 
	`´Ù_buddy_v”ify_addbuddy
Ğ
qq
, 00, qq->
d©a
.
İ”©šg_numb”
 );

416 
OP_DELBUDDY
:

417 
	`´Ù_buddy_d–_buddy
Ğ
qq
, qq->
d©a
.
İ”©šg_numb”
 );

422 
cmd
 = 0;

423 
	}
}

	@protocol.c

14 
	~<¡ršg.h
>

15 
	~<¡dlib.h
>

16 
	~<time.h
>

17 #ifdeà
__WIN32__


18 
	~<wšsock.h
>

19 
	~<wšš‘.h
>

21 
	~<sys/sock‘.h
>

22 
	~<¬·/š‘.h
>

23 
	~<Ãtdb.h
>

26 
	~"qqdef.h
"

27 
	~"qqş›Á.h
"

28 
	~"qqüy±.h
"

29 
	~"debug.h
"

30 
	~"memÜy.h
"

31 
	~"´ÙocŞ.h
"

34 
	$po¡_·ck‘
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
, 
key_ty³
 )

36 
by‹bufãr
* 
buf
 = 
p
->buf;

37 
h—d_Ën
 = 
qq
->
ÃtwÜk
==
TCP
 ? 13 : 11;

38 ifĞ
qq
->
log_·ck‘
 ){

39 
	`DBG
("[%d] s’d…ack‘ cmd: %x seq: %x", 
qq
->
numb”
, 
p
->
commªd
,…->
£qno
 );

40 
	`hex_dump
Ğ
buf
->
d©a
, buf->
pos
 );

42 
uch¬
* 
’üy±ed
;

43  
key_ty³
 )

45 
NO_KEY
:

47 ifĞ
buf
->
pos
+
h—d_Ën
+1 <ğbuf->
size
 ){

48 
	`memmove
Ğ
buf
->
d©a
+
h—d_Ën
, buf->d©a, buf->
pos
 );

49 
buf
->
pos
 +ğ
h—d_Ën
;

53 
RANDOM_KEY
:

55 
	`NEW
Ğ
’üy±ed
, 
PACKET_SIZE
 ,
uch¬
);

56 ifĞ!
’üy±ed
 ) {

57 
	`DBG
("Error:ƒncrypted‚ot‡llocated.");

60 
out_Ën
 = 
PACKET_SIZE
;

61 
	`qq’üy±
Ğ
buf
->
d©a
, buf->
pos
, 
p
->
key
, 
’üy±ed
, &
out_Ën
 );

63 ifĞ
p
->
commªd
 =ğ
QQ_CMD_LOGIN_SEND_INFO
 ||…->commªd =ğ
QQ_CMD_LOGIN_GET_INFO
 ||

64 
p
->
commªd
 =ğ
QQ_CMD_LOGIN_GET_LIST
 ){

65 ifĞ
out_Ën
+
h—d_Ën
+1+(2+
qq
->
d©a
.
logš_šfo_magic
.
Ën
è<ğ
buf
->
size
 ){

66 *(
ushÜt
*)(
buf
->
d©a
+
h—d_Ën
èğ
	`htÚs
Ğ
qq
->d©a.
logš_šfo_magic
.
Ën
 );

67 
	`memıy
Ğ
buf
->
d©a
+
h—d_Ën
+2, 
qq
->d©a.
logš_šfo_magic
.d©a, qq->d©a.logš_šfo_magic.
Ën
 );

68 
	`memıy
Ğ
buf
->
d©a
+
qq
->d©a.
logš_šfo_magic
.
Ën
+
h—d_Ën
+2, 
’üy±ed
, 
out_Ën
 );

69 
buf
->
pos
 = 
out_Ën
+
qq
->
d©a
.
logš_šfo_magic
.
Ën
+
h—d_Ën
+2;

71 
	`DBG
("encrypted data isoo†argeo store inhe…acket.");

74 ifĞ
out_Ën
+16+
h—d_Ën
+1 <ğ
buf
->
size
 ){

75 
	`memıy
Ğ
buf
->
d©a
+
h—d_Ën
, 
p
->
key
, 16 );

76 
	`memıy
Ğ
buf
->
d©a
+16+
h—d_Ën
, 
’üy±ed
, 
out_Ën
 );

77 
buf
->
pos
 = 
out_Ën
+16+
h—d_Ën
;

79 
	`DBG
("encrypted data isoo†argeo store inhe…acket.");

82 
	`DEL
Ğ
’üy±ed
 );

85 
SESSION_KEY
:

87 
	`NEW
Ğ
’üy±ed
, 
PACKET_SIZE
 ,
uch¬
);

88 ifĞ!
’üy±ed
 ) {

89 
	`DBG
("Error:ƒncrypted‚ot‡llocated.");

92 
out_Ën
 = 
PACKET_SIZE
;

93 
	`qq’üy±
Ğ
buf
->
d©a
, buf->
pos
, 
qq
->d©a.
£ssiÚ_key
, 
’üy±ed
, &
out_Ën
 );

95 ifĞ
out_Ën
+
h—d_Ën
+1 <ğ
buf
->
size
 ){

96 
	`memıy
Ğ
buf
->
d©a
+
h—d_Ën
, 
’üy±ed
, 
out_Ën
 );

97 
buf
->
pos
 = 
out_Ën
+
h—d_Ën
;

99 
	`DBG
("encrypted data isoo†argeo store inhe…acket.");

101 
	`DEL
Ğ
’üy±ed
 );

106 
	`put_by‹
Ğ
buf
, 
p
->

 );

107 
buf
->
Ën
 = buf->
pos
;

108 
buf
->
pos
 = 0;

110 ifĞ
qq
->
ÃtwÜk
 =ğ
TCP
 )

111 
	`put_wÜd
Ğ
buf
, buf->
Ën
 );

112 
	`put_by‹
Ğ
buf
, 
p
->
h—d
 );

113 
	`put_wÜd
Ğ
buf
, 
p
->
v”siÚ
 );

114 
	`put_wÜd
Ğ
buf
, 
p
->
commªd
 );

115 
	`put_wÜd
Ğ
buf
, 
p
->
£qno
 );

116 
	`put_št
Ğ
buf
, 
qq
->
numb”
 );

117 
p
->
key_ty³
 = key_type;

118  
	`·ck‘mgr_put
Ğ
qq
, 
p
 );

119 
	}
}

121 
	$deüy±_w™h_key
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
, 
by‹bufãr
* 
buf
, 
uch¬
* 
key
 )

123 
out_Ën
 = 
PACKET_SIZE
;

124 
h—d_Ën
 = 
qq
->
ÃtwÜk
==
TCP
 ? 9 : 7;

125 
uch¬
* 
deüy±ed
;

126 
	`NEW
Ğ
deüy±ed
, 
PACKET_SIZE
 ,
uch¬
);

127 ifĞ!
deüy±ed
 ) {

128 
	`DBG
("Error: decrypted‚ot‡llocated.");

131 
»t
 = 
	`qqdeüy±
Ğ
buf
->
d©a
+
h—d_Ën
, buf->
Ën
-h—d_Ën-1, 
key
, 
deüy±ed
, &
out_Ën
 );

132 ifĞ
»t
 ){

134 ifĞ!
p
->
buf
 )

136 ifĞ
out_Ën
 < 
PACKET_SIZE
 )

137 
	`memıy
Ğ
p
->
buf
->
d©a
, 
deüy±ed
, 
out_Ën
 );

139 
	`DBG
("WrÚg out_ËÀ: %d", 
out_Ën
 );

140 
p
->
buf
->
pos
 = 0;

141 
p
->
buf
->
Ën
 = 
out_Ën
;

143 
	`DEL
Ğ
deüy±ed
 );

144  
»t
;

145 
	}
}

147 
	$deüy±_·ck‘
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
, 
by‹bufãr
* 
buf
 )

150 
h—d_Ën
 = 
qq
->
ÃtwÜk
==
TCP
 ? 9 : 7;

151 ifĞ
p
->
m©ch
 ){

152  
p
->
m©ch
->
key_ty³
 ){

153 
NO_KEY
:

154 
	`memıy
Ğ
p
->
buf
->
d©a
, buf->d©a+
h—d_Ën
, buf->
Ën
-head_len-1 );

155 
p
->
buf
->
Ën
 = buf->Ën-
h—d_Ën
-1;

156 
p
->
buf
->
pos
 = 0;

158 
RANDOM_KEY
:

160 ifĞ
p
->
commªd
 =ğ
QQ_CMD_LOGIN_VERIFY
 ){

161 ifĞ
	`deüy±_w™h_key
Ğ
qq
, 
p
, 
buf
, qq->
d©a
.
v”ify_key2
 ) )

164 ifĞ
p
->
commªd
 =ğ
QQ_CMD_LOGIN_SEND_INFO
 ||…->commªd =ğ
QQ_CMD_LOGIN_GET_LIST
 ){

165 ifĞ
	`deüy±_w™h_key
Ğ
qq
, 
p
, 
buf
, qq->
d©a
.
logš_šfo_key2
 ) )

168 ifĞ
	`deüy±_w™h_key
Ğ
qq
, 
p
, 
buf
,…->
m©ch
->
key
 ) )

172 
SESSION_KEY
:

174 ifĞ
	`deüy±_w™h_key
Ğ
qq
, 
p
, 
buf
, qq->
d©a
.
£ssiÚ_key
 ) )

180 ifĞ
	`deüy±_w™h_key
Ğ
qq
, 
p
, 
buf
, qq->
d©a
.
£ssiÚ_key
 ) )

183 ifĞ
	`deüy±_w™h_key
Ğ
qq
, 
p
, 
buf
, qq->
md5_·ss2
 ) )

185 
	`DBG
("ÿÂÙ deüy±…ack‘. cmd:%x", 
p
->
commªd
 );

188 
	}
}

190 
	$´oûss_·ck‘
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
, 
by‹bufãr
* 
buf
 )

192 ifĞ!
	`deüy±_·ck‘
Ğ
qq
, 
p
, 
buf
 ) )

194 ifĞ
qq
->
log_·ck‘
 ){

195 
	`DBG
("[%d]„ecv…ack‘ v”:%x cmd: %x seqno: %x", 
qq
->
numb”
, 
p
->
v”siÚ
,…->
commªd
,…->
£qno
 );

196 
	`hex_dump
Ğ
p
->
buf
->
d©a
,…->buf->
Ën
 );

198  
p
->
commªd
 ){

199 
QQ_CMD_TOUCH
:

200 
	`´Ù_logš_touch_»¶y
Ğ
qq
, 
p
 );

202 
QQ_CMD_LOGIN_REQUEST
:

203 
	`´Ù_logš_»que¡_»¶y
Ğ
qq
, 
p
 );

205 
QQ_CMD_LOGIN_VERIFY
:

206 
	`´Ù_logš_v”ify_»¶y
Ğ
qq
, 
p
 );

208 
QQ_CMD_LOGIN_GET_INFO
:

209 
	`´Ù_logš_g‘_šfo_»¶y
Ğ
qq
, 
p
 );

211 
QQ_CMD_LOGIN_GET_LIST
:

212 
	`´Ù_logš_g‘_li¡_»¶y
Ğ
qq
, 
p
 );

214 
QQ_CMD_LOGIN_SEND_INFO
:

215 
	`´Ù_logš_£nd_šfo_»¶y
Ğ
qq
, 
p
 );

217 
QQ_CMD_KEEP_ALIVE
:

218 
	`´Ù_u£r_k“p_®ive_»¶y
Ğ
qq
, 
p
 );

220 
QQ_CMD_RECV_IM_09
:

221 
QQ_CMD_RECV_IM
:

222 
	`´Ù_im_»cv_msg
Ğ
qq
, 
p
 );

224 
QQ_CMD_CHANGE_STATUS
:

225 
	`´Ù_u£r_chªge_¡©us_»¶y
Ğ
qq
, 
p
 );

227 #iâdeà
NO_BUDDY_INFO


228 
QQ_CMD_GET_BUDDY_LIST
:

229 
	`´Ù_buddy_upd©e_li¡_»¶y
Ğ
qq
, 
p
 );

231 
QQ_CMD_GET_BUDDY_ONLINE
:

232 
	`´Ù_buddy_upd©e_Úlše_»¶y
Ğ
qq
, 
p
 );

234 
QQ_CMD_BUDDY_STATUS
:

235 
	`´Ù_buddy_¡©us
Ğ
qq
, 
p
 );

238 #iâdeà
NO_QUN_INFO


239 
QQ_CMD_QUN_CMD
:

240 
	`´Ù_qun_cmd_»¶y
Ğ
qq
, 
p
 );

243 
QQ_CMD_GET_KEY
:

244 
	`´Ù_u£r_g‘_key_»¶y
Ğ
qq
, 
p
 );

246 
QQ_CMD_GET_NOTICE
:

247 
	`´Ù_u£r_g‘_nÙiû_»¶y
Ğ
qq
, 
p
 );

249 
QQ_CMD_CHECK_IP
:

250 
	`´Ù_u£r_check__»¶y
Ğ
qq
, 
p
 );

252 #iâdeà
NO_BUDDY_DETAIL_INFO


253 
QQ_CMD_GET_USER_INFO
:

254 
	`´Ù_u£r_g‘_šfo_»¶y
Ğ
qq
, 
p
 );

256 
QQ_CMD_GET_BUDDY_SIGN
:

257 
	`´Ù_buddy_upd©e_sign™u»_»¶y
Ğ
qq
, 
p
 );

259 
QQ_CMD_ACCOUNT
:

260 
	`´Ù_buddy_upd©e_accouÁ_»¶y
Ğ
qq
, 
p
 );

262 
QQ_CMD_BUDDY_ALIAS
:

263 
	`´Ù_buddy_upd©e_®Ÿs_»¶y
Ğ
qq
, 
p
 );

266 #iâdeà
NO_GROUP_INFO


267 
QQ_CMD_GROUP_LABEL
:

268 
	`´Ù_group_dowÆßd_Ïb–s_»¶y
Ğ
qq
, 
p
 );

271 
QQ_CMD_SEND_IM
:

273 
QQ_CMD_BROADCAST
:

274 
	`´Ù_misc_brßdÿ¡
Ğ
qq
, 
p
 );

276 
QQ_CMD_GET_LEVEL
:

277 
	`´Ù_u£r_g‘_Ëv–_»¶y
Ğ
qq
, 
p
 );

279 
QQ_CMD_ADDBUDDY_REQUEST
:

280 
	`´Ù_buddy_»que¡_addbuddy_»¶y
Ğ
qq
, 
p
 );

282 
QQ_CMD_ADDBUDDY_VERIFY
:

283 
	`´Ù_buddy_v”ify_addbuddy_»¶y
Ğ
qq
, 
p
 );

285 
QQ_CMD_REQUEST_TOKEN
:

286 
	`´Ù_u£r_»que¡_tok’_»¶y
Ğ
qq
, 
p
 );

288 
QQ_CMD_DEL_BUDDY
:

289 
	`´Ù_buddy_d–_buddy_»¶y
Ğ
qq
, 
p
 );

292 
	`DBG
("unknowÀcmd: %x", 
p
->
commªd
 );

293 
	`hex_dump
Ğ
p
->
buf
->
d©a
,…->buf->
Ën
 );

297 
	}
}

	@protocol.h

1 #iâdeà
_PROTOCOL_H


2 
	#_PROTOCOL_H


	)

4 
	~"qqdef.h
"

5 
	~"qq·ck‘.h
"

7 
	sqqd©a_2009
{

8 
uch¬
 
	mloÿË
[6];

9 
uch¬
 
	mv”siÚ_¥ec
[12];

10 
uch¬
 
	m£ssiÚ_key
[16];

11 
uch¬
 
	mim_key
[16];

12 
uch¬
 
	mfe_key
[16];

13 
uch¬
 
	mv”ify_key1
[16];

14 
uch¬
 
	mv”ify_key2
[16];

15 
ušt
 
	mlogš_šfo_unknown1
;

16 
ušt
 
	mlogš_šfo_unknown2
;

17 
uch¬
 
	mexe_hash
[16];

19 
uch¬
 
	m£rv”_d©a
[15];

21 
ushÜt
 
	mw_»dœeù_couÁ
;

22 
uch¬
 
	mc_»dœeù_couÁ
;

23 
ušt
 
	mcÚn_i¥_id
;

24 
ušt
 
	m£rv”_»v”£
;

25 
ušt
 
	mcÚn_
;

26 }
__©Œibu‹__
((
·cked
)è
	m£rv”_šfo
;

28 
tok’
 
	mlogš_tok’
;

29 
tok’
 
	mv”ify_tok’
;

30 
tok’
 
	mfe_tok’
;

31 
tok’
 
	mtok’_c
;

32 
tok’
 
	mlogš_šfo_tok’
;

33 
tok’
 
	mlogš_šfo_d©a
;

34 
tok’
 
	mlogš_šfo_magic
;

35 
tok’
 
	mlogš_šfo_Ïrge
;

36 
uch¬
 
	mlogš_šfo_key1
[16];

37 
uch¬
 
	mlogš_šfo_key2
[16];

38 
uch¬
 
	mlogš_li¡_couÁ
;

39 
tok’
 
	mu£r_tok’
;

40 
time_t
 
	mu£r_tok’_time
;

41 
ušt
 
	mİ”©šg_numb”
;

42 
uch¬
 
	mİ”©iÚ
;

43 
	mqq£ssiÚ
[128];

44 
	maddbuddy_¡r
[64];

48 
	mOP_ADDBUDDY
 = 0x01,

49 
	mOP_DELBUDDY


53 
	mVF_OK
 = 0x00,

54 
	mVF_VERIFY
 = 0x01,

55 
	mVF_REJECT
 = 0x02,

56 
	mVF_QUESTION
 = 0x03,

60 
	mQQ_IM_TEXT
 = 0x01,

61 
	mQQ_IM_AUTO_REPLY
 = 0x02

64 
	mQQ_RECV_IM_BUDDY_0801
 = 0x0009,

65 
	mQQ_RECV_IM_TO_UNKNOWN
 = 0x000a,

66 
	mQQ_RECV_IM_NEWS
 = 0x0018,

67 
	mQQ_RECV_IM_UNKNOWN_QUN_IM
 = 0x0020,

68 
	mQQ_RECV_IM_ADD_TO_QUN
 = 0x0021,

69 
	mQQ_RECV_IM_DEL_FROM_QUN
 = 0x0022,

70 
	mQQ_RECV_IM_APPLY_ADD_TO_QUN
 = 0x0023,

71 
	mQQ_RECV_IM_APPROVE_APPLY_ADD_TO_QUN
 = 0x0024,

72 
	mQQ_RECV_IM_REJCT_APPLY_ADD_TO_QUN
 = 0x0025,

73 
	mQQ_RECV_IM_CREATE_QUN
 = 0x0026,

74 
	mQQ_RECV_IM_TEMP_QUN_IM
 = 0x002A,

75 
	mQQ_RECV_IM_QUN_IM
 = 0x002B,

76 
	mQQ_RECV_IM_QUN_IM_09
 = 0x0052,

77 
	mQQ_RECV_IM_SYS_NOTIFICATION
 = 0x0030,

78 
	mQQ_RECV_IM_BUDDY_0802
 = 0x0084,

79 
	mQQ_RECV_IM_QUN_MEMBER_IM
 = 0x008C,

80 
	mQQ_RECV_IM_WRITING
 = 0x0079,

81 
	mQQ_RECV_IM_BUDDY_09
 = 0x0078

84 
	mQQ_NORMAL_IM_TEXT
 = 0x000b,

85 
	mQQ_NORMAL_IM_FILE_REQUEST_TCP
 = 0x0001,

86 
	mQQ_NORMAL_IM_FILE_APPROVE_TCP
 = 0x0003,

87 
	mQQ_NORMAL_IM_FILE_REJECT_TCP
 = 0x0005,

88 
	mQQ_NORMAL_IM_FILE_REQUEST_UDP
 = 0x0035,

89 
	mQQ_NORMAL_IM_FILE_APPROVE_UDP
 = 0x0037,

90 
	mQQ_NORMAL_IM_FILE_REJECT_UDP
 = 0x0039,

91 
	mQQ_NORMAL_IM_FILE_NOTIFY
 = 0x003b,

92 
	mQQ_NORMAL_IM_FILE_PASV
 = 0x003f,

93 
	mQQ_NORMAL_IM_FILE_CANCEL
 = 0x0049,

94 
	mQQ_NORMAL_IM_FILE_EX_REQUEST_UDP
 = 0x81,

95 
	mQQ_NORMAL_IM_FILE_EX_REQUEST_ACCEPT
 = 0x83,

96 
	mQQ_NORMAL_IM_FILE_EX_REQUEST_CANCEL
 = 0x85,

97 
	mQQ_NORMAL_IM_FILE_EX_NOTIFY_IP
 = 0x87

100 
	eKEY_TYPE
{

101 
	mNO_KEY
,

102 
	mRANDOM_KEY
,

103 
	mSESSION_KEY
,

104 
	mLOGIN_KEY
,

105 
	mIM_KEY


108 
	eVERIFY_MODE
{

109 
	mVM_NO
,

110 
	mVM_GET
,

111 
	mVM_ANSWER


114 
	eQQ_CMD
{

115 
	mQQ_CMD_TOUCH
 = 0x0091,

116 
	mQQ_CMD_LOGOUT
 = 0x0062,

117 
	mQQ_CMD_LOGIN_REQUEST
 = 0x00ba,

118 
	mQQ_CMD_LOGIN_GET_INFO
 = 0x00e5,

119 
	mQQ_CMD_LOGIN_SEND_INFO
 = 0x0030,

120 
	mQQ_CMD_LOGIN_GET_LIST
 = 0x0018,

121 
	mQQ_CMD_KEEP_ALIVE
 = 0x0058,

122 
	mQQ_CMD_GET_USER_INFO
 = 0x0006,

123 
	mQQ_CMD_CHANGE_STATUS
 = 0x000d,

124 
	mQQ_CMD_SEND_IM
 = 0x00cd,

125 
	mQQ_CMD_RECV_IM
 = 0x0017,

126 
	mQQ_CMD_RECV_IM_09
 = 0x00ce,

127 
	mQQ_CMD_GET_KEY
 = 0x001d,

128 
	mQQ_CMD_GET_BUDDY_LIST
 = 0x0126,

129 
	mQQ_CMD_GET_BUDDY_ONLINE
 = 0x0027,

130 
	mQQ_CMD_QUN_CMD
 = 0x0002,

131 
	mQQ_CMD_BUDDY_ALIAS
 = 0x003e,

132 
	mQQ_CMD_GROUP_LABEL
 = 0x0001,

133 
	mQQ_CMD_GET_LEVEL
 = 0x005C,

134 
	mQQ_CMD_GET_BUDDY_SIGN
 = 0x0067,

135 
	mQQ_CMD_BROADCAST
 = 0x0080,

136 
	mQQ_CMD_BUDDY_STATUS
 = 0x0081,

137 
	mQQ_CMD_ADDBUDDY_REQUEST
 = 0x00A7,

138 
	mQQ_CMD_ADDBUDDY_VERIFY
 = 0x00A8,

139 
	mQQ_CMD_ADDBUDDY_QUESTION
 = 0x00B7,

140 
	mQQ_CMD_ACCOUNT
 = 0x00b5,

141 
	mQQ_CMD_GET_NOTICE
 = 0x00d4,

142 
	mQQ_CMD_CHECK_IP
 = 0x00da,

143 
	mQQ_CMD_LOGIN_VERIFY
 = 0x00dd,

144 
	mQQ_CMD_REQUEST_TOKEN
 = 0x00ae,

145 
	mQQ_CMD_DEL_BUDDY
 = 0x000a

148 
	gqqş›Á
;

150 
´Ù_logš_touch
Ğ
qqş›Á
* 
qq
 );

151 
´Ù_logš_touch_w™h_šfo
Ğ
qqş›Á
* 
qq
, 
uch¬
* 
£rv”_šfo
, uch¬ 
Ën
 );

152 
´Ù_logš_touch_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 );

153 
´Ù_logš_»que¡
Ğ
qqş›Á
* 
qq
, 
tok’
* 
tok
, 
ušt
 
code
, 
²g_d©a
 );

154 
´Ù_logš_»que¡_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 );

155 
´Ù_logš_v”ify
Ğ
qqş›Á
* 
qq
 );

156 
´Ù_logš_v”ify_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 );

157 
´Ù_logš_g‘_šfo
Ğ
qqş›Á
* 
qq
 );

158 
´Ù_logš_g‘_šfo_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 );

159 
´Ù_logš_£nd_šfo
Ğ
qqş›Á
* 
qq
 );

160 
´Ù_logš_£nd_šfo_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 );

161 
´Ù_logš_logout
Ğ
qqş›Á
* 
qq
 );

162 
´Ù_logš_g‘_li¡
Ğ
qqş›Á
* 
qq
, 
ushÜt
 
pos
 );

163 
´Ù_logš_g‘_li¡_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 );

165 
´Ù_misc_brßdÿ¡
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 );

167 
´Ù_u£r_g‘_šfo
Ğ
qqş›Á
* 
qq
, 
ušt
 
numb”
 );

168 
´Ù_u£r_g‘_šfo_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 );

169 
´Ù_u£r_chªge_¡©us
Ğ
qqş›Á
* 
qq
 );

170 
´Ù_u£r_chªge_¡©us_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 );

171 
´Ù_u£r_g‘_nÙiû
Ğ
qqş›Á
* 
qq
, 
uch¬
 
ty³
 );

172 
´Ù_u£r_g‘_nÙiû_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 );

173 
´Ù_u£r_g‘_key
Ğ
qqş›Á
* 
qq
, 
uch¬
 
key
 );

174 
´Ù_u£r_g‘_key_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 );

175 
´Ù_u£r_check_
Ğ
qqş›Á
* 
qq
 );

176 
´Ù_u£r_check__»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 );

177 
´Ù_u£r_k“p_®ive
Ğ
qqş›Á
* 
qq
 );

178 
´Ù_u£r_k“p_®ive_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 );

179 
´Ù_u£r_g‘_Ëv–
Ğ
qqş›Á
* 
qq
 );

180 
´Ù_u£r_g‘_Ëv–_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 );

181 
´Ù_u£r_»que¡_tok’
Ğ
qqş›Á
* 
qq
, 
ušt
 
numb”
, 
uch¬
 
İ”©iÚ
, 
ushÜt
 
ty³
, ušˆ
code
 );

182 
´Ù_u£r_»que¡_tok’_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 );

184 
´Ù_im_ack_»cv
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
´e
 );

185 
´Ù_im_»cv_msg
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 );

186 
´Ù_im_£nd_msg
Ğ
qqş›Á
* 
qq
, 
ušt
 
to
, * 
msg
 );

188 
´Ù_buddy_upd©e_li¡
Ğ
qqş›Á
* 
qq
, 
ushÜt
 
pos
 );

189 
´Ù_buddy_upd©e_li¡_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 );

190 
´Ù_buddy_upd©e_Úlše
Ğ
qqş›Á
* 
qq
, 
ušt
 
Ãxt_numb”
 );

191 
´Ù_buddy_upd©e_Úlše_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 );

192 
´Ù_buddy_¡©us
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 );

193 
´Ù_buddy_upd©e_sign™u»
Ğ
qqş›Á
* 
qq
, 
ušt
 
pos
 );

194 
´Ù_buddy_upd©e_sign™u»_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 );

195 
´Ù_buddy_upd©e_accouÁ
Ğ
qqş›Á
* 
qq
, 
ušt
 
pos
 );

196 
´Ù_buddy_upd©e_accouÁ_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 );

197 
´Ù_buddy_upd©e_®Ÿs
Ğ
qqş›Á
* 
qq
 );

198 
´Ù_buddy_upd©e_®Ÿs_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 );

199 
´Ù_buddy_»que¡_addbuddy
Ğ
qqş›Á
* 
qq
, 
ušt
 
numb”
 );

200 
´Ù_buddy_»que¡_addbuddy_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 );

201 
´Ù_buddy_v”ify_addbuddy
Ğ
qqş›Á
* 
qq
, 
uch¬
 
cmd
, 
ušt
 
numb”
 );

202 
´Ù_buddy_v”ify_addbuddy_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 );

203 
´Ù_buddy_d–_buddy
Ğ
qqş›Á
* 
qq
, 
ušt
 
numb”
 );

204 
´Ù_buddy_d–_buddy_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 );

206 
´Ù_group_dowÆßd_li¡
Ğ
qqş›Á
* 
qq
, 
ušt
 
pos
 );

207 
´Ù_group_dowÆßd_li¡_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 );

208 
´Ù_group_dowÆßd_Ïb–s
Ğ
qqş›Á
* 
qq
, 
ušt
 
pos
 );

209 
´Ù_group_dowÆßd_Ïb–s_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 );

211 
´Ù_qun_g‘_šfo
Ğ
qqş›Á
* 
qq
, 
ušt
 
numb”
, ušˆ
pos
 );

212 
´Ù_qun_£nd_msg
Ğ
qqş›Á
* 
qq
, 
ušt
 
numb”
, * 
msg_cÚ‹Á
 );

213 
´Ù_qun_g‘_memb”šfo
Ğ
qqş›Á
* 
qq
, 
ušt
 
numb”
, ušt* 
numb”s
, 
couÁ
 );

214 
´Ù_qun_g‘_Úlše
Ğ
qqş›Á
* 
qq
, 
ušt
 
numb”
 );

215 
´Ù_qun_g‘_memb”Çme
Ğ
qqş›Á
* 
qq
, 
ušt
 
numb”
 );

216 
´Ù_qun_cmd_»¶y
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
 );

218 
po¡_·ck‘
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
, 
key_ty³
 );

219 
´oûss_·ck‘
Ğ
qqş›Á
* 
qq
, 
qq·ck‘
* 
p
, 
by‹bufãr
* 
buf
 );

	@qqclient.c

16 
	~<¡ršg.h
>

17 
	~<¡dlib.h
>

18 
	~<uni¡d.h
>

19 #ifdeà
__WIN32__


20 
	~<wšsock.h
>

21 
	~<wšš‘.h
>

23 
	~<sys/sock‘.h
>

24 
	~<¬·/š‘.h
>

25 
	~<Ãtdb.h
>

28 
	~"md5.h
"

29 
	~"memÜy.h
"

30 
	~"debug.h
"

31 
	~"cÚfig.h
"

32 
	~"qqsock‘.h
"

33 
	~"·ck‘mgr.h
"

34 
	~"´ÙocŞ.h
"

35 
	~"qqş›Á.h
"

36 
	~"qun.h
"

37 
	~"group.h
"

38 
	~"buddy.h
"

39 
	~"ut.h
"

42 
£rv”_™em
 
	gtı_£rv”s
[
MAX_SERVER_ADDR
];

43 
£rv”_™em
 
	gudp_£rv”s
[
MAX_SERVER_ADDR
];

44 
	gtı_£rv”_couÁ
 = 0, 
	gudp_£rv”_couÁ
 = 0;

46 
ušt
 
	gÏ¡_£rv”_
 = 0, 
	gÏ¡_£rv”_pÜt
 = 0;

49 
	$»ad_£rv”_addr
Ğ
£rv”_™em
* 
¤v
, * 
s
, * 
couÁ
 )

51 

[32], 
pÜt
[10], 
»ad_Çme
 = 1, *
p
;

52 
j
 = 0;

53  
p
=
s
; ;…++ ){

54 ifĞ*
p
 == ':' ){

55 

[
j
]=0;

56 
j
=0; 
»ad_Çme
 = 0;

57 }ifĞ*
p
=='|' || *p=='\0' ){

58 
pÜt
[
j
]=0;

59 
j
=0; 
»ad_Çme
 = 1;

60 ifĞ*
couÁ
 < 
MAX_SERVER_ADDR
 ){

61 
	`¡ºıy
Ğ
¤v
[*
couÁ
].

, ip, 31 );

62 
¤v
[*
couÁ
].
pÜt
 = 
	`©oi
(…ort );

64 (*
couÁ
) ++;

66 ifĞ*
p
=='\0' )

69 ifĞ
»ad_Çme
 ){

70 ifĞ
j
<31 ) 

[j++] = *
p
;

72 ifĞ
j
<9 ) 
pÜt
[j++] = *
p
;

76 
	}
}

78 
	$»ad_cÚfig
Ğ
qqş›Á
* 
qq
 )

80 
	`as£¹
Ğ
g_cÚf
 );

81 ifĞ!
tı_£rv”_couÁ
 && !
udp_£rv”_couÁ
 ){

83 * 
tıs
, *
udps
;

84 
tıs
 = 
	`cÚfig_»ad¡r
Ğ
g_cÚf
, "QQTcpServerList");

85 
udps
 = 
	`cÚfig_»ad¡r
Ğ
g_cÚf
, "QQUdpServerList");

86 ifĞ
tıs
 ){

87 
	`»ad_£rv”_addr
Ğ
tı_£rv”s
, 
tıs
, &
tı_£rv”_couÁ
 );

89 ifĞ
udps
 ){

90 
	`»ad_£rv”_addr
Ğ
udp_£rv”s
, 
udps
, &
udp_£rv”_couÁ
 );

93 
qq
->
log_·ck‘
 = 
	`cÚfig_»adšt
Ğ
g_cÚf
, "QQPacketLog");

94 ifĞ
	`cÚfig_»ad¡r
Ğ
g_cÚf
, "QQN‘wÜk"è&& 
	`¡ricmp
( config_readstr( g_conf, "QQNetwork"), "TCP" ) == 0 )

95 
qq
->
ÃtwÜk
 = 
TCP
;

97 
qq
->
ÃtwÜk
 = 
UDP
;

98 ifĞ
	`cÚfig_»ad¡r
Ğ
g_cÚf
, "QQVerifyDir" ) )

99 
	`¡ºıy
Ğ
qq
->
v”ify_dœ
, 
	`cÚfig_»ad¡r
Ğ
g_cÚf
, "QQV”ifyDœ" ), 
PATH_LEN
 );

100 ifĞ
qq
->
v”ify_dœ
 =ğ
NULL
 )

101 
	`¡rıy
Ğ
qq
->
v”ify_dœ
, "./web/verify" );

102 
	`mkdœ_»cursive
Ğ
qq
->
v”ify_dœ
 );

103 
	}
}

105 
	$qqş›Á_ü—‹
Ğ
qqş›Á
* 
qq
, 
ušt
 
num
, * 
·ss
 )

107 
uch¬
 
md5_·ss
[16];

109 
md5_¡©e_t
 
m¡
;

110 
	`md5_š™
Ğ&
m¡
 );

111 
	`md5_­³nd
Ğ&
m¡
, (
md5_by‹_t
*)
·ss
, 
	`¡¾’
(pass) );

112 
	`md5_fšish
Ğ&
m¡
, (
md5_by‹_t
*)
md5_·ss
 );

113  
	`qqş›Á_md5_ü—‹
Ğ
qq
, 
num
, 
md5_·ss
 );

114 
	}
}

117 
	$d–‘e_func
(cÚ¡ *
p
)

119 
	`DEL
Ğ
p
 );

120 
	}
}

122 
	$qqş›Á_md5_ü—‹
Ğ
qqş›Á
* 
qq
, 
ušt
 
num
, 
uch¬
* 
md5_·ss
 )

124 
md5_¡©e_t
 
m¡
;

126 
	`mem£t
Ğ
qq
, 0, Ğ
qqş›Á
 ) );

127 
qq
->
numb”
 = 
num
;

128 
	`memıy
Ğ
qq
->
md5_·ss1
, 
md5_·ss
, 16 );

130 
	`md5_š™
Ğ&
m¡
 );

131 
	`md5_­³nd
Ğ&
m¡
, (
md5_by‹_t
*)
qq
->
md5_·ss1
, 16 );

132 
	`md5_fšish
Ğ&
m¡
, (
md5_by‹_t
*)
qq
->
md5_·ss2
 );

133 
qq
->
mode
 = 
QQ_ONLINE
;

134 
qq
->
´oûss
 = 
P_INIT
;

135 
	`»ad_cÚfig
Ğ
qq
 );

136 
qq
->
v”siÚ
 = 
QQ_VERSION
;

138 
	`li¡_ü—‹
Ğ&
qq
->
buddy_li¡
, 
MAX_BUDDY
 );

139 
	`li¡_ü—‹
Ğ&
qq
->
qun_li¡
, 
MAX_QUN
 );

140 
	`li¡_ü—‹
Ğ&
qq
->
group_li¡
, 
MAX_GROUP
 );

141 
	`loİ_ü—‹
Ğ&
qq
->
ev’t_loİ
, 
MAX_EVENT
, 
d–‘e_func
 );

142 
	`loİ_ü—‹
Ğ&
qq
->
msg_loİ
, 
MAX_EVENT
, 
d–‘e_func
 );

143 
	`±h»ad_mu‹x_š™
Ğ&
qq
->
mu‹x_ev’t
, 
NULL
 );

145 
qq
->
£lf
 = 
	`buddy_g‘
Ğqq, qq->
numb”
, 1 );

146 ifĞ!
qq
->
£lf
 ){

147 
	`DBG
("[%d] F©®ƒ¼Ü: qq->£là=ğNULL", 
qq
->
numb”
);

151 
	}
}

153 
	#INTERVAL
 5

	)

154 * 
	$qqş›Á_k“·live
Ğ* 
d©a
 )

156 
qqş›Á
* 
qq
 = (qqş›Á*è
d©a
;

157 
couÁ”
 = 0;

158 
	`DBG
("keepalive");

159  
qq
->
´oûss
 !ğ
P_INIT
 ){

160 
couÁ”
 ++;

161 ifĞ
couÁ”
 % 
INTERVAL
 == 0 ){

162 ifĞ
qq
->
´oûss
 =ğ
P_LOGGING
 || qq->´oûs =ğ
P_LOGIN
 ){

163 
	`·ck‘mgr_check_·ck‘
Ğ
qq
, 5 );

164 ifĞ
qq
->
´oûss
 =ğ
P_LOGIN
 ){

166 ifĞ
couÁ”
 % ( 1 *60*
INTERVAL
) == 0 ){

167 
	`´Ù_u£r_k“p_®ive
Ğ
qq
 );

170 ifĞ
couÁ”
 % ( 10 *60*
INTERVAL
) == 0 ){

171 
	`´Ù_buddy_upd©e_Úlše
Ğ
qq
, 0 );

172 
	`qun_upd©e_Úlše_®l
Ğ
qq
 );

175 ifĞ
couÁ”
 % ( 30 *60*
INTERVAL
) == 0 ){

176 
	`´Ù_u£r_chªge_¡©us
Ğ
qq
 );

177 
	`´Ù_u£r_g‘_Ëv–
Ğ
qq
 );

185 ifĞ! 
qq
->
logš_fšish
 ){

186 ifĞ
	`loİ_is_em±y
(&
qq
->
·ck‘mgr
.
»ady_loİ
) &&

187 
	`loİ_is_em±y
(&
qq
->
·ck‘mgr
.
£Á_loİ
) ){

188 
qq
->
logš_fšish
 = 1;

191 
qq
->
Úlše_şock
 ++;

195 
	`USLEEP
Ğ1000/
INTERVAL
 );

197 
	`DBG
("end.");

198  
NULL
;

199 
	}
}

202 
	$cÚÃù_£rv”
Ğ
qqş›Á
* 
qq
 )

205 ifĞ
qq
->
sock‘
 )

206 
	`qqsock‘_şo£
Ğ
qq
->
sock‘
 );

207 ifĞ
qq
->
ÃtwÜk
 =ğ
TCP
 ){

208 
qq
->
sock‘
 = 
	`qqsock‘_ü—‹
Ğ
TCP
, 
NULL
, 0 );

210 
qq
->
sock‘
 = 
	`qqsock‘_ü—‹
Ğ
UDP
, 
NULL
, 0 );

212 ifĞ
qq
->
sock‘
 < 0 ){

213 
	`DBG
("ÿn'ˆnÙ c»©sock‘.„‘=%d", 
qq
->
sock‘
 );

216 
š_addr
 
addr
;

217 
addr
.
s_addr
 = 
	`htÚl
Ğ
qq
->
£rv”_
 );

218 
	`DBG
("cÚÃùšgØ%s:%d", 
	`š‘_Áß
Ğ
addr
 ), 
qq
->
£rv”_pÜt
 );

219 ifĞ
	`qqsock‘_cÚÃù2
Ğ
qq
->
sock‘
, qq->
£rv”_
, qq->
£rv”_pÜt
 ) < 0 ){

220 
	`DBG
("ÿn'ˆnÙ cÚÃù s”v” %s", 
	`š‘_Áß
Ğ
addr
 ) );

224 
	}
}

226 
	$qqş›Á_g‘_£rv”
(
qqş›Á
* 
qq
)

228 
i
;

229 
sockaddr_š
 
addr
;

230 ifĞ
Ï¡_£rv”_
 == 0 ){

232 ifĞ
qq
->
ÃtwÜk
 =ğ
TCP
 && 
tı_£rv”_couÁ
>0 ){

233 
i
 = 
	`¿nd
()%
tı_£rv”_couÁ
;

234 
	`Ãddr_£t
Ğ
tı_£rv”s
[
i
].

, &
addr
 );

235 
qq
->
£rv”_
 = 
	`Áohl
Ğ
addr
.
sš_addr
.
s_addr
 );

236 
qq
->
£rv”_pÜt
 = 
tı_£rv”s
[
i
].
pÜt
;

238 ifĞ
udp_£rv”_couÁ
 <1 ){

239 
qq
->
´oûss
 = 
P_ERROR
;

240 
	`DBG
("no server for†ogging.");

242 
i
 = 
	`¿nd
()%
udp_£rv”_couÁ
;

243 
	`Ãddr_£t
Ğ
udp_£rv”s
[
i
].

, &
addr
 );

244 
qq
->
£rv”_
 = 
	`Áohl
Ğ
addr
.
sš_addr
.
s_addr
 );

245 
qq
->
£rv”_pÜt
 = 
udp_£rv”s
[
i
].
pÜt
;

248 
qq
->
£rv”_
 = 
Ï¡_£rv”_
;

249 
qq
->
£rv”_pÜt
 = 
Ï¡_£rv”_pÜt
;

250 
Ï¡_£rv”_
 = 0;

253 
	}
}

255 
	$qqş›Á_logš
Ğ
qqş›Á
* 
qq
 )

257 
	`DBG
("login");

258 
»t
;

259 ifĞ
qq
->
´oûss
 !ğ
P_INIT
 ){

260 
	`DBG
("please†ogout first");

263 
	`qqş›Á_£t_´oûss
Ğ
qq
, 
P_LOGGING
 );

264 
	`¤ªd
Ğ
qq
->
numb”
 + 
	`time
(
NULL
) );

266 
	`·ck‘mgr_¡¬t
Ğ
qq
 );

267 
	`·ck‘mgr_Ãw_£qno
Ğ
qq
 );

268 
	`qqş›Á_g‘_£rv”
Ğ
qq
 );

269 
»t
 = 
	`cÚÃù_£rv”
Ğ
qq
 );

270 ifĞ
»t
 < 0 ){

271 
qq
->
´oûss
 = 
P_ERROR
;

272  
»t
;

277 
	`´Ù_logš_touch
Ğ
qq
 );

282 
»t
 = 
	`±h»ad_ü—‹
Ğ&
qq
->
th»ad_k“·live
, 
NULL
, 
qqş›Á_k“·live
, (*)qq );

284 
	}
}

286 
	$qqş›Á_logout
Ğ
qqş›Á
* 
qq
 )

288 ifĞ
qq
->
´oûss
 =ğ
P_INIT
 )

290 ifĞ
qq
->
´oûss
 =ğ
P_LOGIN
 ){

291 
i
;

292  
i
 = 0; i<4; i++ )

293 
	`´Ù_logš_logout
Ğ
qq
 );

295 
	`DBG
("´oûs ğ%d", 
qq
->
´oûss
 );

297 
qq
->
logš_fšish
 = 0;

298 
	`qqş›Á_£t_´oûss
Ğ
qq
, 
P_INIT
 );

299 
	`qqsock‘_şo£
Ğ
qq
->
h‰p_sock
 );

300 
	`qqsock‘_şo£
Ğ
qq
->
sock‘
 );

301 
	`DBG
("joining keepalive");

302 #ifdeà
__WIN32__


303 
	`±h»ad_još
Ğ
qq
->
th»ad_k“·live
, 
NULL
 );

305 ifĞ
qq
->
th»ad_k“·live
 )

306 
	`±h»ad_još
Ğ
qq
->
th»ad_k“·live
, 
NULL
 );

308 
	`·ck‘mgr_’d
Ğ
qq
 );

309 
	}
}

312 
	$qqş›Á_ş—nup
Ğ
qqş›Á
* 
qq
 )

314 ifĞ
qq
->
´oûss
 !ğ
P_INIT
 )

315 
	`qqş›Á_logout
Ğ
qq
 );

316 
	`±h»ad_mu‹x_lock
Ğ&
qq
->
mu‹x_ev’t
 );

317 
	`qun_memb”_ş—nup
Ğ
qq
 );

318 
	`li¡_ş—nup
Ğ&
qq
->
buddy_li¡
 );

319 
	`li¡_ş—nup
Ğ&
qq
->
qun_li¡
 );

320 
	`li¡_ş—nup
Ğ&
qq
->
group_li¡
 );

321 
	`loİ_ş—nup
Ğ&
qq
->
ev’t_loİ
 );

322 
	`loİ_ş—nup
Ğ&
qq
->
msg_loİ
 );

323 
	`±h»ad_mu‹x_de¡roy
Ğ&
qq
->
mu‹x_ev’t
 );

324 
	}
}

326 
	$qqş›Á_v”ify
Ğ
qqş›Á
* 
qq
, 
ušt
 
code
 )

328 ifĞ
qq
->
logš_fšish
 ){

329 
	`´Ù_u£r_»que¡_tok’
Ğ
qq
, qq->
d©a
.
İ”©šg_numb”
, qq->d©a.
İ”©iÚ
, 1, 
code
 );

331 
	`qqş›Á_£t_´oûss
Ğ
qq
, 
P_LOGGING
 );

332 
	`´Ù_logš_»que¡
Ğ
qq
, &qq->
d©a
.
v”ify_tok’
, 
code
, 0 );

334 
	`DBG
("v”ify code: %x", 
code
 );

336 
	}
}

338 
	$qqş›Á_add
Ğ
qqş›Á
* 
qq
, 
ušt
 
numb”
, * 
»que¡_¡r
 )

340 
qqbuddy
* 
b
 = 
	`buddy_g‘
Ğ
qq
, 
numb”
, 0 );

341 ifĞ
b
 && b->
v”ify_æag
 =ğ
VF_OK
 ) {

342 
	`´Ù_buddy_v”ify_addbuddy
Ğ
qq
, 03, 
numb”
 );

344 
	`¡ºıy
Ğ
qq
->
d©a
.
addbuddy_¡r
, 
»que¡_¡r
, 50 );

345 
	`´Ù_buddy_»que¡_addbuddy
Ğ
qq
, 
numb”
 );

348 
	}
}

350 
	$qqş›Á_d–
Ğ
qqş›Á
* 
qq
, 
ušt
 
numb”
 )

352 
qq
->
d©a
.
İ”©šg_numb”
 = 
numb”
;

353 
	`´Ù_u£r_»que¡_tok’
Ğ
qq
, 
numb”
, 
OP_DELBUDDY
, 6, 0 );

355 
	}
}

357 
	$qqş›Á_wa™
Ğ
qqş›Á
* 
qq
, 
£c
 )

359 
i
;

361 ifĞ
	`±h»ad_mu‹x_Œylock
Ğ&
qq
->
mu‹x_ev’t
 ) != 0 )

363  
i
=0; (
£c
==0 || i<£cè&& 
qq
->
´oûss
!=
P_INIT
; i++ ){

364 ifĞ
	`loİ_is_em±y
(&
qq
->
·ck‘mgr
.
»ady_loİ
è&&†oİ_is_em±y(&qq->·ck‘mgr.
£Á_loİ
) )

366 
	`±h»ad_mu‹x_uÆock
Ğ&
qq
->
mu‹x_ev’t
 );

369 
	`SLEEP
(1);

371 
	`±h»ad_mu‹x_uÆock
Ğ&
qq
->
mu‹x_ev’t
 );

373 
	}
}

375 
	$qqş›Á_chªge_¡©us
Ğ
qqş›Á
* 
qq
, 
uch¬
 
mode
 )

377 
qq
->
mode
 = mode;

378 
	`´Ù_u£r_chªge_¡©us
Ğ
qq
 );

379 
	}
}

385 
	$qqş›Á_g‘_ev’t
Ğ
qqş›Á
* 
qq
, * 
ev’t
, 
size
, 
wa™
 )

387 * 
buf
;

389 ifĞ
	`±h»ad_mu‹x_Œylock
Ğ&
qq
->
mu‹x_ev’t
 ) != 0 )

392 ifĞ
qq
->
´oûss
 =ğ
P_INIT
 ){

393 
	`±h»ad_mu‹x_uÆock
Ğ&
qq
->
mu‹x_ev’t
 );

396 
buf
 =(*è
	`loİ_pİ_äom_h—d
Ğ&
qq
->
ev’t_loİ
 );

397 ifĞ
buf
 ){

398 
Ën
 = 
	`¡¾’
Ğ
buf
 );

399 ifĞ
Ën
 < 
size
 ){

400 
	`¡rıy
Ğ
ev’t
, 
buf
 );

402 
	`DBG
("bufferoo small.");

404 
	`d–‘e_func
Ğ
buf
 );

405 
	`±h»ad_mu‹x_uÆock
Ğ&
qq
->
mu‹x_ev’t
 );

408 ifĞ
qq
->
Úlše_şock
 > 10 ){

409 
buf
 =(*è
	`loİ_pİ_äom_h—d
Ğ&
qq
->
msg_loİ
 );

410 ifĞ
buf
 ){

411 
Ën
 = 
	`¡¾’
Ğ
buf
 );

412 ifĞ
Ën
 < 
size
 ){

413 
	`¡rıy
Ğ
ev’t
, 
buf
 );

415 
	`DBG
("bufferoo small.");

417 
	`d–‘e_func
Ğ
buf
 );

418 
	`±h»ad_mu‹x_uÆock
Ğ&
qq
->
mu‹x_ev’t
 );

422 ifĞ
wa™
<0 || wait> 0 ){

423 ifĞ
wa™
>0) wait--;

424 
	`USLEEP
( 200 );

429 
	`±h»ad_mu‹x_uÆock
Ğ&
qq
->
mu‹x_ev’t
 );

431 
	}
}

433 
	$qqş›Á_put_ev’t
Ğ
qqş›Á
* 
qq
, * 
ev’t
 )

435 * 
buf
;

436 
Ën
 = 
	`¡¾’
Ğ
ev’t
 );

440 
buf_tmp
[
Ën
+1];

441 
	`mem£t
Ğ
buf_tmp
, 0, 
Ën
+1);

442 
buf
 = 
buf_tmp
;

444 ifĞ!
buf
 )  -1;

445 
	`¡rıy
Ğ
buf
, 
ev’t
 );

446 
	`loİ_push_to_
Ğ&
qq
->
ev’t_loİ
, (*)
buf
 );

448 
	}
}

450 
	$qqş›Á_put_mes§ge
Ğ
qqş›Á
* 
qq
, * 
msg
 )

452 * 
buf
;

453 
Ën
 = 
	`¡¾’
Ğ
msg
 );

456 
buf_tmp
[
Ën
+1];

457 
	`mem£t
Ğ
buf_tmp
, 0, 
Ën
+1);

458 
buf
 = 
buf_tmp
;

459 ifĞ!
buf
 )  -1;

461 
	`¡rıy
Ğ
buf
, 
msg
 );

462 
	`loİ_push_to_
Ğ&
qq
->
msg_loİ
, (*)
buf
 );

464 
	}
}

468 
	$qqş›Á_£t_´oûss
Ğ
qqş›Á
 *
qq
, 
´oûss
 )

470 
qq
->
´oûss
 =…rocess;

471 
ev’t
[16];

472 
	`¥rštf
Ğ
ev’t
, "´oûss^$%d", 
´oûss
 );

473 
	`qqş›Á_put_ev’t
Ğ
qq
, 
ev’t
 );

474 
	}
}

	@qqclient.h

1 #iâdeà
_QQCLIENT_H


2 
	#_QQCLIENT_H


	)

4 
	~<±h»ad.h
>

5 
	~<time.h
>

6 
	~"qqdef.h
"

7 
	~"·ck‘mgr.h
"

8 
	~"buddy.h
"

9 
	~"li¡.h
"

10 
	~"loİ.h
"

11 
	~"qqsock‘.h
"

12 
	~"´ÙocŞ.h
"

15 
	eLOGIN_PROCESS
{

16 
	mP_INIT
 = 0,

17 
	mP_LOGGING
,

18 
	mP_VERIFYING
,

19 
	mP_LOGIN
,

20 
	mP_ERROR
,

21 
	mP_DENIED
,

22 
	mP_WRONGPASS
,

23 
	mP_BUSY


27 
	s£rv”_™em
{

28 
	m
[32];

29 
ushÜt
 
	mpÜt
;

30 }
	t£rv”_™em
;

32 
	sqqş›Á
{

33 
ušt
 
	mnumb”
;

34 
ushÜt
 
	mv”siÚ
;

35 
ushÜt
 
	m£qno
;

36 
	msock‘
;

37 
	m·sswÜd
[32];

38 
uch¬
 
	mmd5_·ss1
[16];

39 
uch¬
 
	mmd5_·ss2
[16];

40 
ušt
 
	m£rv”_
;

41 
ushÜt
 
	m£rv”_pÜt
;

42 
ušt
 
	mş›Á_
;

43 
ushÜt
 
	mş›Á_pÜt
;

44 
ušt
 
	mloÿl_
;

45 
ushÜt
 
	mloÿl_pÜt
;

46 
ušt
 
	mÏ¡_logš_
;

47 
ušt
 
	mÏ¡_logš_time
;

48 
ušt
 
	mlogš_time
;

49 
ušt
 
	m£rv”_time
;

50 
	mmode
;

51 
	mhas_ÿm”a
;

52 
	m´oûss
;

53 
	mlog_‹rmš®
;

54 
	mlog_·ck‘
;

55 
±h»ad_t
 
	mth»ad_k“·live
;

56 
qq·ck‘mgr
 
	m·ck‘mgr
;

57 
qqbuddy
* 
	m£lf
;

59 
li¡
 
	mbuddy_li¡
;

60 
li¡
 
	mqun_li¡
;

61 
li¡
 
	mgroup_li¡
;

62 
ušt
 
	mÚlše_şock
;

63 
	mv”ify_dœ
[
PATH_LEN
];

64 
ushÜt
 
	mËv–
;

65 
ushÜt
 
	maùive_days
;

66 
ushÜt
 
	mupg¿de_days
;

67 
loİ
 
	mev’t_loİ
;

68 
loİ
 
	mmsg_loİ
;

69 
±h»ad_mu‹x_t
 
	mmu‹x_ev’t
;

70 
	mÃtwÜk
;

71 
	mlogš_fšish
;

72 
	mauto_acû±
;

73 
	mauto_»¶y
[
AUTO_REPLY_LEN
];

74 
	mh‰p_sock
;

76 
qqd©a_2009
 
	md©a
;

78 }
	tqqş›Á
;

81 
cÚÃù_£rv”
Ğ
qqş›Á
* 
qq
 );

82 
qqş›Á_ü—‹
Ğ
qqş›Á
* 
qq
, 
ušt
 
num
, * 
·ss
 );

83 
qqş›Á_md5_ü—‹
Ğ
qqş›Á
* 
qq
, 
ušt
 
num
, 
uch¬
* 
md5_·ss
 );

84 
qqş›Á_logš
Ğ
qqş›Á
* 
qq
 );

85 
qqş›Á_logout
Ğ
qqş›Á
* 
qq
 );

86 
qqş›Á_ş—nup
Ğ
qqş›Á
* 
qq
 );

87 
qqş›Á_v”ify
Ğ
qqş›Á
* 
qq
, 
ušt
 
code
 );

88 
qqş›Á_wa™
Ğ
qqş›Á
* 
qq
, 
£c
 );

89 
qqş›Á_chªge_¡©us
Ğ
qqş›Á
* 
qq
, 
uch¬
 
mode
 );

90 
qqş›Á_g‘_ev’t
Ğ
qqş›Á
* 
qq
, * 
ev’t
, 
size
, 
wa™
 );

91 
qqş›Á_put_ev’t
Ğ
qqş›Á
* 
qq
, * 
ev’t
 );

92 
qqş›Á_£t_´oûss
Ğ
qqş›Á
 *
qq
, 
´oûss
 );

93 
qqş›Á_put_mes§ge
Ğ
qqş›Á
* 
qq
, * 
msg
 );

94 
qqş›Á_g‘_£rv”
Ğ
qqş›Á
* 
qq
 );

95 
qqş›Á_add
Ğ
qqş›Á
* 
qq
, 
ušt
 
numb”
, * 
»que¡_¡r
 );

96 
qqş›Á_d–
Ğ
qqş›Á
* 
qq
, 
ušt
 
numb”
 );

	@qqcrypt.c

27 
	~<¡dio.h
>

28 
	~<¡ršg.h
>

29 #ifdeà
_WIN32


30 
	~<wšsock.h
>

32 
	~<¬·/š‘.h
>

35 
	~"qqüy±.h
"

36 
	~"debug.h
"

38 
	$¿ndom
()

42 
	}
}

45 
	$’ch”
(*cÚ¡ 
v
, cÚ¡ *cÚ¡ 
k
,

46 *cÚ¡ 
w
)

49 
y
 = 
	`Áohl
(
v
[0]),

50 
z
 = 
	`Áohl
(
v
[1]),

51 
a
 = 
	`Áohl
(
k
[0]),

52 
b
 = 
	`Áohl
(
k
[1]),

53 
c
 = 
	`Áohl
(
k
[2]),

54 
d
 = 
	`Áohl
(
k
[3]),

55 
n
 = 0x10,

56 
sum
 = 0,

57 
d–
 = 0x9E3779B9;

59 
n
-- > 0) {

60 
sum
 +ğ
d–
;

61 
y
 +ğ((
z
 << 4è+ 
a
è^ (z + 
sum
è^ ((z >> 5è+ 
b
);

62 
z
 +ğ((
y
 << 4è+ 
c
è^ (y + 
sum
è^ ((y >> 5è+ 
d
);

65 
w
[0] = 
	`htÚl
(
y
); w[1] = htÚl(
z
);

66 
	}
}

68 
	$dech”
(*cÚ¡ 
v
, cÚ¡ *cÚ¡ 
k
,

69 *cÚ¡ 
w
)

72 
y
 = 
	`Áohl
(
v
[0]),

73 
z
 = 
	`Áohl
(
v
[1]),

74 
a
 = 
	`Áohl
(
k
[0]),

75 
b
 = 
	`Áohl
(
k
[1]),

76 
c
 = 
	`Áohl
(
k
[2]),

77 
d
 = 
	`Áohl
(
k
[3]),

78 
n
 = 0x10,

79 
sum
 = 0xE3779B90,

81 
d–
 = 0x9E3779B9;

84 
n
-- > 0) {

85 
z
 -ğ((
y
 << 4è+ 
c
è^ (y + 
sum
è^ ((y >> 5è+ 
d
);

86 
y
 -ğ((
z
 << 4è+ 
a
è^ (z + 
sum
è^ ((z >> 5è+ 
b
);

87 
sum
 -ğ
d–
;

90 
w
[0] = 
	`htÚl
(
y
); w[1] = htÚl(
z
);

91 
	}
}

93 
	$qq’üy±
Ğ* 
š¡r
, 
š¡¾’
, * 
key
,

94 * 
out¡r
, * 
out¡¾’_±r
)

97 
¶aš
[8],

98 
¶aš_´e_8
[8],

99 * 
üy±ed
,

100 * 
üy±ed_´e_8
,

101 * 
šp
;

103 
pos_š_by‹
 = 1,

104 
is_h—d”
=1,

105 
couÁ
=0,

106 
·ddšg
 = 0;

111 
	#’üy±_ev”y_8_by‹
() \

113 
pos_š_by‹
=0;…os_in_byte<8;…os_in_byte++) {\

114 if(
is_h—d”
è{ 
¶aš
[
pos_š_by‹
] ^ğ
¶aš_´e_8
[pos_in_byte]; }\

115 { 
¶aš
[
pos_š_by‹
] ^ğ
üy±ed_´e_8
[pos_in_byte]; }\

117 
	`’ch”
Ğ(*è
¶aš
,\

118 (*è
key
, \

119 (*è
üy±ed
); \

121 
pos_š_by‹
=0;…os_in_byte<8;…os_in_byte++) {\

122 
üy±ed
[
pos_š_by‹
] ^ğ
¶aš_´e_8
[pos_in_byte]; \

124 
	`memıy
(
¶aš_´e_8
, 
¶aš
, 8); \

126 
üy±ed_´e_8
 = 
üy±ed
; \

127 
üy±ed
 += 8; \

128 
couÁ
 += 8; \

129 
pos_š_by‹
 = 0; \

130 
is_h—d”
 = 0; \

131 }

	)

133 
pos_š_by‹
 = (
š¡¾’
 + 0x0a) % 8;

134 ià(
pos_š_by‹
) {

135 
pos_š_by‹
 = 8 -…os_in_byte;

137 
¶aš
[0] = (
	`¿ndom
(è& 0xf8è| 
pos_š_by‹
;

139 
	`mem£t
(
¶aš
+1, 
	`¿ndom
()&0xff, 
pos_š_by‹
++);

140 
	`mem£t
(
¶aš_´e_8
, 0x00, (plain_pre_8));

142 
üy±ed
 = 
üy±ed_´e_8
 = 
out¡r
;

144 
·ddšg
 = 1;

145 
·ddšg
 <= 2) {

146 if(
pos_š_by‹
 < 8è{ 
¶aš
[pos_š_by‹++] = 
	`¿ndom
(è& 0xff; 
·ddšg
 ++; }

147 if(
pos_š_by‹
 =ğ8){ 
	`’üy±_ev”y_8_by‹
(); }

150 
šp
 = 
š¡r
;

151 
š¡¾’
 > 0) {

152 ià(
pos_š_by‹
 < 8è{ 
¶aš
[pos_š_by‹++] = *(
šp
++); 
š¡¾’
 --; }

153 ià(
pos_š_by‹
 =ğ8){ 
	`’üy±_ev”y_8_by‹
(); }

156 
·ddšg
 = 1;

157 
·ddšg
 <= 7) {

158 ià(
pos_š_by‹
 < 8è{ 
¶aš
[pos_š_by‹++] = 0x00; 
·ddšg
 ++; }

159 ià(
pos_š_by‹
 =ğ8){ 
	`’üy±_ev”y_8_by‹
(); }

162 *
out¡¾’_±r
 = 
couÁ
;

164 
	}
}

166 
	$qqdeüy±
Ğ* 
š¡r
, 
š¡¾’
, * 
key
,

167 * 
out¡r
, * 
out¡¾’_±r
)

170 
deüy±ed
[8], 
m
[8],

171 * 
üy±_buff
,

172 * 
üy±_buff_´e_8
,

173 * 
ou
;

175 
couÁ
,

176 
cÚ‹xt_¡¬t
,

177 
pos_š_by‹
,

178 
·ddšg
;

180 
	#deüy±_ev”y_8_by‹
() {\

181 
bN“dR‘
 = 0;\

182 
pos_š_by‹
 = 0;…os_in_byte < 8;…os_in_byte ++ ) {\

183 ià(
cÚ‹xt_¡¬t
 + 
pos_š_by‹
 >ğ
š¡¾’
) \

185 
bN“dR‘
 = 1;\

188 
deüy±ed
[
pos_š_by‹
] ^ğ
üy±_buff
[pos_in_byte];\

190 ifĞ!
bN“dR‘
 ) { \

191 
	`dech”
Ğ(*è
deüy±ed
, \

192 (*è
key
, \

193 (*è
deüy±ed
);\

195 
cÚ‹xt_¡¬t
 += 8;\

196 
üy±_buff
 += 8;\

197 
pos_š_by‹
 = 0;\

199 }

	)

202 ià((
š¡¾’
 % 8) || (instrlen < 16))  0;

204 
	`dech”
Ğ(*è
š¡r
,

205 (*è
key
,

206 (*è
deüy±ed
);

207 
pos_š_by‹
 = 
deüy±ed
[0] & 0x7;

208 
couÁ
 = 
š¡¾’
 - 
pos_š_by‹
 - 10;

210 ià(*
out¡¾’_±r
 < 
couÁ
 || count < 0)  0;

212 
	`mem£t
(
m
, 0, 8);

213 
üy±_buff_´e_8
 = 
m
;

214 *
out¡¾’_±r
 = 
couÁ
;

216 
üy±_buff
 = 
š¡r
 + 8;

217 
cÚ‹xt_¡¬t
 = 8;

218 
pos_š_by‹
 ++;

220 
·ddšg
 = 1;

221 
·ddšg
 <= 2) {

222 ià(
pos_š_by‹
 < 8) {

223 
pos_š_by‹
 ++; 
·ddšg
 ++;

225 ià(
pos_š_by‹
 == 8) {

226 
üy±_buff_´e_8
 = 
š¡r
;

228 
	`deüy±_ev”y_8_by‹
();

232 
ou
 = 
out¡r
;

233 
couÁ
 !=0) {

234 ià(
pos_š_by‹
 < 8) {

235 *
ou
 = 
üy±_buff_´e_8
[
pos_š_by‹
] ^ 
deüy±ed
[pos_in_byte];

236 
ou
 ++;

237 
couÁ
 --;

238 
pos_š_by‹
 ++;

240 ià(
pos_š_by‹
 == 8) {

241 
üy±_buff_´e_8
 = 
üy±_buff
 - 8;

243 
	`deüy±_ev”y_8_by‹
();

246 
·ddšg
 = 1;…adding < 8;…adding ++) {

247 ià(
pos_š_by‹
 < 8) {

248 ià(
üy±_buff_´e_8
[
pos_š_by‹
] ^ 
deüy±ed
[pos_in_byte]) {

251 
pos_š_by‹
 ++;

253 ià(
pos_š_by‹
 == 8 ) {

254 
üy±_buff_´e_8
 = 
üy±_buff
;

256 
	`deüy±_ev”y_8_by‹
();

261 
	}
}

	@qqcrypt.h

27 #iâdeà
_CRYPT_H


28 
	#_CRYPT_H


	)

30 
qqdeüy±
Ğ* 
š¡r
, 
š¡¾’
, * 
key
,

31 * 
out¡r
, * 
out¡¾’_±r
);

32 
qq’üy±
Ğ* 
š¡r
, 
š¡¾’
, * 
key
,

33 * 
out¡r
, * 
out¡¾’_±r
);

	@qqdef.h

1 #iâdeà
_QQDEF_H


2 
	#_QQDEF_H


	)

4 
	~<time.h
>

5 
	~<uni¡d.h
>

6 
	~"ut.h
"

7 
	tušt
;

8 
	tushÜt
;

9 
	tuch¬
;

12 
	#MIN
(
a
,
b
)×>b?b:¨)

	)

13 
	#KB
(
a
èa*1024

	)

14 
	#MB
(
a
èa*
	`KB
(1024)

	)

15 
	#CN_TIME
(
a
è
	)
a

18 #ifdeà
__WIN32__


19 
	#SLEEP
(
a
è
	`m¦“p
×*1000);

	)

20 
	#USLEEP
(
a
è
	`m¦“p
×);

	)

22 
	#SLEEP
(
a
è
	`¦“p
×);

	)

23 
	#USLEEP
(
a
è
	`u¦“p
×*1000);

	)

24 
	#¡ricmp
 
¡rÿ£cmp


	)

33 
	#MAX_LOOP_PACKET
 32

	)

34 
	#MAX_COMMAND
 0x0200

	)

35 
	#MAX_BUDDY
 1200

36 
	#MAX_QUN
 128

37 
	#MAX_QUN_MEMBER
 800

38 
	#MAX_GROUP
 128

39 
	#MAX_EVENT
 128

40 
	#USER_INFO_LEN
 256

	)

41 
	#MAX_USER_INFO
 38

	)

42 
	#SIGNITURE_LEN
 256

43 
	#TOKEN_LEN
 256

44 
	#ACCOUNT_LEN
 64

45 
	#NICKNAME_LEN
 64

46 
	#GROUPNAME_LEN
 256

	)

47 
	#AUTO_REPLY_LEN
 256

	)

48 
	#ALIAS_LEN
 32

49 
	#PATH_LEN
 1024

	)

51 
	#MAX_SERVER_ADDR
 16

	)

53 
	stok’
{

54 
	mËn
;

55 
uch¬
 
	md©a
[
TOKEN_LEN
];

56 }
	ttok’
;

60 
	#QQ_VERSION
 0x1525

61 

	)

62 
	eQQSTATUS
{

63 
	mQQ_NONE
 = 0x00,

64 
	mQQ_ONLINE
 = 0x0a,

65 
	mQQ_OFFLINE
 = 0x14,

66 
	mQQ_AWAY
 = 0x1e,

67 
	mQQ_BUSY
 = 0x32,

68 
	mQQ_KILLME
 = 0x3C,

69 
	mQQ_QUIET
 = 0x46,

70 
	mQQ_HIDDEN
 = 0x28

73 
	eMESSAGE_TYPE
{

74 
	mMT_BUDDY
,

75 
	mMT_QUN
,

76 
	mMT_SYSTEM
,

77 
	mMT_NEWS
,

78 
	mMT_QUN_MEMBER


81 
	#MSG_CONTENT_LEN
 
	`KB
(4)

	)

82 
	sqqmes§ge
{

83 
ushÜt
 
	mmsg_id
;

84 
uch¬
 
	mmsg_ty³
;

85 
ushÜt
 
	mmsg_£q
;

86 
	mmsg_cÚ‹Á
[
MSG_CONTENT_LEN
];

87 
ušt
 
	mmsg_time
;

88 
ušt
 
	mqun_numb”
;

89 
ušt
 
	mäom
;

90 
	mauto_»¶y
;

91 
	m¦iû_couÁ
;

92 
	m¦iû_no
;

93 
ushÜt
 
	mim_ty³
;

94 }
	tqqmes§ge
;

96 
	gqqş›Á
;

97 
buddy_msg_ÿÎback
 ( 
qqş›Á
* 
qq
, 
ušt
 
uid
, 
time_t
 
t
, * 
msg
 );

98 
qun_msg_ÿÎback
 ( 
qqş›Á
* 
qq
, 
ušt
 
uid
, ušˆ
št_uid
,

99 
time_t
 
t
, * 
msg
 );

	@qqpacket.c

15 
	~<¡ršg.h
>

16 
	~<¡dlib.h
>

17 #ifdeà
__WIN32__


18 
	~<wšsock.h
>

19 
	~<wšš‘.h
>

21 
	~<sys/sock‘.h
>

22 
	~<¬·/š‘.h
>

23 
	~<Ãtdb.h
>

25 
	~"qqdef.h
"

26 
	~"memÜy.h
"

27 
	~"debug.h
"

28 
	~"·ck‘mgr.h
"

29 
	~"qqş›Á.h
"

30 
	~"qq·ck‘.h
"

32 
	$put_by‹
Ğ
by‹bufãr
* 
p
, 
uch¬
 
b
 )

34 ifĞ
p
->
pos
<p->
size
 ){

35 
p
->
d©a
[p->
pos
++] = 
b
;

37 
	`DBG
("·ck‘…->pos(%dè>ğp->size(%d)", 
p
->
pos
,…->
size
 );

39 
	}
}

41 
	$put_wÜd
Ğ
by‹bufãr
* 
p
, 
ushÜt
 
b
 )

43 ifĞ
p
->
pos
+1<p->
size
 ){

44 *(
ushÜt
*)(&
p
->
d©a
[p->
pos
]èğ
	`htÚs
(
b
);…->pos+=2;

46 
	`DBG
("·ck‘…->pos(%d)+1 >ğp->size(%d)", 
p
->
pos
,…->
size
 );

48 
	}
}

50 
	$put_št
Ğ
by‹bufãr
* 
p
, 
ušt
 
b
 )

52 ifĞ
p
->
pos
+3<p->
size
 ){

53 *(
ušt
*)(&
p
->
d©a
[p->
pos
]èğ
	`htÚl
(
b
);…->pos+=4;

55 
	`DBG
("·ck‘…->pos(%d)+3 >ğp->size(%d)", 
p
->
pos
,…->
size
 );

57 
	}
}

59 
	$put_d©a
Ğ
by‹bufãr
* 
p
, 
uch¬
* 
d©a
, 
Ën
 )

61 ifĞ
p
->
pos
+
Ën
<õ->
size
 ){

62 
	`memıy
Ğ&
p
->
d©a
[p->
pos
], d©a, 
Ën
 );

63 
p
->
pos
 +ğ
Ën
;

65 
	`DBG
("·ck‘…->pos(%d)+%d >…->size(%d)", 
p
->
pos
, 
Ën
,…->
size
 );

67 
	}
}

69 
	$put_¡ršg
Ğ
by‹bufãr
* 
p
, * 
¡r
 )

71 
	`put_d©a
Ğ
p
, (
uch¬
*)
¡r
, 
	`¡¾’
( str ) );

72 
	}
}

74 
uch¬
 
	$g‘_by‹
Ğ
by‹bufãr
* 
p
 )

76 
uch¬
 
b
 = 0;

77 ifĞ
p
->
pos
<p->
Ën
 ){

78 
b
 = 
p
->
d©a
[p->
pos
++];

80 
	`DBG
("·ck‘…->pos(%dè>ğp->Ën(%d)", 
p
->
pos
,…->
Ën
 );

82  
b
;

83 
	}
}

85 
ushÜt
 
	$g‘_wÜd
Ğ
by‹bufãr
* 
p
 )

87 
ushÜt
 
b
 = 0;

88 ifĞ
p
->
pos
+1<p->
Ën
 ){

89 
b
 = *(
ushÜt
*)(&
p
->
d©a
[p->
pos
]);…->pos+=2;

91 
	`DBG
("·ck‘…->pos(%d)+1 >ğp->Ën(%d)", 
p
->
pos
,…->
Ën
 );

93  
	`Áohs
(
b
);

94 
	}
}

96 
ušt
 
	$g‘_št
Ğ
by‹bufãr
* 
p
 )

98 
ušt
 
b
 = 0;

99 ifĞ
p
->
pos
+3<p->
Ën
 ){

100 
b
 = *(
ušt
*)(&
p
->
d©a
[p->
pos
]);…->pos+=4;\

102 
	`DBG
("·ck‘…->pos(%d)+3 >ğp->Ën(%d)", 
p
->
pos
,…->
Ën
 );

104  
	`Áohl
(
b
);

105 
	}
}

107 
	$g‘_¡ršg
Ğ
by‹bufãr
* 
p
, * 
¡r
, 
Ën
 )

109 
j
 = 0;

110  
p
->
pos
<p->
Ën
 && 
j
+1<len ){

111 
¡r
[
j
++] = 
p
->
d©a
[p->
pos
++];

112 ifĞ
¡r
[
j
-1] == '\0' )

113  
j
;

115 
¡r
[
j
] = 0;

116  
j
;

117 
	}
}

119 
	$g‘_d©a
Ğ
by‹bufãr
* 
p
, 
uch¬
* 
d©a
, 
Ën
 )

121 ifĞ
p
->
pos
+
Ën
<=p->len ){

122 
	`memıy
Ğ
d©a
, &
p
->d©a[p->
pos
], 
Ën
 );

123 
p
->
pos
 +ğ
Ën
;

125 
	`DBG
("·ck‘…->pos(%d)+%d >…->Ën(%d)", 
p
->
pos
, 
Ën
,…->len );

126 
Ën
 = 0;

128  
Ën
;

129 
	}
}

131 
	$g‘_tok’
Ğ
by‹bufãr
* 
p
, 
tok’
* 
tok
 )

133 
ushÜt
 
Ën
 = 
	`g‘_wÜd
Ğ
p
 );

134 
	`g‘_d©a
Ğ
p
, (
uch¬
*)
tok
->
d©a
, 
Ën
 );

135 
tok
->
Ën
 =†en;

136  
Ën
;

137 
	}
}

140 
	$g‘_tok’2
Ğ
by‹bufãr
* 
p
, 
tok’
* 
tok
 )

142 
uch¬
 
Ën
 = 
	`g‘_by‹
Ğ
p
 );

143 
	`g‘_d©a
Ğ
p
, (
uch¬
*)
tok
->
d©a
, 
Ën
 );

144 
tok
->
Ën
 =†en;

145  
Ën
;

146 
	}
}

	@qqpacket.h

1 #iâdeà
_PACKET_H


2 
	#_PACKET_H


	)

4 
	~"qqdef.h
"

6 
	#PACKET_SIZE
 
	`KB
(4)

	)

8 
	sby‹bufãr
{

9 
	mpos
;

10 
	mËn
;

11 
	msize
;

12 
uch¬
 
	md©a
[
PACKET_SIZE
];

13 }
	tby‹bufãr
;

15 
	sqq·ck‘
{

18 
	mh—d
;

19 
	m
;

20 
ushÜt
 
	mv”siÚ
;

21 
ushÜt
 
	mcommªd
;

22 
ushÜt
 
	m£qno
;

23 
by‹bufãr
* 
	mbuf
;

24 
time_t
 
	mtime_ü—‹
;

25 
time_t
 
	mtime_®ive
;

26 
qq·ck‘
* 
	mm©ch
;

27 
	m£nd_times
;

28 
	mkey_ty³
;

29 
uch¬
 
	mkey
[16];

30 
	mÃed_ack
;

31 }
	tqq·ck‘
;

33 
put_by‹
Ğ
by‹bufãr
* 
p
, 
uch¬
 
b
 );

34 
put_wÜd
Ğ
by‹bufãr
* 
p
, 
ushÜt
 
b
 );

35 
put_št
Ğ
by‹bufãr
* 
p
, 
ušt
 
b
 );

36 
put_d©a
Ğ
by‹bufãr
* 
p
, 
uch¬
* 
d©a
, 
Ën
 );

37 
put_¡ršg
Ğ
by‹bufãr
* 
p
, * 
¡r
 );

39 
uch¬
 
g‘_by‹
Ğ
by‹bufãr
* 
p
 );

40 
ushÜt
 
g‘_wÜd
Ğ
by‹bufãr
* 
p
 );

41 
ušt
 
g‘_št
Ğ
by‹bufãr
* 
p
 );

42 
g‘_¡ršg
Ğ
by‹bufãr
* 
p
, * 
¡r
, 
Ën
 );

43 
g‘_d©a
Ğ
by‹bufãr
* 
p
, 
uch¬
* 
d©a
, 
Ën
 );

44 
	gtok’
;

45 
g‘_tok’
Ğ
by‹bufãr
* 
p
, 
tok’
* 
d©a
 );

46 
g‘_tok’2
Ğ
by‹bufãr
* 
p
, 
tok’
* 
tok
 );

	@qqsocket.c

17 
	~<¡dio.h
>

18 
	~<uni¡d.h
>

20 #ifdeà
__WIN32__


21 
	~<wšsock.h
>

22 
	~<wšš‘.h
>

24 
	~<sys/sock‘.h
>

25 
	~<¬·/š‘.h
>

26 
	~<Ãtdb.h
>

29 
	~<fú.h
>

30 
	~<¡ršg.h
>

31 
	~<¡dlib.h
>

32 
	~"qqdef.h
"

33 
	~"debug.h
"

34 
	~"qqsock‘.h
"

36 #ifdeà
__WIN32__


37 
WSADATA
 
	gw§_d©a
;

40 
	$qqsock‘_š™
()

42 #ifdeà
__WIN32__


43 
»t
 = 
	`WSAS¹up
(
	`MAKEWORD
(2,1), &
w§_d©a
);

44 ifĞ
»t
 != 0 )

46 
	`DBG
("failed in WSAStartup");

48 
	`DBG
("WSA Startup.");

50 
	}
}

51 
	$qqsock‘_’d
()

53 #ifdeà
__WIN32__


54 
	`WSACËªup
();

56 
	}
}

59 
	$qqsock‘_ü—‹
Ğ
ty³
, * 

, 
ushÜt
 
pÜt
 )

61 
fd
 = 0;

62 
sockaddr_š
 
addr
;

63  
ty³
 )

65 
TCP
:

66 
fd
 = 
	`sock‘
Ğ
PF_INET
, 
SOCK_STREAM
, 0 );

67 
	`mem£t
Ğ&
addr
, 0, (
sockaddr_š
) );

68 
addr
.
sš_çmy
 = 
PF_INET
;

69 ifĞ

 )

70 
	`Ãddr_£t
Ğ

, &
addr
 );

72 
addr
.
sš_addr
.
s_addr
 = 
INADDR_ANY
;

73 
addr
.
sš_pÜt
 = 
	`htÚs
Ğ
pÜt
 );

74 ifĞ
	`bšd
Ğ
fd
, (
sockaddr
*)&
addr
, (
sockaddr_š
) ) < 0 )

76 
	`DBG
("bind socketƒrror!");

77 
	`şo£
Ğ
fd
 );

81 
UDP
:

82 
fd
 = 
	`sock‘
Ğ
PF_INET
, 
SOCK_DGRAM
, 
IPPROTO_IP
 );

83 
	`mem£t
Ğ&
addr
, 0, (
sockaddr
) );

84 
addr
.
sš_çmy
 = 
PF_INET
;

85 ifĞ

 )

86 
	`Ãddr_£t
Ğ

, &
addr
 );

88 
addr
.
sš_addr
.
s_addr
 = 
INADDR_ANY
;

89 
addr
.
sš_pÜt
 = 
	`htÚs
Ğ
pÜt
 );

90 ifĞ
	`bšd
Ğ
fd
, (
sockaddr
*)&
addr
, (
sockaddr_š
) ) < 0 )

92 
	`DBG
("bind socketƒrror!");

93 
	`şo£
Ğ
fd
 );

98  
fd
;

99 
	}
}

102 
	$qqsock‘_şo£
Ğ
fd
 )

104 #ifdeà
__WIN32__


105 
	`şo£sock‘
Ğ
fd
 );

107 
	`şo£
Ğ
fd
 );

109 
	}
}

112 
	$qqsock‘_cÚÃù
Ğ
fd
, * 

, 
ushÜt
 
pÜt
 )

114 
sockaddr_š
 
addr
;

115 
	`mem£t
Ğ&
addr
, 0, (
sockaddr_š
) );

116 
addr
.
sš_çmy
 = 
PF_INET
;

117 
	`Ãddr_£t
Ğ

, &
addr
 );

118 
addr
.
sš_pÜt
 = 
	`htÚs
Ğ
pÜt
 );

119 ifĞ
	`cÚÃù
Ğ
fd
, (
sockaddr
*)&
addr
, (
sockaddr_š
)) < 0 )

121 
	`DBG
("qqsocket connect failed.");

125 
	}
}

128 
	$qqsock‘_cÚÃù2
Ğ
fd
, 
ušt
 

, 
ushÜt
 
pÜt
 )

130 
sockaddr_š
 
addr
;

131 
	`mem£t
Ğ&
addr
, 0, (
sockaddr_š
) );

132 
addr
.
sš_çmy
 = 
PF_INET
;

133 
addr
.
sš_addr
.
s_addr
 = 
	`htÚl
Ğ

 );

134 
addr
.
sš_pÜt
 = 
	`htÚs
Ğ
pÜt
 );

135 ifĞ
	`cÚÃù
Ğ
fd
, (
sockaddr
*)&
addr
, (
sockaddr_š
)) < 0 )

137 
	`DBG
("qqsocket connect failed.");

141 
	}
}

143 
	$Ãddr_£t
Ğ* 
Çme
, 
sockaddr_š
* 
addr
 )

145 ifĞ(
addr
->
sš_addr
.
s_addr
 = 
	`š‘_addr
Ğ
Çme
 ) ) == -1 )

149 
ho¡’t
 *
ho¡
;

150 
ho¡
 = 
	`g‘ho¡byÇme
Ğ
Çme
 );

151 ifĞ
ho¡
 )

153 
addr
->
sš_addr
.
s_addr
 = *(
size_t
*è
ho¡
->
h_addr_li¡
[0];

154 
	`DBG
("G‘ IP: %s", 
	`š‘_Áß
Ğ
addr
->
sš_addr
 ) );

156 
	`DBG
("FaedØg‘ i°by %s", 
Çme
 );

159 
	}
}

161 
	$qqsock‘_£nd
Ğ
fd
, 
uch¬
* 
buf
, 
size_t
 
size
 )

163 
»t
;

164 
size_t
 
»¡
;

165 
»¡
 = 
size
;

166  
»¡
 > 0 )

168 
»t
 = 
	`£nd
Ğ
fd
, (*)
buf
, 
»¡
, 0);

169 if(
»t
 <= 0 )

171  
»t
;

173 
»¡
 -ğ
»t
;

174 
buf
 +ğ
»t
;

176  
size
;

177 
	}
}

179 
	$qqsock‘_»cv
Ğ
fd
, 
uch¬
* 
buf
, 
size_t
 
size
 )

181 
»t
;

182 
»t
 = 
	`»cv
Ğ
fd
, (*)
buf
, 
size
, 0 );

183  
»t
;

184 
	}
}

	@qqsocket.h

1 #iâdeà
_QQSOCKET_H


2 
	#_QQSOCKET_H


	)

5 
	~"qqdef.h
"

7 
	#TCP
 0

	)

8 
	#UDP
 1

	)

10 
	gsockaddr_š
;

12 
qqsock‘_ü—‹
Ğ
ty³
, * 

, 
ushÜt
 
pÜt
 );

13 
qqsock‘_cÚÃù
Ğ
fd
, * 

, 
ushÜt
 
pÜt
 );

14 
qqsock‘_cÚÃù2
Ğ
fd
, 
ušt
 

, 
ushÜt
 
pÜt
 );

15 
qqsock‘_£nd
Ğ
fd
, 
uch¬
* 
buf
, 
size_t
 
size
 );

16 
qqsock‘_»cv
Ğ
fd
, 
uch¬
* 
buf
, 
size_t
 
size
 );

17 
qqsock‘_şo£
Ğ
fd
 );

18 
Ãddr_£t
Ğ* 
Çme
, 
sockaddr_š
* 
addr
 );

19 
qqsock‘_š™
();

20 
qqsock‘_’d
();

	@qun.c

15 
	~<time.h
>

16 
	~<¡dlib.h
>

17 
	~<¡ršg.h
>

18 
	~"qqş›Á.h
"

19 
	~"memÜy.h
"

20 
	~"debug.h
"

21 
	~"´ÙocŞ.h
"

22 
	~"li¡.h
"

23 
	~"buddy.h
"

24 
	~"qun.h
"

26 
	$qun_£¬ch”
ĞcÚ¡ * 
p
, cÚ¡ * 
v
 )

28  ( ((
qqqun
*)
p
)->
numb”
 =ğ()
v
 );

29 
	}
}

31 
	$memb”_£¬ch”
ĞcÚ¡ * 
p
, cÚ¡ * 
v
 )

33  ( ((
qunmemb”
*)
p
)->
numb”
 =ğ()
v
 );

34 
	}
}

37 
qunmemb”
* 
	$qun_memb”_g‘
Ğ
qqş›Á
* 
qq
, 
qqqun
* 
q
, 
ušt
 
numb”
, 
ü—‹
 )

39 ifĞ!
numb”
 )

40  
NULL
;

41 
qunmemb”
* 
m
;

42 
m
 = (
qunmemb”
 *)
	`li¡_£¬ch
Ğ&
q
->
memb”_li¡
, (*)
numb”
, 
memb”_£¬ch”
 );

44 ifĞ!
m
 && 
ü—‹
 ){

45 
	`NEW
Ğ
m
, Ğ
qunmemb”
 ) ,qunmember);

46 ifĞ!
m
 ){

47 
	`DBG
("Fatalƒrror: qunmember‚ot‡llocated");

48  
m
;

50 
m
->
numb”
 =‚umber;

51 
	`¥rštf
Ğ
m
->
nickÇme
, "%u", 
numb”
 );

52 ifĞ
	`li¡_­³nd
Ğ&
q
->
memb”_li¡
, (*)
m
 )<0 ){

53 
	`DEL
Ğ
m
 );

54 
	`DBG
("can't‡dd ito member_list");

57  
m
;

58 
	}
}

60 
	$qun_memb”_»move
Ğ
qqş›Á
* 
qq
, 
qqqun
* 
q
, 
ušt
 
numb”
 )

62 
qunmemb”
* 
m
;

63 
m
 = (
qunmemb”
 *)
	`li¡_£¬ch
Ğ&
q
->
memb”_li¡
, (*)
numb”
, 
memb”_£¬ch”
 );

64 ifĞ
m
 ){

65 
	`li¡_»move
Ğ&
q
->
memb”_li¡
, 
m
 );

67 
	}
}

69 
qqqun
* 
	$qun_g‘
Ğ
qqş›Á
* 
qq
, 
ušt
 
numb”
, 
ü—‹
 )

71 ifĞ!
numb”
 )

72  
NULL
;

73 
qqqun
* 
q
;

74 
q
 = (
qqqun
 *)
	`li¡_£¬ch
Ğ&
qq
->
qun_li¡
, (*)
numb”
, 
qun_£¬ch”
 );

76 ifĞ!
q
 && 
ü—‹
 ){

77 
	`NEW
Ğ
q
, Ğ
qqqun
 ) ,qqqun);

78 ifĞ!
q
 ){

79 
	`DBG
("Fatalƒrror: qqqun‚ot‡llocated");

80  
q
;

82 
q
->
numb”
 =‚umber;

83 
	`¥rštf
Ğ
q
->
Çme
, "%u", 
numb”
 );

84 ifĞ
	`li¡_­³nd
Ğ&
qq
->
qun_li¡
, (*)
q
 )<0 ){

85 
	`DEL
Ğ
q
 );

87 ifĞ
q
 ){

88 
	`li¡_ü—‹
Ğ&
q
->
memb”_li¡
, 
MAX_QUN_MEMBER
 );

89 
qunmemb”
* 
m
 = 
	`qun_memb”_g‘
Ğ
qq
, 
q
, qq->
numb”
, 1 );

90 ifĞ
m
 ){

91 
	`¡rıy
Ğ
m
->
nickÇme
, 
qq
->
£lf
->nickname );

92 
m
->
¡©us
 = 
qq
->
£lf
->status;

96  
q
;

97 
	}
}

99 
	$qun_ext_£¬ch”
ĞcÚ¡ * 
p
, cÚ¡ * 
v
 )

101  ( ((
qqqun
*)
p
)->
ext_numb”
 =ğ()
v
 );

102 
	}
}

103 
qqqun
* 
	$qun_g‘_by_ext
Ğ
qqş›Á
* 
qq
, 
ušt
 
ext_numb”
 )

105  (
qqqun
 *è
	`li¡_£¬ch
Ğ&
qq
->
qun_li¡
, (*)
ext_numb”
, 
qun_ext_£¬ch”
 );

106 
	}
}

108 
	$qun_»move
Ğ
qqş›Á
* 
qq
, 
ušt
 
numb”
 )

110 
qqqun
* 
q
;

111 
q
 = (
qqqun
 *)
	`li¡_£¬ch
Ğ&
qq
->
qun_li¡
, (*)
numb”
, 
qun_£¬ch”
 );

112 ifĞ
q
 ){

113 
	`li¡_ş—nup
Ğ&
q
->
memb”_li¡
 );

114 
	`li¡_»move
Ğ&
qq
->
qun_li¡
, 
q
 );

116 
	}
}

119 
	$qun_kl_memb”s
ĞcÚ¡ * 
p
, cÚ¡ * 
v
 )

121 
	`li¡_ş—nup
Ğ&((
qqqun
*)
p
)->
memb”_li¡
 );

123 
	}
}

124 
	$qun_memb”_ş—nup
Ğ
qqş›Á
* 
qq
 )

126 
	`li¡_£¬ch
Ğ&
qq
->
qun_li¡
, 
NULL
, 
qun_kl_memb”s
 );

127 
	}
}

129 
	$qun_upd©e_šfo
Ğ
qqş›Á
* 
qq
, 
qqqun
* 
q
 )

131 
	`´Ù_qun_g‘_šfo
Ğ
qq
, 
q
->
numb”
, 0 );

132 
	}
}

134 
	$g‘_®l_memb”s
ĞcÚ¡ * 
p
, cÚ¡ * 
v
 )

136 
ušt
** 
k
 = (ušt**)
v
;

137 (**
k
èğ((
qunmemb”
*)
p
)->
numb”
;

138 (*
k
)++;

140 
	}
}

141 
	$qun_upd©e_memb”šfo
Ğ
qqş›Á
* 
qq
, 
qqqun
* 
q
 )

143 
ušt
* 
numb”s
, *
v
;

144 
	`NEW
Ğ
numb”s
, 
MAX_QUN_MEMBER
*(
ušt
) ,uint);

145 ifĞ!
numb”s
 ) ;

146 
v
 = 
numb”s
;

147 
	`li¡_£¬ch
Ğ&
q
->
memb”_li¡
, (*)&
v
, 
g‘_®l_memb”s
 );

148 
couÁ
 = ((
ušt
)
v
 - (ušt)
numb”s
) / (uint);

149 
£nd
;

150 
v
 = 
numb”s
;

151  
couÁ
 > 0 ){

152 
£nd
 = 30;

153 ifĞ
couÁ
 < 
£nd
 ) send = count;

154 
	`´Ù_qun_g‘_memb”šfo
Ğ
qq
, 
q
->
numb”
, 
v
, 
£nd
 );

155 
v
 +ğ
£nd
;

156 
couÁ
 -ğ
£nd
;

158 
	`DEL
Ğ
numb”s
 );

159 
	}
}

161 
	$qun_upd©e_Úlše
Ğ
qqş›Á
* 
qq
, 
qqqun
* 
q
 )

163 
	`´Ù_qun_g‘_Úlše
Ğ
qq
, 
q
->
numb”
 );

164 
	}
}

166 
	$memb”off_£¬ch”
ĞcÚ¡ * 
p
, cÚ¡ * 
v
 )

168 ((
qunmemb”
*)
p
)->
¡©us
 = 
QQ_OFFLINE
;

170 
	}
}

171 
	$qun_£t_memb”s_off
Ğ
qqş›Á
* 
qq
, 
qqqun
* 
q
 )

173 
	`li¡_£¬ch
Ğ&
q
->
memb”_li¡
, 
NULL
, 
memb”off_£¬ch”
 );

174 
	}
}

177 
	$qun_£nd_mes§ge
Ğ
qqş›Á
* 
qq
, 
ušt
 
numb”
, * 
msg
 )

179 
	`´Ù_qun_£nd_msg
Ğ
qq
, 
numb”
, 
msg
 );

181 
	}
}

183 
	$qun_put_sšgË_ev’t
Ğ
qqş›Á
* 
qq
, 
qqqun
* 
q
 )

185 *
‹mp
;

186 
i
;

187 
	`NEW
Ğ
‹mp
, 
	`KB
(128) ,);

188 ifĞ!
‹mp
 )

190 
qunmemb”
* 
m
;

191 
	`¥rštf
Ğ
‹mp
, "şu¡”šfo^$%u^$%s^$%s^$%s^$", 
q
->
ext_numb”
, q->
Çme
, q->
ªn
, q->
šŒo
 );

192 
	`±h»ad_mu‹x_lock
Ğ&
q
->
memb”_li¡
.
mu‹x
 );

193  
i
=0; i<
q
->
memb”_li¡
.
couÁ
; i++ ){

194 
m
 = (
qunmemb”
*)
q
->
memb”_li¡
.
™ems
[
i
];

195 
	`¥rštf
Ğ
‹mp
, "%s%u\t%s\t%s\t%d^@",emp, 
m
->
numb”
, m->
nickÇme
, 
	`buddy_¡©us_¡ršg
Ğm->
¡©us
 ),

196 
m
->
rŞe
 );

198 
	`±h»ad_mu‹x_uÆock
Ğ&
q
->
memb”_li¡
.
mu‹x
 );

199 
	`qqş›Á_put_ev’t
Ğ
qq
, 
‹mp
 );

200 
	`DEL
Ğ
‹mp
 );

201 
	}
}

203 
	$qun_put_ev’t
Ğ
qqş›Á
* 
qq
 )

205 
i
;

206 
qqqun
* 
q
;

207 
	`±h»ad_mu‹x_lock
Ğ&
qq
->
qun_li¡
.
mu‹x
 );

208  
i
=0; i<
qq
->
qun_li¡
.
couÁ
; i++ ){

209 
q
 = (
qqqun
*)
qq
->
qun_li¡
.
™ems
[
i
];

210 
	`qun_put_sšgË_ev’t
Ğ
qq
, 
q
 );

212 
	`±h»ad_mu‹x_uÆock
Ğ&
qq
->
qun_li¡
.
mu‹x
 );

213 
	}
}

217 
	$qun_upd©e_£¬ch”
ĞcÚ¡ * 
p
, cÚ¡ * 
v
 )

219 
	`qun_upd©e_šfo
Ğ(
qqş›Á
*)
v
, (
qqqun
*)
p
 );

221 
	}
}

222 
	$qun_upd©e_®l
Ğ
qqş›Á
* 
qq
 )

224 
	`li¡_£¬ch
Ğ&
qq
->
qun_li¡
, (*)qq, 
qun_upd©e_£¬ch”
 );

225 
	}
}

227 
	$qun_upd©e_Úlše_£¬ch”
ĞcÚ¡ * 
p
, cÚ¡ * 
v
 )

229 
	`qun_upd©e_Úlše
Ğ(
qqş›Á
*)
v
, (
qqqun
*)
p
 );

231 
	}
}

232 
	$qun_upd©e_Úlše_®l
Ğ
qqş›Á
* 
qq
 )

234 
	`li¡_£¬ch
Ğ&
qq
->
qun_li¡
, (*)qq, 
qun_upd©e_Úlše_£¬ch”
 );

235 
	}
}

	@qun.h

1 #iâdeà
_QUN_H


2 
	#_QUN_H


	)

4 
	~"qqdef.h
"

6 
	squnmemb”
{

7 
ušt
 
	mnumb”
;

8 
	mnickÇme
[
NICKNAME_LEN
];

9 
ushÜt
 
	mçû
;

10 
uch¬
 
	mage
;

11 
uch¬
 
	m£x
;

12 
uch¬
 
	mqqshow
;

13 
uch¬
 
	mæag
;

14 
uch¬
 
	m¡©us
;

15 
uch¬
 
	maccouÁ_æag
;

16 
	maccouÁ
[
ACCOUNT_LEN
];

17 
uch¬
 
	mrŞe
, 
	mÜg
;

18 }
	tqunmemb”
;

20 
	sqqqun
{

21 
ušt
 
	mnumb”
;

22 
ušt
 
	mext_numb”
;

23 
	mÇme
[
NICKNAME_LEN
];

24 
	mªn
[256];

25 
	mšŒo
[256];

26 
ušt
 
	mÿ‹gÜy
;

27 
ušt
 
	mowÃr
;

28 
ushÜt
 
	mmax_memb”
;

29 
uch¬
 
	mauth_ty³
;

30 
uch¬
 
	mty³
;

31 
ušt
 
	mÜd”
;

32 
tok’
 
	mtok’_cmd
;

33 
li¡
 
	mmemb”_li¡
;

34 }
	tqqqun
;

36 
	gqqş›Á
;

37 
qqqun
* 
qun_g‘
Ğ
qqş›Á
* 
qq
, 
ušt
 
numb”
, 
ü—‹
 );

38 
qqqun
* 
qun_g‘_by_ext
Ğ
qqş›Á
* 
qq
, 
ušt
 
ext_numb”
 );

39 
qun_»move
Ğ
qqş›Á
* 
qq
, 
ušt
 
numb”
 );

40 
qunmemb”
* 
qun_memb”_g‘
Ğ
qqş›Á
* 
qq
, 
qqqun
* 
q
, 
ušt
 
numb”
, 
ü—‹
 );

41 
qun_memb”_»move
Ğ
qqş›Á
* 
qq
, 
qqqun
* 
q
, 
ušt
 
numb”
 );

42 
qun_upd©e_memb”šfo
Ğ
qqş›Á
* 
qq
, 
qqqun
* 
q
 );

43 
qun_upd©e_šfo
Ğ
qqş›Á
* 
qq
, 
qqqun
* 
q
 );

44 
qun_upd©e_Úlše
Ğ
qqş›Á
* 
qq
, 
qqqun
* 
q
 );

45 
qun_upd©e_®l
Ğ
qqş›Á
* 
qq
 );

46 
qun_£t_memb”s_off
Ğ
qqş›Á
* 
qq
, 
qqqun
* 
q
 );

47 
qun_memb”_ş—nup
Ğ
qqş›Á
* 
qq
 );

48 
qun_£nd_mes§ge
Ğ
qqş›Á
* 
qq
, 
ušt
 
numb”
, * 
msg
 );

49 
qun_put_sšgË_ev’t
Ğ
qqş›Á
* 
qq
, 
qqqun
* 
q
 );

50 
qun_put_ev’t
Ğ
qqş›Á
* 
qq
 );

51 
qun_upd©e_Úlše_®l
Ğ
qqş›Á
* 
qq
 );

	@utf8.c

15 #ifdeà
__WIN32__


16 
	~<wšdows.h
>

18 
	~<icÚv.h
>

21 
	~<¡dio.h
>

22 
	~<¡ršg.h
>

23 
	~<¡dlib.h
>

25 
	~"debug.h
"

26 
	~"memÜy.h
"

27 
	~"cÚfig.h
"

28 
	~"utf8.h
"

32 #ifdeà
__WIN32__


33 
	$utf8_to_gb
 ( * 
¤c
, * 
d¡
, 
Ën
 )

35 
»t
 = 0;

36 
WCHAR
* 
¡rA
;

37 
i
ğ
	`MuÉiBy‹ToWideCh¬
 ( 
CP_UTF8
, 0 , 
¤c
, -1, 
NULL
, 0 );

38 ifĞ
i
<=0 ){

39 
	`DBG
("ERROR."); ;

41 
¡rA
 = 
	`m®loc
Ğ
i
*2 );

42 
	`MuÉiBy‹ToWideCh¬
 ( 
CP_UTF8
 , 0 , 
¤c
, -1, 
¡rA
 , 
i
);

43 
i
ğ
	`WideCh¬ToMuÉiBy‹
(
CP_ACP
,0,
¡rA
,-1,
NULL
,0,NULL,NULL);

44 ifĞ
Ën
 >ğ
i
 ){

45 
»t
 = 
	`WideCh¬ToMuÉiBy‹
 (
CP_ACP
,0,
¡rA
,-1,
d¡
,
i
,
NULL
,NULL);

46 
d¡
[
i
] = 0;

48 ifĞ
»t
<=0 ){

49 
	`ä“
Ğ
¡rA
 ); ;

51 
	`ä“
Ğ
¡rA
 );

52 
	}
}

53 
	$gb_to_utf8
 ( * 
¤c
, * 
d¡
, 
Ën
 )

55 
»t
 = 0;

56 
WCHAR
* 
¡rA
;

57 
i
ğ
	`MuÉiBy‹ToWideCh¬
 ( 
CP_ACP
, 0 , 
¤c
, -1, 
NULL
, 0 );

58 ifĞ
i
<=0 ){

59 
	`DBG
("ERROR."); ;

61 
¡rA
 = 
	`m®loc
Ğ
i
*2 );

62 
	`MuÉiBy‹ToWideCh¬
 ( 
CP_ACP
 , 0 , 
¤c
, -1, 
¡rA
 , 
i
);

63 
i
ğ
	`WideCh¬ToMuÉiBy‹
(
CP_UTF8
,0,
¡rA
,-1,
NULL
,0,NULL,NULL);

64 ifĞ
Ën
 >ğ
i
 ){

65 
»t
 = 
	`WideCh¬ToMuÉiBy‹
 (
CP_UTF8
,0,
¡rA
,-1,
d¡
,
i
,
NULL
,NULL);

66 
d¡
[
i
] = 0;

68 ifĞ
»t
<=0 ){

69 
	`ä“
Ğ
¡rA
 ); ;

71 
	`ä“
Ğ
¡rA
 );

72 
	}
}

74 
	$utf8_to_gb
Ğ* 
¤c
, * 
d¡
, 
Ën
 )

76 
»t
 = 0;

77 
ušt
 
šËn
 = 
	`¡¾’
Ğ
¤c
 );

78 
ušt
 
ou’
 = 
Ën
;

79 * 
šbuf
 = 
¤c
;

80 * 
outbuf
 = 
d¡
;

81 
icÚv_t
 
cd
;

82 
cd
 = 
	`icÚv_İ’
( "GBK", "UTF-8" );

83 iàĞ
cd
 !ğ(
icÚv_t
)-1 ){

84 
»t
 = 
	`icÚv
Ğ
cd
, &
šbuf
, &
šËn
, &
outbuf
, &
ou’
 );

85 ifĞ
»t
 != 0 )

86 
	`´štf
("icÚv faedƒ¼: %s\n", 
	`¡»¼Ü
(
”ºo
) );

87 
	`icÚv_şo£
Ğ
cd
 );

89 
	}
}

90 
	$gb_to_utf8
Ğ* 
¤c
, * 
d¡
, 
Ën
 )

92 
»t
 = 0;

93 
ušt
 
šËn
 = 
	`¡¾’
Ğ
¤c
 );

94 
ušt
 
ou’
 = 
Ën
;

95 * 
šbuf
 = 
¤c
;

96 * 
outbuf
 = 
d¡
;

97 
icÚv_t
 
cd
;

98 
cd
 = 
	`icÚv_İ’
( "UTF-8", "GBK" );

99 iàĞ
cd
 !ğ(
icÚv_t
)-1 ){

100 
»t
 = 
	`icÚv
Ğ
cd
, &
šbuf
, &
šËn
, &
outbuf
, &
ou’
 );

101 ifĞ
»t
 != 0 )

102 
	`´štf
("icÚv faedƒ¼: %s\n", 
	`¡»¼Ü
(
”ºo
) );

103 
	`icÚv_şo£
Ğ
cd
 );

105 
	}
}

	@utf8.h

1 #iâdeà
_UTF8_H


2 
	#_UTF8_H


	)

4 
utf8_to_gb
 ( * 
¤c
, * 
d¡
, 
Ën
 );

5 
gb_to_utf8
Ğ* 
¤c
, * 
d¡
, 
Ën
 );

6 
decode_uri
Ğ* 
šput
 );

7 
if_UTF8
(*
¡r
);

	@util.c

13 #ifdeà
__WIN32__


14 
	~<io.h
>

15 
	~<wšdows.h
>

17 
	~<sys/¡©.h
>

19 
	~<¡dio.h
>

20 
	~<¡d¬g.h
>

21 
	~<¡ršg.h
>

22 
	~<¡dlib.h
>

23 
	~<time.h
>

24 
	~"qqsock‘.h
"

25 
	~"debug.h
"

26 
	~"qqdef.h
"

27 
	~"ut.h
"

28 
	~"memÜy.h
"

30 
	$mkdœ_»cursive
Ğ* 
·th
 )

32 *
p
;

33 ifĞ
	`acûss
Ğ
·th
, 0 ) == 0 )

35  
p
=
·th
; *p;…++ ){

36 ifĞ
p
>
·th
 && *p == '/' ){

37 *
p
 = 0;

38 ifĞ
	`acûss
Ğ
·th
, 0 ) != 0 ){

39 #ifdeà
__WIN32__


40 
	`mkdœ
Ğ
·th
 );

42 ifĞ
	`mkdœ
Ğ
·th
, 
S_IRWXU
 ) != 0 )

46 *
p
 = '/';

49 #ifdeà
__WIN32__


50  
	`mkdœ
Ğ
·th
 );

52  
	`mkdœ
Ğ
·th
, 
S_IRWXU
 );

54 
	}
}

56 
	$Œªs_çûs
Ğ* 
¤c
, * 
d¡
, 
ou’
 )

58 * 
p
, *
q
;

59 
p
 = 
¤c
; 
q
 = 
d¡
;

60  *
p
 ){

61 ifĞ*(
p
++) == 0x14 ){

62 ifĞ()(
q
-
d¡
è< 
ou’
 - 10 )

63 
q
 +ğ
	`¥rštf
Ğq, "[çû:%u]", *(
p
++) );

65 ifĞ()(
q
-
d¡
è< 
ou’
 )

66 *(
q
++èğ*(
p
-1);

69 *
q
 = 0;

70  ()(
q
-
d¡
);

71 
	}
}

75 * 
	$mid_v®ue
Ğ* 
¡r
, * 
Ëá
, * 
right
, * 
out
, 
ou’
 )

77 * 
beg
, * 
’d
, 
t
;

78 
beg
 = 
	`¡r¡r
Ğ
¡r
, 
Ëá
 );

79 ifĞ
beg
 ){

80 
beg
 +ğ
	`¡¾’
(
Ëá
);

81 ifĞ
right
 ){

82 
’d
 = 
	`¡r¡r
Ğ
beg
, 
right
 );

84 
’d
 = 
beg
 + 
	`¡¾’
(beg);

86 ifĞ
’d
 ){

87 
t
 = *
’d
; *end = 0;

88 
	`¡ºıy
Ğ
out
, 
beg
, 
ou’
 );

89 *
’d
 = 
t
;

90  
’d
;

93 *
out
 = '\0';

94  
¡r
;

95 
	}
}

101 
	$h‰p_»que¡
Ğ* 
h‰p_sock
, * 
u¾
, * 
£ssiÚ
, * 
d©a
, * 
d©®’
 )

103 
ho¡_Çme
[32], 
uri
[101], *
h—d”
, *
Ãxt
, 
tmp
[16];

104 
Ën
, 
d©a_Ën
;

106 
Ãxt
 = 
	`mid_v®ue
Ğ
u¾
, "//", "/", 
ho¡_Çme
, 31 );

107 
Ãxt
 = 
	`mid_v®ue
ĞÃxt, "/", 
NULL
, 
uri
, 100 );

109 *
h‰p_sock
 = 
	`qqsock‘_ü—‹
Ğ
TCP
, 
NULL
, 0 );

110 ifĞ*
h‰p_sock
 <= 0 )  -3;

111 
	`qqsock‘_cÚÃù
Ğ*
h‰p_sock
, 
ho¡_Çme
, 80 );

112 
	`NEW
Ğ
h—d”
, 
	`KB
(4) ,);

113 
	`¥rštf
Ğ
h—d”
, "GET % HTTP/1.1\r\n\r\n", 
uri
 );

114 
	`qqsock‘_£nd
Ğ*
h‰p_sock
, (
uch¬
*)
h—d”
, 
	`¡¾’
(header) );

115 
Ën
 = 
	`qqsock‘_»cv
Ğ*
h‰p_sock
, (
uch¬
*)
h—d”
, 
	`KB
(4) );

117 ifĞ
Ën
>0 ){

118 
Ãxt
 = 
	`mid_v®ue
Ğ
h—d”
, "CÚ‹Á-L’gth: ", "\r\n", 
tmp
, 15 );

119 
d©a_Ën
 = 
	`©oi
Ğ
tmp
 );

120 
Ãxt
 = 
	`mid_v®ue
Ğ
h—d”
, "g‘qq£ssiÚ:", "\r\n", 
£ssiÚ
, 127 );

121  
Ën
 < 
d©a_Ën
 ){

122 
»t
 = 
	`qqsock‘_»cv
Ğ*
h‰p_sock
, (
uch¬
*)(
h—d”
 + 
Ën
), 
	`KB
(4)-len );

123 ifĞ
»t
 > 0 ) 
Ën
 +=„et; ;

125 
Ãxt
 = 
	`¡r¡r
Ğ
h—d”
, "\r\n\r\n" ) + 4;

126 ifĞ
Ãxt
 ){

127 ifĞ*
d©®’
 > 
d©a_Ën
 ){

128 
	`memıy
Ğ(*)
d©a
, (*)
Ãxt
, 
d©a_Ën
 );

129 *
d©®’
 = 
d©a_Ën
;

131 
	`DBG
("datalen isoo small.");

135 
	`DEL
Ğ
h—d”
 );

136 
	`qqsock‘_şo£
Ğ*
h‰p_sock
 );

138 
	}
}

140 #ifdeà
__WIN32__


141 
	$m¦“p
Ğ
ms
 )

143 
	`SË•
Ğ
ms
 );

144 
	}
}

	@util.h

1 #iâdeà
_UTIL_H


2 
	#_UTIL_H


	)

4 
mkdœ_»cursive
Ğ* 
·th
 );

5 
Œªs_çûs
Ğ* 
¤c
, * 
d¡
, 
ou’
 );

6 
h‰p_»que¡
Ğ* 
h‰p_sock
, * 
u¾
, * 
£ssiÚ
, * 
d©a
, * 
d©®’
 );

7 * 
mid_v®ue
Ğ* 
¡r
, * 
Ëá
, * 
right
, * 
out
, 
ou’
 );

8 
m¦“p
Ğ
ms
 );

	@webqq.c

14 
	#WEBQQLIB


	)

16 
	~<¡dio.h
>

17 
	~<¡ršg.h
>

18 
	~<¡dlib.h
>

19 
	~<uni¡d.h
>

20 
	~<±h»ad.h
>

21 #ifdeà
__WIN32__


22 
	~<wšsock.h
>

23 
	~<wšš‘.h
>

25 
	~<sys/sock‘.h
>

26 
	~<¬·/š‘.h
>

29 
	~"debug.h
"

30 
	~"memÜy.h
"

31 
	~"qqş›Á.h
"

32 
	~"webqq.h
"

33 
	~"loİ.h
"

34 
	~"buddy.h
"

35 
	~"qun.h
"

36 
	~"group.h
"

37 
	~"cÚfig.h
"

38 
	~"qqsock‘.h
"

40 
	#TIMEOUT
 120

	)

41 
	#MAX_USERS
 1000

	)

43 
loİ
 
	gu£r_loİ
;

45 
±h»ad_t
 
	gth»ad_gu¬d”
;

46 
	gwebqq_ruÂšg
 = 0;

48 
	$d–‘e_func
(cÚ¡ *
p
)

50 
u£r
* 
u
 = (u£r*)
p
;

51 
	`qqş›Á_logout
Ğ
u
->
qq
 );

52 
	`qqş›Á_ş—nup
Ğ
u
->
qq
 );

53 
	`SLEEP
(1);

54 
	`DEL
Ğ
u
->
qq
 );

55 
	`DEL
Ğ
u
 );

56 
	}
}

58 
	$gu¬d”_£¬ch”
ĞcÚ¡ * 
p
, cÚ¡ * 
v
 )

60 
u£r
* 
u
 = (u£r*)
p
;

61 
time_t
 
tim’ow
 = (time_t)
v
;

62 ifĞ
tim’ow
-
u
->
upd©e_time
 > 
TIMEOUT
 && u->
»ã»nû
 == 0 ){

66 
	}
}

67 * 
	$webqq_gu¬d”
Ğ* 
d©a
 )

69 
couÁ”
 = 0;

70 
	`DBG
("webqq_guarder");

71  
webqq_ruÂšg
 ){

72 
time_t
 
tim’ow
 = 
	`time
(
NULL
);

73 
couÁ”
 ++;

74 
u£r
* 
u
;

76 
u
 = 
	`loİ_£¬ch
Ğ&
u£r_loİ
, (*)
tim’ow
, 
gu¬d”_£¬ch”
 );

77 ifĞ
u
 ){

78 
	`DBG
("removing qq: %uime1: %u -ime2: %u > 120",

79 ((
qqş›Á
*)
u
->
qq
)->
numb”
, 
tim’ow
, u->
upd©e_time
 );

80 
	`loİ_»move
Ğ&
u£r_loİ
, (*)
u
 );

81 
	`d–‘e_func
Ğ(*)
u
 );

83 } 
u
 );

84 
	`SLEEP
( 1 );

86 
	`DBG
("end.");

87  
NULL
;

88 
	}
}

91 
EXPORT
 
	$webqq_š™
()

93 
»t
;

94 
webqq_ruÂšg
 = 1;

95 
	`cÚfig_š™
();

97 
	`loİ_ü—‹
Ğ&
u£r_loİ
, 
MAX_USERS
, 
d–‘e_func
 );

98 
»t
 = 
	`±h»ad_ü—‹
Ğ&
th»ad_gu¬d”
, 
NULL
, 
webqq_gu¬d”
, (*)0 );

99 
	}
}

101 
EXPORT
 
	$webqq_’d
()

103 
	`DBG
("webqq_ending");

104 
webqq_ruÂšg
 = 0;

105 
	`±h»ad_još
Ğ
th»ad_gu¬d”
, 
NULL
 );

106 
	`loİ_ş—nup
Ğ&
u£r_loİ
 );

107 
	`cÚfig_’d
();

109 
	`DBG
("webqq_ended");

110 
	}
}

114 
	$g‘_u£r_£¬ch”
ĞcÚ¡ * 
p
, cÚ¡ * 
v
 )

116  ((
u£r
*)
p
)->
£ssiÚ_±r
 =ğ
v
;

117 
	}
}

118 
EXPORT
 
u£r
* 
	$webqq_g‘_u£r
Ğ* 
£ssiÚ_±r
 )

120 
u£r
* 
u
 = (u£r*)
	`loİ_£¬ch
Ğ&
u£r_loİ
, 
£ssiÚ_±r
, 
g‘_u£r_£¬ch”
 );

121 ifĞ
u
 ){

122 
u
->
»ã»nû
 ++;

123 
u
->
upd©e_time
 = 
	`time
(
NULL
);

126  
u
;

127 
	}
}

129 
EXPORT
 
u£r
* 
	$webqq_ü—‹_u£r
Ğ* 
£ssiÚ_±r
, 
ušt
 
numb”
, 
uch¬
* 
md5·ss
 )

131 
u£r
* 
u
;

132 
qqş›Á
* 
qq
;

133 
u
 = 
	`loİ_£¬ch
Ğ&
u£r_loİ
, 
£ssiÚ_±r
, 
g‘_u£r_£¬ch”
 );

134 ifĞ
u
 )

135  
u
;

136 
	`NEW
Ğ
qq
, (
qqş›Á
) );

137 
	`NEW
Ğ
u
, (
u£r
) );

138 ifĞ!
u
 || !
qq
 ){

139 
	`DEL
Ğ
qq
 ); DELĞ
u
 );

140  
NULL
;

142 
u
->
£ssiÚ_±r
 = session_ptr;

143 
u
->
ü—‹_time
 = u->
upd©e_time
 = 
	`time
(
NULL
);

144 
u
->
qq
 = qq;

145 
u
->
»ã»nû
 = 1;

146 
	`qqş›Á_md5_ü—‹
Ğ
qq
, 
numb”
, 
md5·ss
 );

147 
qq
->
auto_acû±
 = 1;

148 
	`loİ_push_to_
Ğ&
u£r_loİ
, 
u
 );

149  
u
;

150 
	}
}

153 
EXPORT
 
	$webqq_d”eãr
Ğ
u£r
* 
u
 )

155 
u
->
»ã»nû
 --;

156 
	}
}

158 
EXPORT
 
	$webqq_logš
Ğ
u£r
* 
u
 )

160  
	`qqş›Á_logš
Ğ
u
->
qq
 );

161 
	}
}

163 
EXPORT
 
	$webqq_logout
Ğ
u£r
* 
u
 )

165 
	`DBG
("logouˆ%u", ((
qqş›Á
*)
u
->
qq
)->
numb”
 );

166 
	`qqş›Á_logout
Ğ
u
->
qq
 );

168 
	}
}

170 
EXPORT
 
	$webqq_»cv_msg
Ğ
u£r
* 
u
, * 
buf
, 
size
, 
wa™
 )

172 
»t
;

173 
»t
 = 
	`qqş›Á_g‘_ev’t
Ğ
u
->
qq
, 
buf
, 
size
, 
wa™
 );

174  
»t
;

175 
	}
}

177 
EXPORT
 
	$webqq_£nd_msg
Ğ
u£r
* 
u
, 
ušt
 
to
, * 
buf
, 
qun_msg
 )

179 ifĞ
qun_msg
 ){

180 
qqqun
* 
q
 = 
	`qun_g‘_by_ext
Ğ
u
->
qq
, 
to
 );

181 ifĞ
q
 )

182  
	`qun_£nd_mes§ge
Ğ
u
->
qq
, 
q
->
numb”
, 
buf
 );

184  
	`buddy_£nd_mes§ge
Ğ
u
->
qq
, 
to
, 
buf
 );

187 
	}
}

189 
EXPORT
 
	$webqq_upd©e_li¡
Ğ
u£r
* 
u
 )

191 
	`buddy_upd©e_li¡
Ğ
u
->
qq
 );

192 
	`group_upd©e_li¡
Ğ
u
->
qq
 );

193 
	}
}

195 
EXPORT
 
	$webqq_v”ify
Ğ
u£r
* 
u
, 
ušt
 
code
 )

197 
	`qqş›Á_v”ify
Ğ
u
->
qq
, 
code
 );

198 
	}
}

201 
EXPORT
 
	$webqq_»move
Ğ
u£r
* 
u
 )

203 
	`loİ_»move
Ğ&
u£r_loİ
, 
u
 );

204 
	`d–‘e_func
Ğ(*è
u
 );

205 
	}
}

207 
EXPORT
 
	$webqq_¡©us
Ğ
u£r
* 
u
, 
¡
 )

209 
	`qqş›Á_chªge_¡©us
Ğ
u
->
qq
, 
¡
 );

210 
	}
}

213 
	$buddy_msg_ÿÎback
 ( 
qqş›Á
* 
qq
, 
ušt
 
uid
, 
time_t
 
t
, * 
msg
 )

215 
time¡r
[24];

216 
tm
 * 
timešfo
, * 
tmnow
;

217 * 
¡r
;

218 
Ën
, 
d1
, 
d2
;

219 
time_t
 
t_now
;

220 
t_now
 = 
	`time
(
NULL
);

221 
tmnow
 = 
	`loÿÉime
Ğ&
t_now
 );

222 
d1
 = 
tmnow
->
tm_mday
;

223 
timešfo
 = 
	`loÿÉime
 ( &
t
 );

224 
d2
 = 
timešfo
->
tm_mday
;

225 ifĞ
d1
 !ğ
d2
 ){

226 
	`¡ráime
Ğ
time¡r
, 24, "%Y-%m-%d %H:%M:%S", 
timešfo
 );

228 
	`¡ráime
Ğ
time¡r
, 24, "%H:%M:%S", 
timešfo
 );

230 
Ën
 = 
	`¡¾’
Ğ
msg
 );

231 
	`NEW
Ğ
¡r
, 
Ën
+64 );

232 ifĞ
uid
 == 10000 ){

233 
	`¥rštf
Ğ
¡r
, "brßdÿ¡^$Sy¡em^$%s", 
msg
 );

235 
	`¥rštf
Ğ
¡r
, "buddymsg^$%u^$%s^$%s", 
uid
, 
time¡r
, 
msg
 );

237 
	`qqş›Á_put_mes§ge
Ğ
qq
, 
¡r
 );

238 
	}
}

240 
	$qun_msg_ÿÎback
 ( 
qqş›Á
* 
qq
, 
ušt
 
uid
, ušˆ
št_uid
,

241 
time_t
 
t
, * 
msg
 )

243 
qqqun
* 
q
;

244 
time¡r
[24];

245 
tm
 * 
timešfo
, * 
tmnow
;

246 * 
¡r
;

247 
Ën
, 
d1
, 
d2
;

248 
time_t
 
t_now
;

249 
t_now
 = 
	`time
(
NULL
);

250 
tmnow
 = 
	`loÿÉime
Ğ&
t_now
 );

251 
d1
 = 
tmnow
->
tm_mday
;

252 
timešfo
 = 
	`loÿÉime
 ( &
t
 );

253 
d2
 = 
timešfo
->
tm_mday
;

254 ifĞ
d1
 !ğ
d2
 ){

255 
	`¡ráime
Ğ
time¡r
, 24, "%Y-%m-%d %H:%M:%S", 
timešfo
 );

257 
	`¡ráime
Ğ
time¡r
, 24, "%H:%M:%S", 
timešfo
 );

259 
q
 = 
	`qun_g‘
Ğ
qq
, 
št_uid
, 1 );

260 ifĞ!
q
 ){

261 
	`DBG
("error: q=NULL");

264 
Ën
 = 
	`¡¾’
Ğ
msg
 );

265 
	`NEW
Ğ
¡r
, 
Ën
+64 );

266 
	`¥rštf
Ğ
¡r
, "şu¡”msg^$%u^$%u^$%s^$%s", 
q
->
ext_numb”
, 
uid
, 
time¡r
, 
msg
 );

267 
	`qqş›Á_put_mes§ge
Ğ
qq
, 
¡r
 );

268 
	}
}

270 
EXPORT
 
ušt
 
	$webqq_g‘_numb”
Ğ
u£r
* 
u
 )

272 
qqş›Á
* 
qq
 = (qqş›Á*)
u
->qq;

273 
ev’t
[16];

274 
	`qqş›Á_£t_´oûss
Ğ
qq
, qq->
´oûss
 );

275 
	`¥rštf
Ğ
ev’t
, "¡©us^$%d", 
qq
->
mode
 );

276 
	`qqş›Á_put_ev’t
Ğ
qq
, 
ev’t
 );

277 
	`buddy_put_ev’t
Ğ
qq
 );

278 
	`group_put_ev’t
Ğ
qq
 );

279 
	`qun_put_ev’t
Ğ
qq
 );

280 
	`qqş›Á_£t_´oûss
Ğ
qq
, qq->
´oûss
 );

281  
qq
->
numb”
;

282 
	}
}

	@webqq.h

1 #iâdeà
_WEBQQ_H


2 
	#_WEBQQ_H


	)

4 
	~<time.h
>

6 
	su£r
{

7 
time_t
 
	mupd©e_time
;

8 
time_t
 
	mü—‹_time
;

9 * 
	mqq
;

10 * 
	m£ssiÚ_±r
;

11 
	m»ã»nû
;

12 }
	tu£r
;

15 #ifdeà
__WIN32__


17 
	#STDCALL
 
__¡dÿÎ


	)

18 #ifdeà
WEBQQLIB


19 
	#EXPORT
 
	`__deş¥ec
(
dÎexpÜt
è
STDCALL


	)

21 
	#EXPORT
 
	`__deş¥ec
(
dÎimpÜt
è
STDCALL


	)

25 
	#EXPORT


	)

29 
EXPORT
 
webqq_š™
();

30 
EXPORT
 
webqq_’d
();

31 
EXPORT
 
u£r
* 
webqq_g‘_u£r
Ğ* 
£ssiÚ_±r
 );

32 
EXPORT
 
u£r
* 
webqq_ü—‹_u£r
Ğ* 
£ssiÚ_±r
, 
ušt
 
numb”
, 
uch¬
* 
md5·ss
 );

33 
EXPORT
 
webqq_d”eãr
Ğ
u£r
* 
u
 );

34 
EXPORT
 
webqq_logš
Ğ
u£r
* 
u
 );

35 
EXPORT
 
webqq_logout
Ğ
u£r
* 
u
 );

36 
EXPORT
 
webqq_»cv_msg
Ğ
u£r
* 
u
, * 
buf
, 
size
, 
wa™
 );

37 
EXPORT
 
webqq_£nd_msg
Ğ
u£r
* 
u
, 
ušt
 
to
, * 
buf
, 
qun_msg
 );

38 
EXPORT
 
webqq_upd©e_li¡
Ğ
u£r
* 
u
 );

39 
EXPORT
 
webqq_v”ify
Ğ
u£r
* 
u
, 
ušt
 
code
 );

40 
EXPORT
 
webqq_»move
Ğ
u£r
* 
u
 );

41 
EXPORT
 
webqq_¡©us
Ğ
u£r
* 
u
, 
¡
 );

	@
1
.
0
52
473
buddy.c
buddy.h
config.c
config.h
crc32.c
crc32.h
debug.c
debug.h
gMystar.cc
gMystar.h
gmyqq.cc
gmyqq.h
group.c
group.h
list.c
list.h
loop.c
loop.h
main.cc
md5.c
md5.h
memory.c
memory.h
myqq.h
packetmgr.c
packetmgr.h
prot_buddy.c
prot_group.c
prot_im.c
prot_login.c
prot_misc.c
prot_qun.c
prot_user.c
protocol.c
protocol.h
qqclient.c
qqclient.h
qqcrypt.c
qqcrypt.h
qqdef.h
qqpacket.c
qqpacket.h
qqsocket.c
qqsocket.h
qun.c
qun.h
utf8.c
utf8.h
util.c
util.h
webqq.c
webqq.h
